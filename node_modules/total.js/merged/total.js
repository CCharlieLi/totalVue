// Copyright 2012-2015 (c) Peter Å irka <petersirka@gmail.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function Framework(){this.id=null,this.version=1900,this.version_header="1.9.0";var e=process.version.toString().replace("v","").replace(/\./g,"");e=parseFloat("0"===e[1]?"0."+e.substring(1):e),this.versionNode=e,this.config={debug:!1,name:"total.js",version:"1.01",author:"",secret:os.hostname()+"-"+os.platform()+"-"+os.arch(),"etag-version":"","directory-controllers":"/controllers/","directory-views":"/views/","directory-definitions":"/definitions/","directory-temp":"/tmp/","directory-models":"/models/","directory-resources":"/resources/","directory-public":"/public/","directory-public-virtual":"/app/","directory-modules":"/modules/","directory-source":"/source/","directory-logs":"/logs/","directory-tests":"/tests/","directory-databases":"/databases/","directory-workers":"/workers/","directory-packages":"/packages/","directory-private":"/private/","directory-isomorphic":"/isomorphic/","directory-configs":"/configs/","directory-services":"/services/","static-url":"","static-url-script":"/js/","static-url-style":"/css/","static-url-image":"/img/","static-url-video":"/video/","static-url-font":"/fonts/","static-url-download":"/download/","static-accepts":{".jpg":!0,".png":!0,".gif":!0,".ico":!0,".js":!0,".css":!0,".txt":!0,".xml":!0,".woff":!0,".woff2":!0,".otf":!0,".ttf":!0,".eot":!0,".svg":!0,".zip":!0,".rar":!0,".pdf":!0,".docx":!0,".xlsx":!0,".doc":!0,".xls":!0,".html":!0,".htm":!0,".appcache":!0,".manifest":!0,".map":!0,".ogg":!0,".mp4":!0,".mp3":!0,".webp":!0,".webm":!0,".swf":!0,".package":!0,".json":!0,".md":!0},"default-layout":"layout","default-request-length":5,"default-websocket-request-length":2,"default-websocket-encodedecode":!0,"default-maximum-file-descriptors":0,"default-timezone":"","default-request-timeout":5e3,"default-image-converter":"gm","default-image-quality":93,"allow-handle-static-files":!0,"allow-gzip":!0,"allow-websocket":!0,"allow-compile-script":!0,"allow-compile-style":!0,"allow-compile-html":!0,"allow-performance":!1,"allow-custom-titles":!1,"allow-compatibility":!1,"disable-strict-server-certificate-validation":!0,"disable-clear-temporary-directory":!1,"default-interval-clear-resources":20,"default-interval-clear-cache":7,"default-interval-precompile-views":61,"default-interval-websocket-ping":3,"default-interval-clear-dnscache":2880},this.global={},this.resources={},this.connections={},this.functions={},this.versions=null,this.schedules=[],this.isDebug=!0,this.isTest=!1,this.isLoaded=!1,this.isWorker=!1,this.isCluster=require("cluster").isWorker,this.routes={web:[],files:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{}},this.behaviours=null,this.modificators=null,this.helpers={},this.modules={},this.models={},this.sources={},this.controllers={},this.dependencies={},this.isomorphic={},this.tests=[],this.errors=[],this.problems=[],this.changes=[],this.server=null,this.port=0,this.ip="",this.workers={},this.databases={},this.directory=directory,this.isLE=os.endianness?"LE"===os.endianness():!0,this.isHTTPS=!1,this.temporary={path:{},processing:{},range:{},views:{},dependencies:{},other:{}},this.stats={other:{websocketPing:0,websocketCleaner:0},request:{request:0,pending:0,web:0,xhr:0,file:0,websocket:0,get:0,head:0,post:0,put:0,upload:0,blocked:0,"delete":0,mobile:0,desktop:0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,restriction:0,notModified:0,sse:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}},this.cache=new FrameworkCache,this.fs=new FrameworkFileSystem,this.path=new FrameworkPath,this.restrictions=new FrameworkRestrictions,this._request_check_redirect=!1,this._request_check_referer=!1,this._request_check_POST=!1,this._request_check_mobile=!1,this._length_middleware=0,this._length_request_middleware=0,this._length_files=0,this.isVirtualDirectory=!1,this.isWindows="win"===os.platform().substring(0,3).toLowerCase()}function merge_debug_writer(e,t,r,n){var o="===========================================================================================",i="js"===r?"/*\n":"css"===r?"/*!\n":"<!--\n",s="js"===r||"css"===r?"\n */":"\n-->",a="html"!==r?" * ":" ";e.write((n>0?"\n\n":"")+i+a+o+"\n"+a+"MERGED: "+t+"\n"+a+o+s+"\n\n",ENCODING)}function FrameworkRestrictions(){this.isRestrictions=!1,this.isAllowedIP=!1,this.isBlockedIP=!1,this.isAllowedCustom=!1,this.isBlockedCustom=!1,this.allowedIP=[],this.blockedIP=[],this.allowedCustom={},this.blockedCustom={},this.allowedCustomKeys=[],this.blockedCustomKeys=[]}function FrameworkFileSystem(){this.create={style:this.createStyle.bind(this),css:this.createStyle.bind(this),database:this.createDatabase.bind(this),file:this.createFile.bind(this),script:this.createScript.bind(this),js:this.createScript.bind(this),resource:this.createResource.bind(this),temporary:this.createTemporary.bind(this),view:this.createView.bind(this),worker:this.createWorker.bind(this)},this.rm={css:this.deleteStyle.bind(this),style:this.deleteStyle.bind(this),database:this.deleteDatabase.bind(this),file:this.deleteFile.bind(this),js:this.deleteScript.bind(this),script:this.deleteScript.bind(this),resource:this.deleteResource.bind(this),temporary:this.deleteTemporary.bind(this),view:this.deleteView.bind(this),worker:this.deleteWorker.bind(this)}}function FrameworkPath(){}function FrameworkCache(){this.items={},this.count=1,this.interval=null}function Subscribe(e,t,r){this.controller=null,this.req=t,this.res=r,this.route=null,this.timeout=null,this.isCanceled=!1,this.isTransfer=!1,this.header="",this.error=null}function Controller(e,t,r,n,o){this.subscribe=n,this.name=e,this.req=t,this.res=r,this.exception=null,t&&(this.language=t.$language),this.type=0,this.layoutName=framework.config["default-layout"],this.status=200,this.isLayout=!1,this.isCanceled=!1,this.isConnected=!0,this.isTimeout=!1,this.isController=!0,this.isTransfer=!1,this.repository={},this.output=null,this.outputPartial=null,this.$model=null,this._currentImage="",this._currentDownload="",this._currentVideo="",this._currentScript="",this._currentStyle="",this._currentView=o,t||(this.req={uri:{}}),r||(this.res={}),this.res.controller=this}function WebSocket(e,t,r,n){this._keys=[],this.id=n,this.online=0,this.connections={},this.repository={},this.name=r,this.isController=!0,this.url=utils.path(t),this.route=null}function WebSocketClient(e,t){this.handlers={ondata:this._ondata.bind(this),onerror:this._onerror.bind(this),onclose:this._onclose.bind(this)},this.$ping=!0,this.container=null,this._id=null,this.id="",this.socket=t,this.req=e,this.isClosed=!1,this.isWebSocket=!0,this.errors=0,this.buffer=new Buffer(0),this.length=0,this.cookie=e.cookie.bind(e),this.type=2,this._isClosed=!1}function Backup(){this.file=[],this.directory=[],this.path="",this.fileName="",this.read={key:"",value:"",status:0},this.pending=0,this.cache={},this.complete=function(){},this.filter=function(){return!0}}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(t){return e}}function fsFileRead(e,t){U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(r){fs.readFile(e,function(e,n){r(),t(e,n)})})}function fsFileExists(e,t){U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(r){fs.exists(e,function(e){r(),t(e)})})}function fsStreamRead(e,t,r){r||(r=t,t=void 0);var n={flags:"r",mode:"0666",autoClose:!0};t&&framework_utils.extend(n,t,!0),U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(t){var o=fs.createReadStream(e,n);o.on("error",noop),r(o,t)})}function createTemporaryKey(e){return(e.url?e.url:e).replace(TEMPORARY_KEY_REGEX,"-").substring(1)}function prepare_error(e){return framework.isDebug&&e?e.stack?" :: "+e.stack.toString():" :: "+e.toString():""}function prepare_isomorphic(e){e=e.replace(/\.js$/i,"");var t=framework.isomorphic[e];return t=t?t.$$output:"",'if(window["isomorphic"]===undefined)window.isomorphic={};isomorphic["'+e+'"]=(function(framework,F,U,utils,Utils,is_client,is_server){var module={},exports=module.exports={};'+t+";return exports;})(null,null,null,null,null,true,false)"}!function(e){function t(e){this.name=e,this.collection={}}function r(e,t,r,n,o){this.parent=e,this.name=t,this.primary,this.trim=!0,this.schema=r,this.properties=void 0===o?Object.keys(r):o,this.resourcePrefix,this.resourceName,this.transforms,this.composes,this.operations,this.rules,this.constants,this.onPrepare,this.onDefault,this.onValidation=n,this.onSave,this.onGet,this.onRemove,this.onQuery,this.onError,this.gcache={}}function n(e,t,r){return e.gcache[t]?e.gcache[t]:e.gcache[t]="function*"===r.toString().substring(0,9)}function o(e,t){return e.trim?t.trim():t}function i(e){this.items=[],this.transformName=w.error_default,this.onResource=e,this.resourceName=framework.config["default-errorbuilder-resource-name"]||"default",this.resourcePrefix=framework.config["default-errorbuilder-resource-prefix"]||"",this.isResourceCustom=!1,this.count=0,this.replacer=[],this.isPrepared=!1,void 0===e&&this._resource()}function s(){this.builder={}}function a(e,t,r,n){this.isNext=!1,this.isPrev=!1,this.isFirst=!1,this.isLast=!1,this.items=e,this.count=0,this.skip=0,this.take=0,this.page=0,this.max=0,this.visible=!1,this.format=n||"?page={0}",this.refresh(e,t,r),this.transformName=w.pagination_default}function u(e,t){return void 0===e?t:e}function c(){}var l=e.exports;global.framework_builders=e.exports;var p="undefined",f="function",d="object",m="string",h="number",g="boolean",v='The field "@" is required.',y="default",b={},w={pagination:{},error:{},objectbuilder:{},transformbuilder:{}};return t.prototype.get=function(e){return this.collection[e]},t.prototype.add=function(e,t,n,o){var i=this;typeof t===p&&(t={});var s=Object.keys(t);n||(n=s),i.collection[e]=new r(i,e,{},o,n);for(var a=0,u=s.length;u>a;a++){var c=s[a];i.collection[e].define(c,t[c])}return i.collection[e]},t.prototype.create=function(){var e=this;return e.add.apply(e,arguments)},t.prototype.Create=function(){var e=this;return e.add.apply(e,arguments)},t.prototype.remove=function(e){var t=this;if(void 0===e)return delete b[e],void(t.collection=null);var r=t.collection[e];return r&&r.remove(),r=null,t},t.prototype.destroy=function(e){return this.remove(e)},r.prototype.define=function(e,t,n,o){var i=this;if(e instanceof Array){for(var s=0,a=e.length;a>s;s++)i.define(e[s],t,n,o);return i}return void 0!==n&&typeof n!==g&&(o=n,n=!1),t instanceof r&&(t=t.name),i.schema[e]=i.$parse(e,t,n,o),n?((void 0===i.properties||null===i.properties)&&(i.properties=[]),-1!==i.properties.indexOf(e)?i:(i.properties.push(e),i)):i},r.prototype.setPrimary=function(e){return this.primary=e,this},r.prototype.filter=function(e,t,r){var n=this;if(typeof t===g){var o=r;r=t,t=o}var i=void 0===t?[]:{},s=typeof e,a=s===m?"*"===e[0]||"%"===e[0]:!1,u=!1;a?e=e.substring(1):s===d&&(u=framework_utils.isRegExp(e));for(var c in n.schema){var l=n.schema[c];if(l){var p=typeof l.custom;if(a){if(p!==m)continue;if(-1===l.custom.indexOf(e)){if(!r)continue}else if(r)continue}else if(u){if(p!==m)continue;if(e.test(l.current)){if(r)continue}else if(!r)continue}else if(l.custom!==e){if(!r)continue}else if(r)continue;void 0===t?i.push(c):i[c]=t[c]}}return i},r.prototype.$parse=function(e,t,r,n){var o=typeof t,i={};if(i.raw=t,i.type=0,i.length=0,i.required=r?!0:!1,i.isArray=!1,i.custom=n||"",null===t)return i;if("[]"===t)return i.isArray=!0,i;if(o===f)return t===Number?(i.type=2,i):t===String?(i.type=3,i):t===Boolean?(i.type=4,i):t===Date?(i.type=5,i):t===Array?(i.isArray=!0,i):t===Object?(i.type=6,i):i;if(o===d)return i;"["===t[0]&&(t=t.substring(1,t.length-1),i.isArray=!0,i.raw=t);var s=t.toLowerCase();if("object"===s)return i.type=6,i;if("array"===s)return i.isArray=!0,i;if(s.contains([m,"text","varchar","nvarchar"])){i.type=3;var a=s.indexOf("(");if(-1===a)return i;var u=s.substring(a+1,s.length-1).parseInt();return i.length=u,i.raw=s.substring(0,a),i}return s.contains(["int","byte"])?(i.type=1,i):s.contains(["decimal",h,"float","double"])?(i.type=2,i):s.contains("bool",g)?(i.type=4,i):s.contains(["date","time"])?(i.type=5,i):(i.type=7,i)},r.prototype.getDependencies=function(){var e=this,t=[];for(var r in e.schema){var n=e.schema[r];if(typeof n===m){var o="]"===n[0];o&&(n=n.substring(1,n.length-1));var i=e.parent.get(n);void 0!==typeof i&&t.push({name:r,isArray:o,schema:i})}}return t},r.prototype.setValidation=function(e,t){var r=this;return void 0===t&&e instanceof Array?(r.properties=e,r):(typeof e!==f?(r.properties=e,r.onValidation=t):r.onValidation=e,r)},r.prototype.setValidate=function(e,t){return this.setValidation(e,t)},r.prototype.setPrefix=function(e){return this.resourcePrefix=e,this},r.prototype.setResource=function(e){return this.resourceName=e,this},r.prototype.setDefault=function(e){var t=this;return t.onDefault=e,t},r.prototype.setPrepare=function(e){var t=this;return t.onPrepare=e,t},r.prototype.setSave=function(e){var t=this;return t.onSave=e,t},r.prototype.setError=function(e){var t=this;return t.onError=e,t},r.prototype.setGet=function(e){var t=this;return t.onGet=e,t},r.prototype.setQuery=function(e){var t=this;return t.onQuery=e,t},r.prototype.setRemove=function(e){var t=this;return t.onRemove=e,t},r.prototype.setProperties=function(e){var t=this;return t.properties=e,t},r.prototype.addRule=function(e,t){var r=this;return void 0===t&&(t=e,e="default"),r.rules||(r.rules={}),r.rules[e]=t,r},r.prototype.constant=function(e,t){var r=this;return void 0===t?r.constants?r.constants[e]:void 0:(r.constants||(r.constants={}),r.constants[e]=t,r)},r.prototype.addTransform=function(e,t){var r=this;return typeof e===f&&(t=e,e="default"),r.transforms||(r.transforms={}),r.transforms[e]=t,r},r.prototype.addOperation=function(e,t){var r=this;return typeof e===f&&(t=e,e="default"),r.operations||(r.operations={}),r.operations[e]=t,r},r.prototype.addWorkflow=function(e,t){var r=this;return typeof e===f&&(t=e,e="default"),r.workflows||(r.workflows={}),r.workflows[e]=t,r},r.prototype.addCompose=function(e,t){var r=this;return typeof e===f&&(t=e,e="default"),r.composes||(r.composes={}),r.composes[e]=t,r},r.prototype.addComposer=function(e,t){return this.addCompose(e,t)},r.prototype.find=function(e){return this.parent.get(e)},r.prototype.rule=function(e,t){var r=this;return t?r.addRule(e,t):void 0===r.rules?void 0:(void 0===e&&(e="default"),r.rules[e])},r.prototype.destroy=function(){var e=this;delete e.parent.collection[e.name],e.properties=null,e.schema=null,e.onDefault=null,e.onValidation=null,e.onSave=null,e.onRead=null,e.onRemove=null,e.onQuery=null,e.workflows=null,e.transforms=null},r.prototype.save=function(e,t,r,o){typeof r===g?(o=r,r=t,t=void 0):void 0===r&&(r=t,t=void 0),typeof r!==f&&(r=function(){});var s=this,a="save";return s.$prepare(e,function(e,u){if(e)return void r(e,u);var c=new i;return n(s,a,s.onSave)?(r.success=!1,void async.call(s,s.onSave)(function(e){e&&!r.success&&(r.success=!0,c.push(e),s.onError&&s.onError(c,u,a),r(c))},c,u,t,function(e){if(!r.success){(2===arguments.length||e instanceof Error||e instanceof i)&&((e instanceof Error||e instanceof i)&&c.push(e),e=arguments[1]);var t=c.hasError();t&&s.onError&&s.onError(c,u,a),r.success=!0,r(t?c:null,void 0===e?u:e)}},o!==!0)):(s.onSave(c,u,t,function(e){s.$process(arguments,u,a,void 0,c,e,r)},o!==!0),s)}),s},r.prototype.get=function(e,t){void 0===t&&(t=e,e=void 0),typeof t!==f&&(t=function(){});var r=this,o=new i,s=r["default"](),a="get";return n(r,a,r.onGet)?(t.success=!1,async.call(r,r.onGet)(function(e){e&&!t.success&&(t.success=!0,o.push(e),r.onError&&r.onError(o,model,a),t(o))},o,s,e,function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof i)&&((e instanceof Error||e instanceof i)&&o.push(e),e=arguments[1]),t.success=!0;var n=o.hasError();n&&r.onError&&r.onError(o,model,a),t(n?o:null,void 0===e?s:e)}}),r):(r.onGet(o,s,e,function(e){r.$process(arguments,s,a,void 0,o,e,t)}),r)},r.prototype.remove=function(e,t){void 0===t&&(t=e,e=void 0);var r=this,o=new i,s="remove";return n(r,s,r.onRemove)?(t.success=!1,async.call(r,r.onRemove)(function(e){e&&!t.success&&(t.success=!0,o.push(e),r.onError&&r.onError(o,model,s),t(o))},o,e,function(n){if(!t.success){(2===arguments.length||n instanceof Error||n instanceof i)&&((n instanceof Error||n instanceof i)&&o.push(n),n=arguments[1]);var a=o.hasError();a&&r.onError&&r.onError(o,model,s),t.success=!0,t(a?o:null,void 0===n?e:n)}}),r):(r.onRemove(o,e,function(e){r.$process(arguments,void 0,s,void 0,o,e,t)}),r)},r.prototype.query=function(e,t){void 0===t&&(t=e,e=void 0);var r=this,o=new i,s="query";return n(r,s,r.onQuery)?(t.success=!1,async.call(r,r.onQuery)(function(e){e&&!t.success&&(t.success=!0,o.push(e),r.onError&&r.onError(o,model,s),t(o))},o,e,function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof i)&&((e instanceof Error||e instanceof i)&&o.push(e),e=arguments[1]);var n=o.hasError();n&&r.onError&&r.onError(o,model,s),t.success=!0,t(o.hasError()?o:null,e)}}),r):(r.onQuery(o,e,function(e){r.$process(arguments,void 0,s,void 0,o,e,t)}),r)},r.prototype.validate=function(e,t,r,n){var o=this,s=o.onValidation;return void 0===n&&(n=new i),void 0!==s&&null!==s||(s=framework.onValidation,void 0!==s&&null!==s)?(o.resourcePrefix&&(n.resourcePrefix=o.resourcePrefix),o.resourceName&&(n.resourceName=o.resourceName),r&&(n.resourceName=r),t&&(n.resourcePrefix=t),framework_utils.validate_builder.call(o,e,n,o.name,o.parent.collection,o.name)):n},r.prototype.create=function(){return this["default"]()},r.prototype.Create=function(){return this["default"]()},r.prototype.$make=function(e){if(e.$save)return e;var t=this;return e.$async=function(t,r){return void 0===t&&(t=NOOP),e.$$async=[],e.$$result=[],e.$callback=t,setImmediate(function(){e.$$async.async(function(){var n=e.$$result;delete e.$$result,delete e.$$async,t(null,void 0!==r?n[r]:n)})}),e},e.$save=function(r,n){return e.$$async?(e.$$async.push(function(n){t.save(e,r,function(t,r){if(e.$$result&&e.$$result.push(t?null:r),!t)return n();n=null;var r=e.$$result;delete e.$$result,delete e.$$async,e.$callback(t,r)})}),e):(t.save(e,r,n),e)},e.$remove=function(r,n){return e.$$async?(e.$$async.push(function(n){t.remove(e,r,function(t,r){if(e.$$result&&e.$$result.push(t?null:r),!t)return n();n=null;var r=e.$$result;delete e.$$result,delete e.$$async,e.$callback(t,r)})}),e):(t.remove(r,n),e)},e.$default=function(){return t["default"]()},e.$destroy=function(){e=null},e.$transform=function(r,n,o){return e.$$async?(e.$$async.push(function(o){t.transform(r,e,n,function(t,r){if(e.$$result&&e.$$result.push(t?null:r),!t)return o();o=null;var r=e.$$result;delete e.$$result,delete e.$$async,e.$callback(t,r)})}),e):(t.transform(r,e,n,o),e)},e.$compose=function(r,n,o){return e.$$async?(e.$$async.push(function(o){t.compose(r,e,n,function(t,r){if(e.$$result&&e.$$result.push(t?null:r),!t)return o();o=null;var r=e.$$result;delete e.$$result,delete e.$$async,e.$callback(t,r)})}),e):(t.compose(r,e,n,o),e)},e.$workflow=function(r,n,o){return e.$$async?(e.$$async.push(function(o){t.workflow(r,e,n,function(t,r){if(e.$$result&&e.$$result.push(t?null:r),!t)return o();o=null;var r=e.$$result;delete e.$$result,delete e.$$async,e.$callback(t,r)})}),e):(t.workflow(r,e,n,o),e)},e.$operation=function(r,n,o){return e.$$async?(e.$$async.push(function(o){t.operation(r,e,n,function(t,r){if(e.$$result&&e.$$result.push(t?null:r),!t)return o();o=null;var r=e.$$result;delete e.$$result,delete e.$$async,e.$callback(t,r)})}),e):(t.operation(r,e,n,o),e)},e.$clean=function(){return t.clean(e)},e.$clone=function(){return t.$make(JSON.parse(JSON.stringify(e)))},e.$prepare=function(){return t.prepare(e)},e.$schema=function(){return t},e.$validate=function(r,n,o){return t.validate(e,r,n,o)},e.$rule=function(e){return t.rule(e)},e.$constant=function(e){return t.constant(e)},e},r.prototype.$prepare=function(e,t){var r=this;return typeof e.$save===f?(t(null,e),r):(r.make(e,function(e,r){t(e,r)}),r)},r.prototype["default"]=function(){var e=this,t=e.schema;if(null===t)return null;var r=e.onDefault,n=framework_utils.extend({},t,!0);for(var o in n){var i=n[o];if(r){var s=r(o,!0,e.name);if(void 0!==s){n[o]=s;continue}}switch(i.type){case 0:case 6:n[o]=i.isArray?[]:null;break;case 1:case 2:n[o]=i.isArray?[]:0;break;case 3:n[o]=i.isArray?[]:"";break;case 4:n[o]=i.isArray?[]:!1;break;case 5:n[o]=i.isArray?[]:new Date;break;case 7:if(i.isArray)n[o]=[];else{var a=e.find(i.raw);a?n[o]=a["default"]():(framework.error(new Error('Schema: "'+o+"."+i.raw+'" not found in "'+e.parent.name+'".')),n[o]=null)}}}return e.$make(n)},r.prototype.make=r.prototype.load=function(e,t){var r=this,n=r.prepare(e);if(void 0===r.onValidation)return t&&t(null,n),n;var o=r.validate(n);return o.hasError()?(r.onError&&r.onError(o,e,"make"),t&&t(o,null),n):(t&&t(null,n),n)},r.prototype.prepare=function(e,t){var r=this,n=r.schema;if(null===n)return null;if(null===e||void 0===e)return r["default"]();var i,s,a=function(t,n,o){if(!r.onPrepare)return n;var i=r.onPrepare(t,n,o,e);return void 0===i?n:i},c=framework_utils.extend({},n,!0),l=r.onDefault;for(var p in c){var g=e[p];e.hasOwnProperty(p)||(g=void 0),void 0===g&&l&&(g=l(p,!1,r.name)),void 0===g&&(g="");var v=c[p],y=typeof g;if(y===f&&(g=g()),v.isArray)if(g instanceof Array){c[p]=[];for(var b=0,w=g.length;w>b;b++){switch(i=e[p][b],y=typeof i,v.type){case 0:i=a(p,i,b);break;case 1:i=a(p,framework_utils.parseInt(i),b);break;case 2:i=a(p,framework_utils.parseFloat(i),b);break;case 3:i=void 0===i||null===i?"":o(r,i.toString()),v.length&&i.length<i.length&&(i=i.substring(0,v.length)),i=a(p,i,b);break;case 4:i&&(i=i.toString().toLowerCase()),i=a(p,"true"===i||"1"===i||"on"===i,b);break;case 5:y===m?i=""===i?null:i.trim().parseDate():y===d?i=framework_utils.isDate(i)?i:null:y===h&&(i=new Date(i)),null!==i&&typeof i===d&&"Invalid Date"===i.toString()&&(i=null),i=i?a(p,i,b):void 0;break;case 6:i=a(p,i,b);break;case 7:s=r.parent.get(v.raw),s?(i=s.prepare(i,t),t&&t.push({name:v.raw,value:a(p,i,b)})):i=null,i=a(p,i,b)}void 0!==i&&c[p].push(i)}}else c[p]=l?u(l(p,!1,r.name),[]):[];else switch(v.type){case 0:break;case 1:c[p]=a(p,framework_utils.parseInt(g));break;case 2:c[p]=a(p,framework_utils.parseFloat(g));break;case 3:i=void 0===g||null===g?"":o(r,g.toString()),v.length&&v.length<i.length&&(i=i.substring(0,v.length)),c[p]=a(p,i);break;case 4:i=g?g.toString().toLowerCase():null,c[p]=a(p,"true"===i||"1"===i||"on"===i);break;case 5:i=null,y===m?i=""===g?null:g.trim().parseDate():y===d?i=framework_utils.isDate(g)?g:null:y===h&&(i=new Date(g)),null!==i&&typeof i===d&&"Invalid Date"===i.toString()&&(i=null),c[p]=i?a(p,i):l?u(l(p,!1,r.name),null):null;break;case 6:c[p]=a(p,e[p]);break;case 7:s=r.parent.get(v.raw),s?(c[p]=s.prepare(g),t&&t.push({name:v.raw,value:a(p,c[p])})):c[p]=null}}return r.$make(c)},r.prototype.transform=function(e,t,r,o,s){var a=this;typeof e!==m&&(o=r,r=t,t=e,e="default"),typeof o===g?(s=o,o=r,r=void 0):void 0===o&&(o=r,r=void 0),typeof o!==f&&(o=function(){});var u=a.transforms?a.transforms[e]:void 0;if(!u)return o((new i).add("","Transform not found.")),a;var c="transform";if(s===!0){var l=new i;return u.call(a,l,t,r,function(r){a.$process(arguments,t,c,e,l,r,o)},s!==!0),a}return a.$prepare(t,function(t,l){if(t)return void o(t,l);var p=new i;return n(a,"transform."+e,u)?(o.success=!1,void async.call(a,u)(function(t){t&&!o.success&&(o.success=!0,p.push(t),a.onError&&a.onError(p,l,c,e),o(p))},p,l,r,function(t){if(!o.success){(2===arguments.length||t instanceof Error||t instanceof i)&&((t instanceof Error||t instanceof i)&&p.push(t),t=arguments[1]);var r=p.hasError();r&&a.onError&&a.onError(p,l,c,e),o.success=!0,o(r?p:null,void 0===t?l:t)}},s!==!0)):void u.call(a,p,l,r,function(t){a.$process(arguments,l,c,e,p,t,o)},a.name)}),a},r.prototype.compose=function(e,t,r,o,s){var a=this;typeof e!==m&&(o=r,r=t,t=e,e="default"),typeof o===g?(s=o,o=r,r=void 0):void 0===o&&(o=r,r=void 0),typeof o!==f&&(o=function(){});var u=a.composes?a.composes[e]:void 0;if(!u)return o((new i).add("","Composer not found.")),a;var c="compose";if(s===!0){var l=new i;return u.call(a,l,t,r,function(r){a.$process(arguments,t,c,e,l,r,o)},s!==!0),a}return a.$prepare(t,function(t,l){if(t)return void o(t,l);var p=a["default"](),f=new i;return n(a,"compose."+e,u)?(o.success=!1,void async.call(a,u)(function(t){t&&!o.success&&(o.success=!0,f.push(t),a.onError&&a.onError(f,l,c,e),o(f))},f,l,r,function(t){if(!o.success){(2===arguments.length||t instanceof Error||t instanceof i)&&((t instanceof Error||t instanceof i)&&f.push(t),t=arguments[1]);var r=f.hasError();r&&a.onError&&a.onError(f,l,c,e),o.success=!0,o(r?f:null,void 0===t?l:t)}},s!==!0)):void u.call(a,f,p,l,r,function(t){a.$process(arguments,l,c,e,f,t,o)},s!==!0)}),a},r.prototype.$process=function(e,t,r,n,o,s,a){var u=this;(2===e.length||s instanceof Error||s instanceof i)&&((s instanceof Error||s instanceof i)&&o.push(s),s=e[1]);var c=o.hasError();return c&&u.onError&&u.onError(o,t,r,n),a(c?o:null,void 0===s?t:s,t),u},r.prototype.workflow=function(e,t,r,o,s){var a=this;typeof e!==m&&(o=r,r=t,t=e,e="default"),typeof o===g?(s=o,o=r,r=void 0):void 0===o&&(o=r,r=void 0),typeof o!==f&&(o=function(){});var u=a.workflows?a.workflows[e]:void 0;if(!u)return o((new i).add("","Workflow not found.")),a;var c="workflow";if(s===!0){var l=new i;return u.call(a,l,t,r,function(r){a.$process(arguments,t,c,e,l,r,o)},s!==!0),a}return a.$prepare(t,function(t,l){if(t)return void o(t,l);var p=new i;return n(a,"workflow."+e,u)?(o.success=!1,void async.call(a,u)(function(t){t&&!o.success&&(o.success=!0,p.push(t),a.onError&&a.onError(p,l,c,e),o(p))},p,l,r,function(t){if(!o.success){(2===arguments.length||t instanceof Error||t instanceof i)&&((t instanceof Error||t instanceof i)&&p.push(t),t=arguments[1]);var r=p.hasError();r&&a.onError&&a.onError(p,l,c,e),o.success=!0,o(r?p:null,void 0===t?l:t)}},s!==!0)):void u.call(a,p,l,r,function(t){a.$process(arguments,l,c,e,p,t,o)},s!==!0)}),a},r.prototype.operation=function(e,t,r,o,s){var a=this,u=typeof r,c=typeof o;c===p?u===f?(o=r,r=t,t=void 0):u===p&&(r=t,t=void 0):u===p?(r=t,t=void 0):c===g&&(s=o,o=r,r=void 0),typeof r===f&&(o=r,r=void 0),typeof o!==f&&(o=function(){});var l=a.operations?a.operations[e]:void 0;if(!l)return o((new i).add("","Operation not found.")),a;var d=new i,m="operation";return n(a,"operation."+e,l)?(o.success=!1,async.call(a,l)(function(r){r&&!o.success&&(o.success=!0,d.push(r),a.onError&&a.onError(d,t,m,e),o(d))},d,t,r,function(r){if(!o.success){(2===arguments.length||r instanceof Error||r instanceof i)&&((r instanceof Error||r instanceof i)&&d.push(r),r=arguments[1]);var n=d.hasError();n&&a.onError&&a.onError(d,t,m,e),o.success=!0,o(n?d:null,r)}},s!==!0),a):(l.call(a,d,t,r,function(r){a.$process(arguments,t,m,e,d,r,o)},s!==!0),a)},r.prototype.clean=function(e,t){if(null===e||void 0===e)return e;var r;r=t?e:framework_utils.copy(e);var n=this;delete r.$$result,delete r.$$async,delete r.$clone,delete r.$async,delete r.$callback,delete r.$transform,delete r.$workflow,delete r.$operation,delete r.$destroy,delete r.$save,delete r.$remove,delete r.$clean,delete r.$prepare,delete r.$default,delete r.$schema,delete r.$validate,delete r.$compose,delete r.$rule,delete r.$constant;for(var o in r){var i=r[o];if(null!==i&&typeof i===d)if(i instanceof Array)for(var s=0,a=i.length;a>s;s++){var u=i[s];null!==u&&typeof u===d&&(i[s]=n.clean(u,!0))}else r[o]=n.clean(i,!0)}return r},l.schema=function(e,r,n,o,i){if(void 0===r)return void 0===b[e]&&(b[e]=new t(e)),b[e];void 0===b[y]&&(b[y]=new t(y)),typeof n!==f&&(n=void 0),typeof o!==f&&(o=void 0),i instanceof Array||(i=void 0);var s=b[y].add(e,r,i,o);return n&&s.setDefault(n),r},l.load=function(e,r,n){e||(e=y),void 0===b[e]&&(b[e]=new t(e));var o;if(r&&(o=b[e].get(r),!o))throw new Error("Schema "+e+"."+r+" not found.");return n?o.make(n):r?o:b[e]},l.getschema=function(e,t){t||(t=e,e=y);var r=b[e];if(void 0!==r){var n=r.get(t);return n?n:void 0}},l.newschema=function(e,r,n){e||(e=y),void 0===b[e]&&(b[e]=new t(e));var o;return r&&(o=b[e].get(r),o||(o=b[e].create(r))),n?o.make(n):r?o:b[e]},l.remove=function(e){delete b[e]},l.isJoin=function(e,t){return t?"["===t[0]?!0:void 0===e?!1:void 0!==e[t]:!1},l.validation=function(e,t,r){if(void 0===b[y])return[];var n=b[y].get(e);if(void 0===n)return[];if(r instanceof Array&&typeof t===f){var o=r;r=t,t=o}if(typeof r===f)return n.onValidation=r,n.properties=void 0===t?Object.keys(n.schema):t,!0;if(void 0===r){var i=n.properties;return void 0===i?Object.keys(n.schema):i||[]}return n.onValidation=r,r},l.validate=function(e,t,r,n){var o=b[y];return void 0===o?null:(o=o.get(e),void 0===o?null:o.validate(t,r,n))},l.create=function(e){return l.defaults(e)},l.defaults=function(e){if(void 0===b[y])return null;var t=b[y].get(e);return void 0===t?null:t["default"]()},l.prepare=function(e,t){if(void 0===b[y])return null;var r=b[y].get(e);return void 0===r?null:r.prepare(t)},i.prototype={get errors(){var e=this;return e.isPrepared||e.prepare(),e._transform()},get error(){var e=this;return e.isPrepared||e.prepare(),e._transform()}},i.prototype.resource=function(e,t){var r=this;return r.isResourceCustom=!0,r.resourceName=e||"default",r.resourcePrefix=t||"",r._resource()},i.prototype.setResource=function(e){var t=this;return t.isResourceCustom=!0,t.resourceName=e||"default",t._resource()},i.prototype.setPrefix=function(e){var t=this;return t.isResourceCustom=!0,t.resourcePrefix=e||"",t._resource()},i.prototype._resource=function(){var e=this;return e.onResource=function(e){var t=this;return typeof framework!==p?framework.resource(t.resourceName,t.resourcePrefix+e):""},e},i.prototype.add=function(e,t,r,n){var o=this;if(o.isPrepared=!1,e instanceof i){if(e.hasError()){for(var s=0,a=e.items.length;a>s;s++)o.items.push(e.items[s]);o.count=o.items.length}return o}if(e instanceof Array){for(var s=0,a=e.length;a>s;s++)o.add(e[s],void 0,r,n);return o}if(t instanceof Array){for(var s=0,a=t.length;a>s;s++)o.add(e,t[s],r,n);return o}return typeof e===d&&(r=t,t=e,e=""),void 0!==e&&null!==e||void 0!==t&&null!==t?(void 0===t&&(t="@"),void 0===t||null===t?o:(t instanceof Error&&(t=t.toString()),o.items.push({name:e,error:typeof t===m?t:(t||"").toString()||"@",path:r,index:n}),o.count=o.items.length,o)):o},i.prototype.push=function(e,t,r,n){return this.add(e,t,r,n)},i.prototype.remove=function(e){var t=this;return t.items=t.items.remove(function(t){return t.name===e}),t.count=t.items.length,t},i.prototype.hasError=function(e){var t=this;return e?null!==t.items.find(function(t){return t.name===e}):t.items.length>0},i.prototype.read=function(e){var t=this;t.isPrepared||t.prepare();var r=t.items.find(function(t){return t.name===e});return null!==r?r.error:null},i.prototype.clear=function(){var e=this;return e.items=[],e.count=0,e},i.prototype.replace=function(e,t){var r=this;return r.isPrepared=!1,r.replacer[e]=t,r},i.prototype.json=function(e,t){var r=this.prepare()._transform();return e?JSON.stringify(r,t,"	"):JSON.stringify(r,t)},i.prototype.JSON=function(e,t){return this.json(e,t)},i.prototype.output=function(){return this.prepare()._transform()},i.prototype._prepare=function(){var e=this;if(null===e.onResource)return e;for(var t=e.items,r=t.length,n=0;r>n;n++){var o=t[n];"@"===o.error[0]&&(o.error=e.onResource(1===o.error.length?o.name:o.error.substring(1)),(void 0===o.error||0===o.error.length)&&(o.error=v.replace("@",o.name)))}return e},i.prototype._transform=function(e){var t=this,r=e||t.transformName;if(!r)return t.items;var n=w.error[r];return void 0===n?t.items:n.call(t)},i.prototype.toString=function(){var e=this;e.isPrepared||e.prepare();for(var t=e.items,r=t.length,n=[],o=0;r>o;o++)n.push(t[o].error||t[o].name);return n.join("\n")},i.prototype.setTransform=function(e){var t=this;return t.transformName=e,t},i.prototype.transform=function(e){var t=this;
return t.prepare()._transform(e)},i.prototype._prepareReplace=function(){var e=this,t=e.items,r=t.length,n=Object.keys(e.replacer),o=n.length;if(0===r||0===o)return e;for(var i=0;r>i;i++)for(var s=t[i],a=0;o>a;a++){var u=n[a];s.error=s.error.replace(u,e.replacer[u])}return e},i.prototype.prepare=function(){var e=this;return e.isPrepared?e:(e._prepare()._prepareReplace(),e.isPrepared=!0,e)},i.addTransform=function(e,t,r){w.error[e]=t,r&&i.setDefaultTransform(e)},i.removeTransform=function(e){delete w.error[e]},i.setDefaultTransform=function(e){void 0===e?delete w.error_default:w.error_default=e},a.addTransform=function(e,t,r){w.pagination[e]=t,r&&a.setDefaultTransform(e)},a.setDefaultTransform=function(e){void 0===e?delete w.pagination_default:w.pagination_default=e},a.removeTransform=function(e){delete w.pagination[e]},a.prototype.refresh=function(e,t,r){var n=this;return n.count=Math.floor(e/r)+(e%r>0?1:0),n.page=t-1,n.page<0&&(n.page=0),n.items=e,n.skip=n.page*r,n.take=r,n.max=r,n.isPrev=n.page>0,n.isNext=n.page<n.count-1,n.isFirst=n.count>1,n.isLast=n.count>1,n.visible=n.count>1,n.page++,n},a.prototype.setTransform=function(e){var t=this;return t._transform=e,t},a.prototype.transform=function(e){var t=this,r=e||t.transformName;if(!r)throw new Error("A transformation of Pagination not found.");var n=w.pagination[r];if(void 0===n)return t.render();for(var o=[],i=1;i<arguments.length;i++)o.push(arguments[i]);return n.apply(t,o)},a.prototype.prev=function(e){var t=this,r=0;return e=e||t.format,r=t.isPrev?t.page-1:t.count,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.isPrev}},a.prototype.next=function(e){var t=this,r=0;return e=e||t.format,r=t.isNext?t.page+1:1,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.isNext}},a.prototype.last=function(e){var t=this,r=t.count;return t.isPrev&&(r=t.page-1),e=e||t.format,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.count>0}},a.prototype.first=function(e){var t=this,r=1;return e=e||t.format,{url:e.format(r,t.items,t.count),page:r,selected:!1,enabled:t.count>0}},a.prototype.prepare=function(e,t){var r=this;if(r.transformName)return w.pagination[r.transformName].apply(r,arguments);var n=[];if(t=t||r.format,typeof e===m){var o=t;t=e,e=o}if(void 0===e||null===e){for(var i=1;i<r.count+1;i++)n.push({url:t.format(i,r.items,r.count),page:i,selected:i===r.page,enabled:!0});return n}var s=Math.floor(e/2),a=r.count,u=r.page-s,c=r.page+s,l=0;0>=u&&(l=Math.abs(u),u=1,c+=l),c>=a&&(c=a,u=a-e),0>u&&(u=1);for(var i=u;c+1>i;i++)n.push({url:t.format(i,r.items,r.count),page:i,selected:i===r.page,enabled:!0});return n},a.prototype.render=function(e,t){return this.prepare(e,t)},s.prototype.add=function(e,t){var r=this;if(typeof e!==d)return r.builder[e]=t,r;for(var n=Object.keys(e),o=0,i=n.length;i>o;o++)r.builder[n[o]]=e[n[o]];return r},s.prototype.remove=function(e){var t=this;return delete t.builder[e],t},s.prototype.read=function(e){return this.builder[e]||null},s.prototype.clear=function(){var e=this;return e.builder={},e},s.prototype.toString=function(e,t){if(typeof e===g){var r=t;t=e,e=r}var n=this,o=[];return Object.keys(n.builder).forEach(function(e){var r=n.builder[e];r=void 0===r||null===r?"":r.toString(),t&&""===r||o.push(e+"="+encodeURIComponent(r))}),typeof e===m?"?"!==e[e.length-1]&&(e+="?"):e="",e+o.join("&")},s.prototype.hasValue=function(e){if(void 0===e)return!1;var t=this;"string"==typeof e&&(e=[e]);for(var r=0;r<e.length;r++){var n=t.builder[e[r]];if(void 0===n||null===n)return!1}return!0},s.prototype.toOne=function(e,t){var r=this,n=[];return e.forEach(function(e){n.push(r.builder[e]||"")}),n.join(t||"&")},c.transform=function(e,t){var r=2;void 0===t&&(t=e,e=w.transformbuilder_default,r=1);var n=w.transformbuilder[e];if(!n)return t;var o=arguments.length-r;if(0>=o)return n.call(t,t);var i=new Array(o+1),s=1;i[0]=t;for(var a=r;a<arguments.length;a++)i[s++]=arguments[a];return n.apply(t,i)},c.addTransform=function(e,t,r){w.transformbuilder[e]=t,r&&c.setDefaultTransform(e)},c.setDefaultTransform=function(e){void 0===e?delete w.transformbuilder_default:w.transformbuilder_default=e},l.SchemaBuilder=t,l.ErrorBuilder=i,l.Pagination=a,l.UrlBuilder=s,l.TransformBuilder=c,global.ErrorBuilder=i,global.TransformBuilder=c,e}({exports:{}}),function(module){function expression(query,params){var name=params.join(","),fn=expressionCache[query+"-"+name];fn||(fn=eval("(function("+name+"){"+(-1===query.indexOf("return")?"return ":"")+query+"})"),expressionCache[query+name]=fn);for(var values=[],i=2;i<arguments.length;i++)values.push(arguments[i]);return function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);for(var t=0;t<values.length;t++)e.push(values[t]);return fn.apply(this,e)}}function getWebSocketFrameMessageBytes(e,t){for(var r=0===e?0:2,n=void 0!==t.readUInt8,o=t.length,i=new Buffer(o+r),s=0;o>s;s++)i[s+r]=n?t[s]:t.charCodeAt(s);return 0===e?i:(i[0]=e>>8,i[1]=e,i)}function getWebSocketFrameLengthBytes(e){var t=null;return 125>=e?(t=new Buffer(1),t[0]=e,t):65535>=e?(t=new Buffer(3),t[0]=126,t[1]=e>>8&255,t[2]=255&e,t):(t=new Buffer(9),t[0]=127,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e>>24&255,t[6]=e>>16&255,t[7]=e>>8&255,t[8]=255&e,t)}function string_hash(e){var t,r,n=0;if(0===e.length)return n;var o=e.length;for(t=0;o>t;t++)r=e.charCodeAt(t),n=(n<<5)-n+r,n|=0;return n}function AsyncTask(e,t,r,n,o){this.handlers={oncomplete:this.complete.bind(this)},this.isRunning=0,this.owner=e,this.name=t,this.fn=r,this.cb=n,this.waiting=o,this.interval=null,this.isCanceled=!1}function Async(e){this._max=0,this._count=0,this._isRunning=!1,this.owner=e,this.onComplete=[],this.tasksPending={},this.tasksWaiting={},this.tasksAll=[],this.tasksTimeout={},events.EventEmitter.call(this)}function FileList(){this.pending=[],this.pendingDirectory=[],this.directory=[],this.file=[],this.onComplete=null,this.onFilter=null}function converBytesToInt64(e,t,r){return r?e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24|e[t+4]<<32|e[t+5]<<40|e[t+6]<<48|e[t+7]<<56:e[t+7]<<32|e[t+6]<<40|e[t+5]<<48|e[t+4]<<56|e[t+3]|e[t+2]<<8|e[t+1]<<16|e[t]<<24}function queue_next(e){var t=exports.queuecache[e];if(t&&(t.running--,t.running<0&&(t.running=0),0!==t.pending.length)){var r=t.pending.shift();if(!r)return void(t.running=0);t.running++,function(e){setImmediate(function(){r(function(){queue_next(e)})})}(e)}}var exports=module.exports;global.framework_utils=module.exports;var Dns=require("dns"),parser=require("url"),qs=require("querystring"),http=require("http"),https=require("https"),util=require("util"),path=require("path"),fs=require("fs"),events=require("events"),crypto=require("crypto"),expressionCache={},regexpMail=new RegExp("^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$"),regexpUrl=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"),regexpTRIM=/^[\s]+|[\s]+$/g,regexpDATE=/(\d{1,2}\.\d{1,2}\.\d{4})|(\d{4}\-\d{1,2}\-\d{1,2})|(\d{1,2}\:\d{1,2}(\:\d{1,2})?)/g,regexpSTATIC=/\.\w{2,8}($|\?)+/,regexpDATEFORMAT=/yyyy|yy|MM|M|dd|d|HH|H|hh|h|mm|m|ss|s|a/g,regexpSTRINGFORMAT=/\{\d+\}/g,DIACRITICS={225:"a",228:"a",269:"c",271:"d",233:"e",283:"e",357:"t",382:"z",250:"u",367:"u",252:"u",369:"u",237:"i",239:"i",244:"o",243:"o",246:"o",353:"s",318:"l",314:"l",253:"y",255:"y",263:"c",345:"r",341:"r",328:"n",337:"o"},ENCODING="utf8",UNDEFINED="undefined",STRING="string",FUNCTION="function",NUMBER="number",OBJECT="object",BOOLEAN="boolean",NEWLINE="\r\n",VERSION=typeof framework!==UNDEFINED?" v"+framework.version_header:"",isWindows="win"===require("os").platform().substring(0,3).toLowerCase(),dnscache={},contentTypes={aac:"audio/aac",ai:"application/postscript",appcache:"text/cache-manifest",avi:"video/avi",bin:"application/octet-stream",bmp:"image/bmp",coffee:"text/coffeescript",css:"text/css",csv:"text/csv",doc:"application/msword",docx:"application/msword",dtd:"application/xml-dtd",eps:"application/postscript",exe:"application/octet-stream",geojson:"application/json",gif:"image/gif",gzip:"application/x-gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",ifb:"text/calendar",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",less:"text/css",m4a:"audio/mp4a-latm",m4v:"video/x-m4v",manifest:"text/cache-manifest",md:"text/x-markdown",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",mtl:"text/plain",mv4:"video/mv4",obj:"text/plain",ogg:"application/ogg","package":"text/plain",pdf:"application/pdf",png:"image/png",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.ms-powerpoint",ps:"application/postscript",rar:"application/x-rar-compressed",rtf:"text/rtf",sass:"text/css",scss:"text/css",sh:"application/x-sh",stl:"application/sla",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",webp:"image/webp",woff:"application/font-woff",woff2:"application/font-woff2",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",zip:"application/zip"};typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)});var hasOwnProperty=Object.prototype.hasOwnProperty;return global.expression=expression,exports.isEmpty=function(e){if(null===e)return!0;if(e.length)return!1;if(0===e.length)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},exports.isEqual=function(e,t,r){for(var n=r?r:Object.keys(e),o=0,i=n.length;i>o;o++){var s=n[o];if(e[s]!==t[s])return!1}return!0},exports.wait=function(e,t,r,n){if(e()===!0)return t(null,!0);var o=null,i=setInterval(function(){return e()===!0?(clearInterval(i),clearTimeout(o),void(t&&t(null,!0))):void 0},n||500);o=setTimeout(function(){clearInterval(i),t&&t(new Error("Timeout."),!1)},r||5e3)},exports.$$wait=function(e,t,r){return function(n){exports.wait(e,n,t,r)}},exports.resolve=function(e,t){var r=parser.parse(e);return dnscache[r.host]?(r.host=dnscache[r.host],void t(null,r)):void Dns.resolve4(r.hostname,function(e,n){return e?void setImmediate(function(){Dns.resolve4(r.hostname,function(e,n){return e?t(e,r):(dnscache[r.host]=n[0],r.host=n[0],void t(null,r))})}):(dnscache[r.host]=n[0],r.host=n[0],void t(null,r))})},exports.$$resolve=function(e){return function(t){return exports.resolve(e,t)}},exports.clearDNS=function(){dnscache={}},exports.request=function(e,t,r,n,o,i,s,a){typeof r===FUNCTION&&(a=s,s=i,i=o,o=n,n=r,r=""),typeof o===NUMBER&&(o=null,a=o),typeof i===NUMBER&&(i=null,a=i),typeof s===NUMBER&&(s=null,a=s);var u="GET",c=0,l=0,p=new events.EventEmitter,f=!1;if(i=i?exports.extend({},i):{},typeof s!==STRING&&(s=ENCODING),null===r&&(r=""),t instanceof Array){c=t.length;for(var d=0;c>d;d++)switch(t[d].toLowerCase()){case"xhr":i["X-Requested-With"]="XMLHttpRequest";break;case"json":i["Content-Type"]="application/json",""===u&&(u="POST"),l=1;break;case"xml":i["Content-Type"]="text/xml",""===u&&(u="POST"),l=2;break;case"get":case"delete":case"options":case"head":u=t[d].toUpperCase();break;case"upload":i["Content-Type"]="multipart/form-data";break;case"post":case"put":u=t[d].toUpperCase(),i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded");break;case"dnscache":f=!0}}var m="POST"===u||"PUT"===u;typeof r!==STRING?r=1===l?JSON.stringify(r):qs.stringify(r):"?"===r[0]&&(r=r.substring(1)),m||(r.length&&-1===e.indexOf("?")&&(e+="?"+r),r="");var h=parser.parse(e),g=0;if(h.method=u,i["X-Powered-By"]="total.js"+VERSION,o){var v="";for(var y in o)v+=(v?"; ":"")+y+"="+encodeURIComponent(o[y]);v&&(i.Cookie=v)}var b;r.length&&(b=new Buffer(r,ENCODING),i["Content-Length"]=b.length),h.agent=!1,h.headers=i;var w=function(e){return e._buffer="",e._bufferlength=0,301===e.statusCode?(exports.request(e.headers.location,t,r,n,o,i,s,a),void(e=null)):(e.on("data",function(e){var t=this;t._buffer+=e.toString(s),t._bufferlength+=e.length,p.emit("data",e,g?t._bufferlength/g*100:0)}),e.on("end",function(){var e=this;p.emit("end",e._buffer,e.statusCode,e.headers,h.host),n&&n(null,e._buffer,e.statusCode,e.headers,h.host),n=null}),void e.resume())},k="https:"===h.protocol?https:http,E=function(){try{var e=m?k.request(h,w):k.get(h,w);n&&(e.on("error",function(e){n&&n(e,void 0,0,void 0,void 0,h.host),n=null}),e.setTimeout(a||1e4,function(){n&&n(new Error(exports.httpStatus(408)),void 0,0,void 0,h.host),n=null})),e.on("response",function(e){g=parseInt(e.headers["content-length"])||0,p.emit("begin",g)}),m&&b?e.end(b):e.end()}catch(t){n&&n(t,void 0,0)}};return f?exports.resolve(e,function(e,t){h.host=t.host,E()}):E(),p},exports.$$request=function(e,t,r,n,o,i,s){return function(a){exports.request(e,t,r,a,n,o,i,s)}},exports.download=function(e,t,r,n,o,i,s,a){typeof r===FUNCTION&&(a=s,s=i,i=o,o=n,n=r,r=""),typeof o===NUMBER&&(o=null,a=o),typeof i===NUMBER&&(i=null,a=i),typeof s===NUMBER&&(s=null,a=s);var u="GET",c=0,l=0,p=new events.EventEmitter,f=!1;if(i=i?exports.extend({},i):{},typeof s!==STRING&&(s=ENCODING),null===r&&(r=""),t instanceof Array){c=t.length;for(var d=0;c>d;d++)switch(t[d].toLowerCase()){case"xhr":i["X-Requested-With"]="XMLHttpRequest";break;case"json":i["Content-Type"]="application/json",l=1;break;case"xml":i["Content-Type"]="text/xml",l=2;break;case"get":case"delete":case"options":u=t[d].toUpperCase();break;case"upload":i["Content-Type"]="multipart/form-data";break;case"post":case"put":u=t[d].toUpperCase(),i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded");break;case"dnscache":f=!0}}var m="POST"===u||"PUT"===u;typeof r!==STRING?r=1===l?JSON.stringify(r):qs.stringify(r):"?"===r[0]&&(r=r.substring(1)),m||(r.length&&-1===e.indexOf("?")&&(e+="?"+r),r="");var h=parser.parse(e),g=0;if(h.method=u,i["X-Powered-By"]="total.js"+VERSION,o){var v="";for(var y in o)v+=(v?"; ":"")+y+"="+encodeURIComponent(o[y]);v&&(i.Cookie=v)}var b;r.length&&(b=new Buffer(r,ENCODING),i["Content-Length"]=b.length),h.agent=!1,h.headers=i;var w=function(e){e._bufferlength=0,e.on("data",function(e){var t=this;t._bufferlength+=e.length,p.emit("data",e,g?t._bufferlength/g*100:0)}),e.on("end",function(){var e=this;p.emit("end",e.statusCode,e.headers)}),n(null,e),e.resume()},k="https:"===h.protocol?https:http,E=function(){try{var e=m?k.request(h,w):k.request(h,w);n&&(e.on("error",function(e){n(e,null,0,{})}),e.setTimeout(a||1e4,function(){n(new Error(exports.httpStatus(408)),null,0,null)})),e.on("response",function(e){g=parseInt(e.headers["content-length"])||0,p.emit("begin",g)}),m&&b?e.end(b):e.end()}catch(t){n&&n(t,null,0,{})}};return f?exports.resolve(e,function(e,t){h.host=t.host,E()}):E(),p},exports.$$download=function(e,t,r,n,o,i,s){return function(a){exports.download(e,t,r,a,n,o,i,s)}},exports.send=function(e,t,r,n,o,i){if(typeof n===OBJECT){var s=o;n=o,o=s}typeof t===STRING&&(t=fs.createReadStream(t,{flags:"r"}));var a="----"+Math.random().toString(16).substring(2),u={};o&&util._extend(u,o),e=path.basename(e),u["Cache-Control"]="max-age=0",u["Content-Type"]="multipart/form-data; boundary="+a,u["X-Powered-By"]="total.js"+VERSION;var c=parser.parse(r),l={protocol:c.protocol,auth:c.auth,method:i||"POST",hostname:c.hostname,port:c.port,path:c.path,agent:!1,headers:u},p=function(e){n&&(e.body="",e.on("data",function(e){this.body+=e.toString(ENCODING)}),e.on("end",function(){var e=this;n&&n(null,e.body,e.statusCode,e.headers)}))},f="https:"===l.protocol?https:http,d=f.request(l,p);n&&d.on("error",function(e){n&&n(e,null,0,null),n=null});var m=NEWLINE+NEWLINE+"--"+a+NEWLINE+'Content-Disposition: form-data; name="File"; filename="'+e+'"'+NEWLINE+"Content-Type: "+exports.getContentType(path.extname(e))+NEWLINE+NEWLINE;return d.write(m),typeof t.length===NUMBER?void d.end(t.toString("utf8")+NEWLINE+NEWLINE+"--"+a+"--"):(t.on("end",function(){d.end(NEWLINE+NEWLINE+"--"+a+"--")}),void t.pipe(d,{end:!1}))},exports.$$send=function(e,t,r,n,o){return function(i){exports.send(e,t,r,i,n,o)}},exports.trim=function(e){if(void 0===e||null===e)return e;var t=typeof e;if(t===STRING)return e.trim();if(e instanceof Array){for(var r=0,n=e.length;n>r;r++){var o=e[r];t=typeof o,t!==OBJECT?t===STRING&&(e[r]=o.trim()):exports.trim(o)}return e}return t!==OBJECT?e:(Object.keys(e).forEach(function(t){var r=e[t],n=typeof r;return n===OBJECT?void exports.trim(r):void(n===STRING&&(e[t]=r.trim()))}),e)},exports.noop=global.noop=global.NOOP=function(){},exports.httpStatus=function(e,t){return void 0===t&&(t=!0),(t?e+": ":"")+http.STATUS_CODES[e]},exports.extend=function(e,t,r){if(null===e||null===t)return e;if(typeof e!==OBJECT||typeof t!==OBJECT)return e;void 0===r&&(r=!0);for(var n=Object.keys(t),o=n.length;o--;){var i=n[o];(r||void 0===e[i])&&(e[i]=t[i])}return e},exports.copy=function(e,t){if(void 0===t)return exports.extend({},e,!0);if(null===t||null===e)return t;if(typeof t!==OBJECT||typeof e!==OBJECT)return t;for(var r=Object.keys(e),n=r.length;n--;){var o=r[n];void 0!==t[o]&&(t[o]=e[o])}return t},exports.reduce=function(e,t,r){if(!(t instanceof Array)&&typeof t===OBJECT)return exports.reduce(e,Object.keys(t),r);var n={};return Object.keys(e).forEach(function(o){r?-1===t.indexOf(o)&&(n[o]=e[o]):-1!==t.indexOf(o)&&(n[o]=e[o])}),n},exports.assign=function(e,t,r){if(null===e||void 0===e)return e;for(var n=t.split("."),o=e[n[0]],i=1;i<n.length-1;i++)o=o[n[i]];return o[n[n.length-1]]=typeof r===FUNCTION?r(o[n[n.length-1]]):r,e},exports.isRelative=function(e){return!("//"===e.substring(0,2)||-1!==e.indexOf("http://")||-1!==e.indexOf("https://"))},exports.streamer=function(e,t){var r="",n=e.length,o=0;return function(i){if(i){"string"!=typeof i&&(i=i.toString("utf8")),r+=i;var s=r.indexOf(e);if(-1!==s)for(;-1!==s;)if(t(r.substring(0,s+n),o++),r=r.substring(s+n),s=r.indexOf(e),-1===s)return}}},exports.encode=function(e){if(void 0===e)return"";var t=typeof e;return t!==STRING&&(e=e.toString()),e.encode()},exports.decode=function(e){if(void 0===e)return"";var t=typeof e;return t!==STRING&&(e=e.toString()),e.decode()},exports.isStaticFile=function(e){return regexpSTATIC.test(e)},exports.isNullOrEmpty=function(e){return typeof e!==STRING?!0:0===e.length},exports.parseInt=function(e,t){if(void 0===e||null===e)return t||0;var r=typeof e;if(r===NUMBER)return e;var n=r!==STRING?e.toString():e;return n.parseInt(t,10)},exports.parseFloat=function(e,t){if(void 0===e||null===e)return t||0;var r=typeof e;if(r===NUMBER)return e;var n=r!==STRING?e.toString():e;return n.parseFloat(t)},exports.isArray=function(e){return e instanceof Array},exports.isRegExp=function(e){return util.isRegExp(e)},exports.isDate=function(e){return util.isDate(e)},exports.isObject=function(e){try{return e&&Object.getPrototypeOf(e)===Object.prototype?!0:!1}catch(t){return!1}},exports.getContentType=function(e){return"."===e[0]&&(e=e.substring(1)),contentTypes[e.toLowerCase()]||"application/octet-stream"},exports.setContentType=function(e,t){return"."===e[0]&&(e=e.substring(1)),contentTypes[e.toLowerCase()]=t,!0},exports.etag=function(e,t){for(var r=0,n=e.length,o=0;n>o;o++)r+=e.charCodeAt(o);return r.toString()+(t?":"+t:"")},exports.path=function(e,t){return e||(e=""),t=t||"/",e[e.length-1]===t?e:e+t},exports.random=function(e,t){return e=e||1e5,t=t||0,Math.floor(Math.random()*(e-t+1))+t},exports.GUID=function(e){e=e||40;for(var t=function(){return Math.floor(65536*Math.random()).toString(16)},r="",n=0;e/4+1>n;n++)r+=t();return r.substring(0,e)},exports.validate=function(e,t,r,n,o,i,s,a){typeof n===FUNCTION&&void 0===o&&(o=n,n=null);var u=!1;void 0===s&&(u=!0,s={});var c,l=n,p=void 0===i?"":i+".",f=!1,d="",m=null;if(l instanceof builders.ErrorBuilder||(l=new builders.ErrorBuilder(o)),typeof t===STRING)if(c=void 0===s?builders.validation(t):void 0===s[t]?"":s[t].properties,0!==c.length)d=t,t=c,f=!0,m=void 0===s?builders.schema("default").collection:s,m||(m={});else{if(!u)return l;t=t.replace(/\s/g,"").split(",")}if((void 0===e||null===e)&&(e={}),typeof r!==FUNCTION)throw new Error("The validate function does not have any method to validate properties.\nYou must define the delegate: framework.onValidate ...");for(var h=0;h<t.length;h++){var g=t[h].toString(),v=e[g],y=typeof v;if(void 0!==v){if(y===FUNCTION&&(v=e[g]()),y!==OBJECT&&f&&builders.isJoin(s,g)&&(y=OBJECT),y===OBJECT&&!exports.isDate(v)&&f&&(c=s[d]))if(c=c.schema[g]||null,c===Date||c===String||c===Number||c===Boolean);else if(null!==c&&typeof c===STRING){var b="["===c[0];if(!b){exports.validate(v,c,r,l,o,p+g,s);continue}if(c=c.substring(1,c.length-1).trim(),!(v instanceof Array)){l.add(g,"@",p+g,a);continue}if(void 0===s[c]){var w=r(g,v,p+g,d,e);if(void 0===w)continue;if(y=typeof w,y===STRING){l.add(g,w,p+g,a);continue}if(y===BOOLEAN&&!w){l.add(g,"@",p+g,a);continue}w.isValid===!1&&l.add(g,w.error,p+g,a);continue}var k=r(g,v,p+g,d,e);if(void 0!==k){if(y=typeof k,y===STRING){l.add(g,k,p+g,a);continue}if(y===BOOLEAN&&!k){l.add(g,"@",p+g,a);continue}if(k.isValid===!1){l.add(g,k.error,p+g,a);continue}}for(var E=v.length,S=0;E>S;S++)exports.validate(v[S],c,r,l,o,p+g,s,S);continue}var T=r(g,v,p+g,d,e);void 0!==T&&(y=typeof T,y!==STRING?y!==BOOLEAN?T.isValid===!1&&l.add(g,T.error,p+g,a):T||l.add(g,"@",p+g,a):l.add(g,T,p+g,a))}else l.add(g,"@",p+g)}return l},exports.validate_builder=function(e,t,r,n,o,i){var s=n[r],a=s.onValidation||framework.onValidation,u=void 0===o?"":o+".",c=s.properties;if((void 0===e||null===e)&&(e={}),typeof a!==FUNCTION)throw new Error("It's not defined onValidation delegate.");for(var l=0;l<c.length;l++){var p=c[l].toString(),f=e[p],d=typeof f;if(void 0!==f){if(d===FUNCTION&&(f=e[p]()),d!==OBJECT&&builders.isJoin(n,p)&&(d=OBJECT),d===OBJECT&&!exports.isDate(f)&&(s=n[r]))if(s=s.schema[p]||null,s===Date||s===String||s===Number||s===Boolean);else if(null!==s&&typeof s===STRING){var m="["===s[0];if(!m){exports.validate_builder(f,t,r,n,u+p,i);continue}if(s=s.substring(1,s.length-1).trim(),!(f instanceof Array)){t.add(p,"@",u+p,i);continue}if(void 0===n[s]){var h=a(p,f,u+p,e,r);if(void 0===h)continue;if(d=typeof h,d===STRING){t.add(p,h,u+p,i);continue}if(d===BOOLEAN&&!h){t.add(p,"@",u+p,i);continue}h.isValid===!1&&t.add(p,h.error,u+p,i);continue}var g=a(p,f,u+p,e,r);if(void 0!==g){if(d=typeof g,d===STRING){t.add(p,g,u+p,i);continue}if(d===BOOLEAN&&!g){t.add(p,"@",u+p,i);continue}if(g.isValid===!1){t.add(p,g.error,u+p,i);continue}}for(var v=f.length,y=0;v>y;y++)exports.validate_builder(f[y],t,s,n,u+p,y);continue}var b=a(p,f,u+p,e,r);void 0!==b&&(d=typeof b,d!==STRING?d!==BOOLEAN?b.isValid===!1&&t.add(p,b.error,u+p,i):b||t.add(p,"@",u+p,i):t.add(p,b,u+p,i))}else t.add(p,"@",u+p)}return t},exports.isValid=function(e,t){return{isValid:e,error:t||"@"}},exports.isEmail=function(e){return(e||"").toString().isEmail()},exports.isURL=function(e){return(e||"").toString().isURL()},exports.combine=function(){var e,t=this;return"~"===arguments[0][0]?(arguments[0]=arguments[0].substring(1),e=path.join.apply(t,arguments),framework.isWindows?e.replace(/\\/g,"/"):e):(e=path.join.apply(t,arguments),framework.isWindows?"."+e.replace(/\\/g,"/"):"."+e)},exports.removeDiacritics=function(e){for(var t="",r=0,n=e.length;n>r;r++){var o=e[r],i=o.charCodeAt(0),s=!1,a=DIACRITICS[i];void 0===a&&(i=o.toLowerCase().charCodeAt(0),a=DIACRITICS[i],s=!0),void 0!==a?(o=a,s&&(o=o.toUpperCase()),t+=o):t+=o}return t},exports.parseXML=function(e){for(var t=-1,r=0,n=0,o=[],i={},s=-1;;){if(t=e.indexOf("<",t+1),-1===t)break;if(r=e.indexOf(">",t+1),-1===r)break;var a=e.substring(t,r+1),u=a[1];if("?"!==u&&"/"!==u){n=a.indexOf(" ");var c=!0;-1===n&&(n=a.length-1,c=!1),s=t+a.length;var l="/"===a[a.length-2],p=a.substring(1,n);if(l||o.push(p),c){var f=a.match(/\w+\=\".*?\"/g);if(null!==f){for(var d={},m=f.length,h=0;m>h;h++){var g=f[h].indexOf('"');d[f[h].substring(0,g-1)]=f[h].substring(g+1,f[h].length-1).decode()}i[o.join(".")+(l?"."+p:"")+"[]"]=d}}}else{var v=o.pop();if(-1===s||v!==a.substring(2,a.length-1))continue;var y=(o.length?o.join(".")+".":"")+v,b=e.substring(s,t).decode();void 0===i[y]?i[y]=b:i[y]instanceof Array?i[y].push(b):i[y]=[i[y],b],s=-1}}return i},exports.parseJSON=function(e){try{return JSON.parse(e)}catch(t){return null}},exports.getWebSocketFrame=function(e,t,r){var n=getWebSocketFrameMessageBytes(e,t),o=n.length,i=getWebSocketFrameLengthBytes(o),s=new Buffer(1+i.length+o);return s[0]=128|r,i.copy(s,1,0,i.length),n.copy(s,i.length+1,0,o),s},exports.distance=function(e,t,r,n){var o=6371,i=(r-e).toRad(),s=(n-t).toRad(),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.toRad())*Math.cos(r.toRad())*Math.sin(s/2)*Math.sin(s/2),u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return(o*u).floor(3)},exports.ls=function(e,t,r){var n=new FileList;n.onComplete=t,n.onFilter=r||null,n.walk(e)},Date.prototype.add=function(e,t){if(void 0===t){var r=e.split(" ");e=r[1],t=exports.parseInt(r[0])}var n=this,o=new Date(n.getTime());switch(e){case"s":case"ss":case"sec":case"second":case"seconds":return o.setSeconds(o.getSeconds()+t),o;case"m":case"mm":case"minute":case"min":case"minutes":return o.setMinutes(o.getMinutes()+t),o;case"h":case"hh":case"hour":case"hours":return o.setHours(o.getHours()+t),o;case"d":case"dd":case"day":case"days":return o.setDate(o.getDate()+t),o;case"M":case"MM":case"month":case"months":return o.setMonth(o.getMonth()+t),o;case"y":case"yyyy":case"year":case"years":return o.setFullYear(o.getFullYear()+t),o}return o},Date.prototype.diff=function(e,t){if(1===arguments.length)t=e,e=Date.now();else{var r=typeof e;r===STRING?e=Date.parse(e):util.isDate(e)&&(e=e.getTime())}var n=this.getTime()-e;switch(t){case"s":case"ss":case"second":case"seconds":return Math.round(n/1e3);case"m":case"mm":case"minute":case"minutes":return Math.round(n/1e3/60);case"h":case"hh":case"hour":case"hours":return Math.round(n/1e3/60/60);case"d":case"dd":case"day":case"days":return Math.round(n/1e3/60/60/24);case"M":case"MM":case"month":case"months":return Math.round(n/1e3/60/60/672);case"y":case"yyyy":case"year":case"years":return Math.round(n/1e3/60/60/8064)}},Date.prototype.extend=function(e){var t=new Date(this),r=e.match(regexpDATE);if(!r)return t;for(var n=0,o=r.length;o>n;n++){var i,s,a=r[n];-1===a.indexOf(":")?-1===a.indexOf("-")?-1===a.indexOf(".")||(i=a.split("."),s=parseInt(i[0],10),t.setDate(s),i[1]&&(s=parseInt(i[1],10),isNaN(s)||t.setMonth(s-1)),i[2]&&(s=parseInt(i[2]),isNaN(s)||t.setFullYear(s))):(i=a.split("-"),s=parseInt(i[0]),t.setFullYear(s),i[1]&&(s=parseInt(i[1],10),isNaN(s)||t.setMonth(s-1)),i[2]&&(s=parseInt(i[2],10),isNaN(s)||t.setDate(s))):(i=a.split(":"),s=parseInt(i[0],10),isNaN(s)||t.setHours(s),i[1]&&(s=parseInt(i[1],10),isNaN(s)||t.setMinutes(s)),i[2]&&(s=parseInt(i[2],10),isNaN(s)||t.setSeconds(s)))}return t},Date.prototype.compare=function(e){var t=this,r=t.getTime()-e.getTime();return 0===r?0:0>r?-1:1},Date.compare=function(e,t){return typeof e===STRING&&(e=e.parseDate()),typeof t===STRING&&(t=t.parseDate()),e.compare(t)},Date.prototype.format=function(e){var t=this,r=!1;if(e&&"!"===e[0]&&(r=!0,e=e.substring(1)),void 0===e||null===e||""===e)return t.getFullYear()+"-"+(t.getMonth()+1).toString().padLeft(2,"0")+"-"+t.getDate().toString().padLeft(2,"0")+"T"+t.getHours().toString().padLeft(2,"0")+":"+t.getMinutes().toString().padLeft(2,"0")+":"+t.getSeconds().toString().padLeft(2,"0")+":"+t.getMilliseconds().toString();var n=t.getHours();return r&&n>=12&&(n-=12),e.replace(regexpDATEFORMAT,function(e){switch(e){case"yyyy":return t.getFullYear();case"yy":return t.getYear();case"MM":return(t.getMonth()+1).toString().padLeft(2,"0");case"M":return t.getMonth()+1;case"dd":return t.getDate().toString().padLeft(2,"0");case"d":return t.getDate();case"HH":case"hh":return n.toString().padLeft(2,"0");case"H":case"h":return t.getHours();case"mm":return t.getMinutes().toString().padLeft(2,"0");case"m":return t.getMinutes();case"ss":return t.getSeconds().toString().padLeft(2,"0");case"s":return t.getSeconds();case"a":var r="AM";return t.getHours()>=12&&(r="PM"),r}})},Date.prototype.toUTC=function(e){var t=this.getTime()+6e4*this.getTimezoneOffset();return e?t:new Date(t)},String.prototype.trim||(String.prototype.trim=function(){return this.replace(regexpTRIM,"")}),String.prototype.replaceAt||(String.prototype.replaceAt=function(e,t){var r=this;return r.substr(0,e)+t+r.substr(e+t.length)}),String.prototype.startsWith=function(e,t){var r=this,n=e.length,o=r.substring(0,n);return t?o.length===n&&o.toLowerCase()===e.toLowerCase():o.length===n&&o===e},String.prototype.endsWith=function(e,t){var r=this,n=e.length,o=r.substring(r.length-n);return t?o.length===n&&o.toLowerCase()===e.toLowerCase():o.length===n&&o===e},String.prototype.replacer=function(e,t){var r=this,n=r.indexOf(e);return-1===n?r:r.substring(0,n)+t+r.substring(n+e.length)},String.prototype.hash=function(e,t){var r=this;switch(t&&(r+=t),(e||"").toLowerCase()){case"md5":return r.md5();case"sha1":return r.sha1();case"sha256":return r.sha256();case"sha512":return r.sha512();default:return string_hash(r)}},String.prototype.count=function(e){var t=0,r=0;do t=this.indexOf(e,t+e.length),t>0&&r++;while(t>0);return r},String.prototype.parseXML=function(){return exports.parseXML(this)},String.prototype.parseJSON=function(){return exports.parseJSON(this)},String.prototype.parseDate=function(){var e=this.trim(),t=e.split(-1===e.indexOf(" ")?"T":" "),r=t[0].indexOf(":"),n=t[0].length;if(-1!==r){var o=t[1];t[1]=t[0],t[0]=o}void 0===t[0]&&(t[0]="");for(var i=void 0===t[1]?!0:0===t[1].length,s=0;n>s;s++){var a=t[0].charCodeAt(s);if(!(a>47&&58>a)&&45!==a&&46!==a&&i)return new Date(e)}void 0===t[1]&&(t[1]="00:00:00");var u=-1===t[0].indexOf("-"),c=(t[0]||"").split(u?".":"-"),l=(t[1]||"").split(":"),p=[];if(c.length<4&&l.length<2)return new Date(e);r=(l[2]||"").indexOf("."),-1!==r?(l[3]=l[2].substring(r+1),l[2]=l[2].substring(0,r)):l[3]="0",p.push(parseInt(c[u?2:0],10)),p.push(parseInt(c[1],10)),p.push(parseInt(c[u?0:2],10)),p.push(parseInt(l[0],10)),p.push(parseInt(l[1],10)),p.push(parseInt(l[2],10)),p.push(parseInt(l[3],10));for(var f=new Date,s=0,n=p.length;n>s;s++){isNaN(p[s])&&(p[s]=0);var d=p[s];if(0===d)switch(s){case 0:0>=d&&(p[s]=f.getFullYear());break;case 1:0>=d&&(p[s]=f.getMonth()+1);break;case 2:0>=d&&(p[s]=f.getDate())}}return new Date(p[0],p[1]-1,p[2],p[3],p[4],p[5])},String.prototype.parseDateExpiration=function(){for(var e=this,t=e.split(" "),r=new Date,n=t.length,o=0;n>o;o+=2){var i=t[o].parseInt();if(0!==i){var s=t[o+1]||"";""!==s&&(r=r.add(s,i))}}return r},String.prototype.contains=function(e,t){var r=this;if(typeof e===STRING)return-1!==r.indexOf(e,typeof t===NUMBER?t:0);for(var n=e.length,o=0;n>o;o++){var i=-1!==r.indexOf(e[o]);if(t){if(!i)return!1}else if(i)return!0}return t},String.prototype.configuration=function(e){return console.log("OBSOLETE: String.configuration() -> use String.parseConfig([default])"),this.parseConfig(e)},String.prototype.parseConfig=function(e){for(var t=this.split("\n"),r=t.length,n=exports.extend({},e),o=0;r>o;o++){var i=t[o];if(""!==i&&"#"!==i[0]&&"//"!==i.substring(0,2)){var s=i.indexOf(" :");(-1!==s||(s=i.indexOf("	:"),-1!==s))&&(n[i.substring(0,s).trim()]=i.substring(s+2).trim())}}return n},String.prototype.format=function(){var e=arguments;return this.replace(regexpSTRINGFORMAT,function(t){var r=e[parseInt(t.substring(1,t.length-1))];return(null===r||void 0===r)&&(r=""),r})},String.prototype.encode=function(){for(var e="",t=0,r=this.length;r>t;t++){var n=this[t];switch(n){case"<":e+="&lt;";break;case">":e+="&gt;";break;case'"':e+="&quot;";break;case"'":e+="&apos;";break;case"&":e+="&amp;";break;default:e+=n}}return e},String.prototype.decode=function(){return this.replace(/&gt;/g,">").replace(/\&lt;/g,"<").replace(/\&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&")},String.prototype.urlEncode=function(){return encodeURIComponent(this)},String.prototype.urlDecode=function(){return decodeURIComponent(this)
},String.prototype.params=function(e){var t=this;if(void 0===e||null===e)return t;var r=/\{{2}[^}\n]*\}{2}/g;return t.replace(r,function(t){var r=!1,n=t.substring(2,t.length-2).trim(),o="",i=n.indexOf("|");-1!==i&&(o=n.substring(i+1,n.length).trim(),n=n.substring(0,i).trim()),"!"===n[0]?n=n.substring(1):r=!0;var s;if(-1!==n.indexOf(".")){var a=n.split(".");2===a.length?e[a[0]]&&(s=e[a[0]][a[1]]):3===a.length?e[a[0]]&&e[a[0]][a[1]]&&(s=e[a[0]][a[1]][a[2]]):4===a.length&&(e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]?s=e[a[0]][a[1]][a[2]][a[3]]:5===a.length&&e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]&&e[a[0]][a[1]][a[2]][a[3]]&&(s=e[a[0]][a[1]][a[2]][a[3]][a[4]]))}else s=0===n.length?e:e[n];if(typeof s===FUNCTION&&(s=s(i)),void 0===s)return t;if(o.length){var u=typeof s;if(u===STRING){var c=parseInt(o,10);isNaN(c)||(s=s.max(c+3,"..."))}else(u===NUMBER||util.isDate(s))&&(o.isNumber()&&(o=parseInt(o)),s=s.format(o))}return s=s.toString().dollar(),r?exports.encode(s):s})},String.prototype.max=function(e,t){var r=this;return typeof t!==STRING&&(t="..."),r.length>e?r.substring(0,e-t.length)+t:r},String.prototype.isJSON=function(){var e=this;if(e.length<=1)return!1;var t=e[0],r=e[e.length-1];return'"'===t&&'"'===r||"["===t&&"]"===r||"{"===t&&"}"===r},String.prototype.isURL=function(){var e=this;return e.length<=7?!1:regexpUrl.test(e)},String.prototype.isEmail=function(){var e=this;return e.length<=4?!1:"."===e[0]||"."===e[e.length-1]?!1:regexpMail.test(e)},String.prototype.parseInt=function(e){var t=0,r=this;return t="0"===r.substring(0,1)?parseInt(r.replace(/\s/g,"").substring(1),10):parseInt(r.replace(/\s/g,""),10),isNaN(t)?e||0:t},String.prototype.parseBool=function(){var e=this.toLowerCase();return"true"===e||"1"===e||"on"===e},String.prototype.parseBoolean=function(){return this.parseBool()},String.prototype.parseFloat=function(e){var t=0,r=this;return t=parseFloat("0"===r.substring(0,1)?r.replace(/\s/g,"").substring(1).replace(",","."):r.replace(/\s/g,"").replace(",",".")),isNaN(t)?e||0:t},String.prototype.toUnicode=function(){for(var e="",t=this,r=t.length,n=0;r>n;++n)e+=t.charCodeAt(n)>126||t.charCodeAt(n)<32?"\\u"+t.charCodeAt(n).hex(4):t[n];return e},String.prototype.fromUnicode=function(){var e=this.replace(/\\u([\d\w]{4})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))});return unescape(e)},String.prototype.sha1=function(e){var t=crypto.createHash("sha1");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.sha256=function(e){var t=crypto.createHash("sha256");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.sha512=function(e){var t=crypto.createHash("sha512");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.md5=function(e){var t=crypto.createHash("md5");return t.update(this+(e||""),ENCODING),t.digest("hex")},String.prototype.toSearch=function(){return this.replace(/[^a-zA-ZÃ¡-Å¾Ã-Å½\d\s:]/g,"").trim().replace(/\s{2,}/g," ").toLowerCase().removeDiacritics().replace(/y/g,"i")},String.prototype.encrypt=function(e,t){var r="0"+this,n=r.length,o=e.length,i=t?exports.random(120)+40:65,s=n+i%o,a=[],u=0;a[0]=String.fromCharCode(i);for(var c=this.length+e.length,l=s-1;l>0;l--)u=r.charCodeAt(l%n),a[l]=String.fromCharCode(u^(e.charCodeAt(l%o)^i));var p=new Buffer(c+"="+a.join(""),ENCODING).toString("base64").replace(/\//g,"-").replace(/\+/g,"_");return u=p.indexOf("="),u>0?p.substring(0,u):p},String.prototype.decrypt=function(e){var t=this.replace(/\-/g,"/").replace(/\_/g,"+"),r=t.length%4;if(r>0)for(var n=0;r>n;n++)t+="=";t=new Buffer(t,"base64").toString(ENCODING);var o=t.indexOf("=");if(-1===o)return null;var i=parseInt(t.substring(0,o),10);if(isNaN(i))return null;t=t.substring(o+1);for(var s=t.length,a=t.charCodeAt(0),u=e.length,c=s-a%u,l=[],n=c-1;n>0;n--)o=t.charCodeAt(n)^(a^e.charCodeAt(n%u)),l[n]=String.fromCharCode(o);var p=l.join("");return i!==p.length+e.length?null:p},String.prototype.base64ToFile=function(e,t){var r=this,n=r.indexOf(",");return-1===n?n=0:n++,t?fs.writeFile(e,r.substring(n),"base64",t):fs.writeFile(e,r.substring(n),"base64",exports.noop),this},String.prototype.base64ToBuffer=function(){var e=this,t=e.indexOf(",");return-1===t?t=0:t++,new Buffer(e.substring(t),"base64")},String.prototype.base64ContentType=function(){var e=this,t=e.indexOf(";");return-1===t?"":e.substring(5,t)},String.prototype.removeDiacritics=function(){return exports.removeDiacritics(this)},String.prototype.indent=function(e,t){var r=this;return new Array(e+1).join(t||" ")+r},String.prototype.isNumber=function(e){var t=this,r=t.length;if(0===r)return!1;e=e||!1;for(var n=0;r>n;n++){var o=t.charCodeAt(n);if(!e||44!==o&&46!==o){if(48>o||o>57)return!1}else e=!1}return!0},String.prototype.padLeft||(String.prototype.padLeft=function(e,t){var r=this;return new Array(Math.max(0,e-r.length+1)).join(t||" ")+r}),String.prototype.padRight||(String.prototype.padRight=function(e,t){var r=this;return r+new Array(Math.max(0,e-r.length+1)).join(t||" ")}),String.prototype.insert=function(e,t){var r=this,n=r.substring(0,e),o=t.toString()+r.substring(e);return n+o},String.prototype.dollar=function(){for(var e=this,t=e.indexOf("$",0);-1!==t;)"$"===e[t+1]&&(e=e.insert(t,"$")),t=e.indexOf("$",t+2);return e.toString()},String.prototype.slug=String.prototype.toSlug=String.prototype.toLinker=String.prototype.linker=function(e){e=e||60;for(var t=this.trim().toLowerCase().removeDiacritics(),r="",n=t.length,o=0;n>o;o++){var i=t[o],s=t.charCodeAt(o);if(r.length>=e)break;if(s>31&&48>s){if("-"===r[r.length-1])continue;r+="-"}else s>47&&58>s?r+=i:s>94&&123>s&&(r+=i)}var a=r.length-1;return"-"===r[a]?r.substring(0,a):r},String.prototype.link=function(e){return console.log("String.prototype.link: OBSOLETE - Use String.prototype.linker()"),this.linker(e)},String.prototype.pluralize=function(e,t,r,n){var o=this;return o.parseInt().pluralize(e,t,r,n)},String.prototype.isBoolean=function(){var e=this.toLowerCase();return"true"===e||"false"===e?!0:!1},String.prototype.capitalize=function(){return this[0].toUpperCase()+this.substring(1)},String.prototype.isAlphaNumeric=function(){var e=/^[A-Za-z0-9]+$/;return this.match(e)?!0:!1},Number.prototype.floor=function(e){return Math.floor(this*Math.pow(10,e))/Math.pow(10,e)},Number.prototype.padLeft=function(e,t){return this.toString().padLeft(e,t||"0")},Number.prototype.padRight=function(e,t){return this.toString().padRight(e,t||"0")},Number.prototype.format=function(e,t,r){var n=this;if(typeof e===STRING)return n.format2(e);var o=n.toString(),i="",s="",a="-"===o[0]?"-":"";a&&(o=o.substring(1));var u=o.indexOf(".");if(typeof e===STRING){var c=t;t=e,e=c}void 0===t&&(t=" "),-1!==u&&(i=o.substring(u+1),o=o.substring(0,u)),u=-1;for(var l=o.length-1;l>=0;l--)u++,u>0&&u%3===0&&(s=t+s),s=o[l]+s;return(e||i.length)&&(i=i.length>e?i.substring(0,e):i.padRight(e,"0")),i.length&&void 0===r&&(r="."===t?",":"."),a+s+(i.length?r+i:"")},Number.prototype.add=function(e,t){if(void 0===e||null===e)return this;if(typeof e===NUMBER)return this+e;var r=e.charCodeAt(0),n=!1;(48>r||r>57)&&(n=!0,e=e.substring(1));var o,i=e.length,s=!1;if("%"===e[i-1]){if(e=e.substring(0,i-1),s=!0,n){var a=e.parseFloat()/100+1;switch(r){case 42:o=this*this*a;break;case 43:o=this*a;break;case 45:o=this/a;break;case 47:o=this/(this/a)}return void 0!==t?o.floor(t):o}return o=this/100*e.parseFloat(),void 0!==t?o.floor(t):o}switch(o=e.parseFloat(),r){case 42:o=this*o;break;case 43:o=this+o;break;case 45:o=this-o;break;case 47:o=this/o;break;case 47:o=this/o;break;default:o=this}return void 0!==t?o.floor(t):o},Number.prototype.format2=function(e){var t=0,r=this.toString(),n=0,o=0,i=0,s="",a=0;if(typeof e===STRING){var u=!1;a=e.length;for(var c=0;a>c;c++){var l=e[c];"#"===l&&(u?o++:n++),"."===l&&(u=!0)}var p=r,f="";if(t=r.indexOf("."),-1!==t&&(p=r.substring(0,t),f=r.substring(t+1)),p.length>n){i=p.length-n;for(var d="",c=0;i>c;c++)d+="#";e=d+e}p.length<n&&(p=p.padLeft(n," ")),f.length<o&&(f=f.padRight(o,"0")),f.length>o&&(f=f.substring(0,o)),u=!1,t=0;var m=!0;a=e.length;for(var c=0;a>c;c++){var l=e[c];if("#"===l){var h=u?f[t]:p[t];m&&(m=-1!==[","," "].indexOf(h)),m||(s+=h),t++}else{if(m)continue;"."===l&&(u=!0,t=0),s+=l}}return s}if(s="### ### ###",n=r.indexOf("."),i=e||0,0===i&&-1!==n&&(i=r.length-(n+1)),i>0){s+=".";for(var c=0;i>c;c++)s+="#"}return this.format(s)},Number.prototype.pluralize=function(e,t,r,n){var o=this,i="";i=0==o?e||"":1==o?t||"":o>1&&5>o?r||"":n;var s=i.indexOf("#");if(-1===s)return i;var a=i.lastIndexOf("#"),u=i.substring(s,a+1);return o.format(u)+i.replace(u,"")},Number.prototype.hex=function(e){for(var t=this.toString(16).toUpperCase();t.length<e;)t="0"+t;return t},Number.prototype.condition=function(e,t){return(this%2===0?e:t)||""},Number.prototype.VAT=function(e,t,r){var n=this,o=typeof t;if(o===BOOLEAN){var i=r;r=t,t=i,o=typeof t}return o===UNDEFINED&&(t=2),void 0===r&&(r=!0),0===e||0===n?n:r?(n/(e/100+1)).floor(t):(n*(e/100+1)).floor(t)},Number.prototype.discount=function(e,t){var r=this;return void 0===t&&(t=2),(r-r/100*e).floor(t)},Number.prototype.parseDate=function(e){return new Date(this+(e||0))},typeof Number.prototype.toRad===UNDEFINED&&(Number.prototype.toRad=function(){return this*Math.PI/180}),Boolean.prototype.condition=function(e,t){return(this?e:t)||""},Array.prototype.take=function(e){for(var t=[],r=this,n=r.length,o=0;n>o;o++)if(t.push(r[o]),t.length>=e)return t;return t},Array.prototype.extend=function(e,t){for(var r=typeof e===FUNCTION,n=0,o=this.length;o>n;n++)this[n]=r?e(this[n],n):exports.extend(this[n],e,t);return this},Array.prototype.first=function(e){var t=this[0];return void 0===t?e:t},Array.prototype.toObject=function(e){for(var t=this,r={},n=0,o=t.length;o>n;n++){var i=t[n];e?r[i[e]]=i:r[i]=!0}return r},Array.prototype.compare=function(e,t,r){for(var n=this,o={},i={},s=n.length,a=t.length,u=Math.max(s,a),c={},l=0;u>l;l++){var p=n[l];p&&(o[p[e]]=l);var f=t[l];f&&(i[f[e]]=l)}for(var d=-1,l=0;u>l;l++){var m,h,p=n[l],f=t[l];if(p){if(m=p[e],c[m])continue;c[m]=!0,d=i[m],void 0===d?r(p,void 0,l,-1):r(p,t[d],l,d)}if(f){if(h=f[e],c[h])continue;c[h]=!0,d=o[h],void 0===d?r(void 0,f,-1,l):r(n[d],f,d,l)}}},Array.prototype.pair=function(e,t,r,n){if(e instanceof Array){var o=e;e=t,t=o}t||(t=new Array(0));for(var i=t.length,s=0;;){var a=this[s++];if(!a)break;for(var u=!1,c=0;i>c;c++)if(a[e]===t[c][e]){r(a,t[c]),u=!0;break}!u&&n&&(s--,this.splice(s,1))}return this},Array.prototype.last=function(e){var t=this[this.length-1];return void 0===t?e:t},Array.prototype.orderBy=function(e,t){if(typeof e===BOOLEAN){var r=t;t=e,e=r}void 0===t&&(t=!0);var n=this,o=0,i=(e||"").split("."),s=i.length;return n.sort(function(e,r){var n=null,a=null;switch(s){case 1:""===i[0]?(n=e,a=r):(n=e[i[0]],a=r[i[0]]);break;case 2:n=e[i[0]][i[1]],a=r[i[0]][i[1]];break;case 3:n=e[i[0]][i[1]][i[2]],a=r[i[0]][i[1]][i[2]];break;case 4:n=e[i[0]][i[1]][i[2]][i[3]],a=r[i[0]][i[1]][i[2]][i[3]];break;case 5:n=e[i[0]][i[1]][i[2]][i[3]][i[4]],a=r[i[0]][i[1]][i[2]][i[3]][i[4]];break;default:return 0}if(0===o){var u=typeof n;o=u===STRING?1:u===NUMBER?2:u===BOOLEAN?3:4}return 1===o?t?n.removeDiacritics().localeCompare(a.removeDiacritics()):a.removeDiacritics().localeCompare(n.removeDiacritics()):2===o?n>a?t?1:-1:a>n?t?-1:1:0:3===o?n===!0&&a===!1?t?1:-1:n===!1&&a===!0?t?-1:1:0:0}),n},Array.prototype.trim=function(){for(var e=this,t=e.length,r=0;t>r;r++)typeof e[r]===STRING&&(e[r]=e[r].trim());return e},Array.prototype.skip=function(e){for(var t=[],r=this,n=r.length,o=0;n>o;o++)o>=e&&t.push(r[o]);return t},Array.prototype.where=function(e,t){for(var r=this,n=[],o="function"==typeof e,i=void 0!==t,s=0,a=r.length;a>s;s++)o?e.call(r,r[s],s)&&n.push(r[s]):i?r[s][e]===t&&n.push(r[s]):r[s]===e&&n.push(r[s]);return n},Array.prototype.find=function(e,t){var r=this,n=r.findIndex(e,t);return-1===n?null:r[n]},Array.prototype.findIndex=function(e,t){for(var r=this,n=typeof e===FUNCTION,o=void 0!==t,i=0,s=r.length;s>i;i++)if(n){if(e.call(r,r[i],i))return i}else if(o){if(r[i][e]===t)return i}else if(r[i]===e)return i;return-1},Array.prototype.remove=function(e,t){for(var r=this,n=[],o="function"==typeof e,i=void 0!==t,s=0,a=r.length;a>s;s++)o?e.call(r,r[s],s)||n.push(r[s]):i?r[s][e]!==t&&n.push(r[s]):r[s]!==e&&n.push(r[s]);return n},Array.prototype.random=function(){var e=this;return e[exports.random(e.length-1)]},Array.prototype.waiting=function(e,t){return console.log("Array.prototype.waiting: OBSOLETE. Use Array.prototype.wait"),this.wait(e,t)},Array.prototype.wait=Array.prototype.each=function(e,t,r){var n=this,o=typeof t;if(o===NUMBER||o===BOOLEAN){var i=r;r=t,t=i}void 0===r&&(r=0);var s=r===!0?n.shift():n[r];return void 0===s?(t&&t(),n):(e.call(n,s,function(){setImmediate(function(){typeof r===NUMBER&&r++,n.wait(e,t,r)})}),n)},Array.prototype.async=function(e){var t=this,r=t.shift();return void 0===r?(e&&e(),t):(r(function(){setImmediate(function(){t.async(e)})}),t)},Array.prototype._async_middleware=function(e,t,r){var n=this;if(e.success||e.headersSent)return e.$middleware=null,n.length=0,r&&r.subscribe.success(),t=null,n;var o=n.shift();if(!o)return t&&t(),n;e.$middleware=function(){n._async_middleware(e,t)};var i=o(function(r){return r?(e.$middleware=!1,e.throw500(r),t=null,void(n.length=0)):void setImmediate(e.$middleware)});return i!==!1?n:(e.$middleware=null,t=null,n.length=0,n)},Array.prototype.randomize=function(){var e=this,t=(10*Math.floor(1e8*Math.random())).toString(),r=0,n=0;return e.sort(function(){var e=t[r++];return void 0===e&&(e=t[0],r=0),n>e?(n=e,-1):n===e?(n=e,0):(n=e,1)}),e},Array.prototype.limit=function(e,t,r,n){void 0===n&&(n=0);for(var o=[],i=this,s=n+e,a=n;s>a;a++){var u=i[a];{if(void 0===u)return 0===o.length?(r&&r(),i):(t(o,function(){r&&r()},n,n+e),i);o.push(u)}}return 0===o.length?(r&&r(),i):(t(o,function(){return s<i.length?void i.limit(e,t,r,s):void(r&&r())},n,n+e),i)},Array.prototype.unique=function(e){for(var t=this,r=[],n=0,o=0,i=t.length;i>o;o++){var s=t[o];if(e)if(0!==n){for(var a=!0,u=0;n>u;u++)if(r[u][e]===s[e]){a=!1;break}a&&(r.push(s),n++)}else r.push(s),n++;else-1===r.indexOf(s)&&r.push(s)}return r},AsyncTask.prototype.run=function(){var e=this;try{e.isRunning=1,e.owner.tasksWaiting[e.name]=!0,e.owner.emit("begin",e.name);var t=e.owner.tasksTimeout[e.name];t>0&&(e.interval=setTimeout(e.timeout.bind(e),t)),e.fn(e.handlers.oncomplete)}catch(r){e.owner.emit("error",e.name,r),e.complete()}return e},AsyncTask.prototype.timeout=function(e){var t=this;return e>0?(clearTimeout(t.interval),setTimeout(t.timeout.bind(t),e),t):0>=e?(clearTimeout(t.interval),setTimeout(t.timeout.bind(t),e),t):(t.cancel(!0),t)},AsyncTask.prototype.cancel=function(e){var t=this;t.isCanceled=!0,e?t.owner.emit("timeout",t.name):t.owner.emit("cancel",t.name),t.fn=null,t.cb=null},AsyncTask.prototype.complete=function(){var e=this,t=e.owner;if(e.isRunning=2,delete t.tasksPending[e.name],delete t.tasksWaiting[e.name],!e.isCanceled)try{t.emit("end",e.name),e.cb&&e.cb()}catch(r){t.emit("error",r,e.name)}return t.reload(),t.refresh(),t},Async.prototype={get count(){return this._count},get percentage(){var e=this;return 100-Math.floor(100*e._count/e._max)}},Async.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Async,enumberable:!1}}),Async.prototype.reload=function(){var e=this;return e.tasksAll=Object.keys(e.tasksPending),e.emit("percentage",e.percentage),e},Async.prototype.cancel=function(e){var t=this;if(void 0===e){for(var r=0;r<t._count;r++)t.cancel(tasksAll[r]);return!0}var n=t.tasksPending[e];return n?(delete t.tasksPending[e],delete t.tasksWaiting[e],n.cancel(),t.reload(),t.refresh(),!0):!1},Async.prototype.await=function(e,t,r){var n=this;return typeof e===FUNCTION&&(r=t,t=e,e=exports.GUID(6)),void 0!==n.tasksPending[e]?!1:(n.tasksPending[e]=new AsyncTask(n,e,t,r,null),n._max++,n.reload(),n.refresh(),!0)},Async.prototype.wait=function(e,t,r,n){var o=this;return typeof t===FUNCTION&&(n=r,r=t,t=e,e=exports.GUID(6)),void 0!==o.tasksPending[e]?!1:(o.tasksPending[e]=new AsyncTask(o,e,r,n,t),o._max++,o.reload(),o.refresh(),!0)},Async.prototype.complete=function(e){return this.run(e)},Async.prototype.run=function(e){var t=this;return t._isRunning=!0,e&&t.onComplete.push(e),t.refresh(),t},Async.prototype.isRunning=function(e){var t=this;if(!e)return t._isRunning;var r=t.tasksPending[e];return r?1===r.isRunning:!1},Async.prototype.isWaiting=function(e){var t=this,r=t.tasksPending[e];return r?0===r.isRunning:!1},Async.prototype.isPending=function(e){var t=this,r=t.tasksPending[e];return r?!0:!1},Async.prototype.timeout=function(e,t){var r=this;return 0>=t||void 0===t?(delete r.tasksTimeout[e],r):(r.tasksTimeout[e]=t,r)},Async.prototype.refresh=function(){var e=this;if(!e._isRunning)return e;e._count=e.tasksAll.length;for(var t=0;t<e._count;t++){var r=e.tasksPending[e.tasksAll[t]];0===r.isRunning&&(null===r.waiting||void 0===e.tasksWaiting[r.waiting])&&r.run()}if(0===e._count){e._isRunning=!1,e.emit("complete"),e.emit("percentage",100),e._max=0;var n=e.onComplete,o=n.length;e.onComplete=[];for(var t=0;o>t;t++)try{n[t]()}catch(i){e.emit("error",i)}}return e},FileList.prototype.reset=function(){var e=this;e.file=[],e.directory=[],e.pendingDirectory=[]},FileList.prototype.walk=function(e){var t=this;if(e instanceof Array){for(var r=e.length,n=0;r>n;n++)t.pendingDirectory.push(e[n]);return void t.next()}fs.readdir(e,function(r,n){if(r)return t.next();for(var o=n.length,i=0;o>i;i++)t.pending.push(path.join(e,n[i]));t.next()})},FileList.prototype.stat=function(e){var t=this;fs.stat(e,function(r,n){return r?t.next():n.isDirectory()&&(null===t.onFilter||t.onFilter(e,!0))?(t.directory.push(e),t.pendingDirectory.push(e),void t.next()):((null===t.onFilter||t.onFilter(e,!1))&&t.file.push(e),void t.next())})},FileList.prototype.next=function(){var e=this;if(e.pending.length){var t=e.pending.shift();return void e.stat(t)}if(e.pendingDirectory.length){var r=e.pendingDirectory.shift();return void e.walk(r)}e.onComplete(e.file,e.directory)},exports.Async=Async,exports.sync=function(e,t){return function(){var r,n,o=[].slice.call(arguments),i=!1,s=t||this;return o.push(function(){r=arguments,!i&&n&&(i=!0,n.apply(s,r))}),e.apply(s,o),function(e){n=e,!i&&r&&(i=!0,n.apply(s,r))}}},exports.sync2=function(e,t){return function(){var r,n,o=!1,i=t||this;args.push(function(){r=arguments,!o&&n&&(o=!0,n.apply(i,r))}),e.apply(i)}},exports.async=function(e,t){var r=this;return function(n){function o(e,t){var r;try{switch(null===e){case!0:r=u.next(t);break;case!1:r=u["throw"](e)}}catch(i){if(!n)return;return typeof n===OBJECT&&n.isController?void(i instanceof ErrorBuilder?n.view400(i):n.view500(i)):void setImmediate(function(){n(i)})}if(r.done)return void(n&&typeof n!==OBJECT&&n(null,r.value));if(typeof r.value!==FUNCTION)return void o.call(s,null,r.value);try{r.value.call(s,function(){o.apply(s,arguments)})}catch(i){setImmediate(function(){o.call(s,i)})}}var i,s=this;if(arguments.length)if(t)i=arguments[1];else{i=[];for(var a=1;a<arguments.length;a++)i.push(arguments[a])}else i=new Array(0);var u=e.apply(r,i);return o(null),u.value}},exports.getMessageLength=function(e,t){var r=127&e[1];return 126===r?e.length<4?-1:converBytesToInt64([e[3],e[2],0,0,0,0,0,0],0,t):127===r?e.Length<10?-1:converBytesToInt64([e[9],e[8],e[7],e[6],e[5],e[4],e[3],e[2]],0,t):r},exports.queuecache={},exports.queue=function(e,t,r){if(!r)return!1;if(!t)return r(NOOP),!0;void 0===exports.queuecache[e]&&(exports.queuecache[e]={limit:t,running:0,pending:[]});var n=exports.queuecache[e];return n.running>=n.limit?(n.pending.push(r),!1):(n.running++,function(e){setImmediate(function(){r(function(){queue_next(e)})})}(e),!0)},exports.minifyStyle=function(e){return require("./internal").compile_css(e)},exports.minifyScript=function(e){return require("./internal").compile_javascript(e)},exports.minifyHTML=function(e){return require("./internal").compile_html(e)},global.async=exports.async,global.sync=global.SYNCHRONIZE=exports.sync,global.sync2=exports.sync2,module}({exports:{}}),function(e){function t(e,t){return e[t]<<8|e[t+1]}function r(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function n(e,t,r,n){var o=typeof e;this.width=r,this.height=n,this.builder=[],this.filename="string"===o?e:null,this.currentStream="object"===o?e:null,this.isIM=void 0===t||null===t?"im"===F.config["default-image-converter"]:t,this.outputType="string"===o?u.extname(e).substring(1):"jpg"}var o=e.exports;global.framework_image=e.exports;var i=require("child_process"),s=i.exec,a=i.spawn,u=require("path"),c={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0};return o.measureGIF=function(e){return{width:e[6],height:e[8]}},o.measureJPG=function(e){var r=e.length,n=0,o=255==e[0]&&216==e[1];if(o){for(n+=2;r>n;){for(;255!=e[n];)n++;for(;255==e[n];)n++;{if(c[e[n]]){var i=t(e,n+6),s=t(e,n+4);return{width:i,height:s}}n+=t(e,++n)}}return null}},o.measurePNG=function(e){return{width:r(e,16),height:r(e,20)}},o.measureSVG=function(e){var t=e.toString("utf8").match(/(width=\"\d+\")+|(height=\"\d+\")+/g);if(t){for(var r=0,n=0,o=0,i=t.length;i>o;o++){var s=t[o];if(r>0&&n>0)break;0===r&&s.startsWith('width="')&&(r=parseInt(s.match(/\d+/g)),isNaN(r)&&(r=0)),0===n&&s.startsWith('height="')&&(n=parseInt(s.match(/\d+/g)),isNaN(n)&&(n=0))}return{width:r,height:n}}},n.prototype.clear=function(){var e=this;return e.builder=[],e},n.prototype.measure=function(e){var t=this,r=t.filename.lastIndexOf(".");if(!t.filename)return void e(new Error("Measure does not support stream."));if(-1===r)return void e(new Error("This type of file is not supported."));var n=t.filename.substring(r).toLowerCase(),i=require("fs").createReadStream(t.filename,{start:0,end:".jpg"===n?4e4:24});return i.on("data",function(t){switch(n){case".jpg":return void e(null,o.measureJPG(t));case".gif":return void e(null,o.measureGIF(t));case".png":return void e(null,o.measurePNG(t))}e(new Error("This type of file is not supported."))}),i.on("error",e),t},n.prototype.$$measure=function(){var e=this;return function(t){e.measure(t)}},n.prototype.save=function(e,t,r){var n=this;"function"==typeof e&&(t=e,e=null),e=e||n.filename||"";var o=n.cmd(null===n.filename?"-":n.filename,e);if(0===n.builder.length){if(!t)return;return void setImmediate(function(){t(null,!0)})}var i=s(o,function(e,r){FINISHED(r,function(){DESTROY(r)}),i.kill(),i=null,n.clear(),t&&(e?t(e,!1):t(null,!0))});return n.currentStream&&(n.currentStream instanceof Buffer?i.stdin.end(n.currentStream):n.currentStream.pipe(i.stdin)),FINISHED(i.stdin,function(){DESTROY(i.stdin)}),r&&r(i.stdin),n},n.prototype.$$save=function(e,t){var r=this;return function(n){r.save(e,n,t)}},n.prototype.pipe=function(e,t,r){var n=this;if("object"==typeof t&&(r=t,t=null),0!==n.builder.length){(void 0===t||null===t)&&(t=n.outputType);var o=a(n.isIM?"convert":"gm",n.arg(null===n.filename?"-":n.filename,(t?t+":":"")+"-"));return o.stderr.on("data",e.emit.bind(e,"error")),o.stdout.on("data",e.emit.bind(e,"data")),o.stdout.on("end",e.emit.bind(e,"end")),o.on("error",e.emit.bind(e,"error")),o.stdout.pipe(e,r),n.currentStream&&(n.currentStream instanceof Buffer?o.stdin.end(n.currentStream):n.currentStream.pipe(o.stdin)),n}},n.prototype.stream=function(e,t){var r=this;if(0!==r.builder.length){(void 0===e||null===e)&&(e=r.outputType);var n=a(r.isIM?"convert":"gm",r.arg(null===r.filename?"-":r.filename,(e?e+":":"")+"-"));return r.currentStream&&(r.currentStream instanceof Buffer?n.stdin.end(r.currentStream):r.currentStream.pipe(n.stdin)),t&&t(n.stdin),n.stdout}},n.prototype.cmd=function(e,t){var r=this,n="";r.builder.sort(function(e,t){return e.priority>t.priority?1:-1});for(var o=r.builder.length,i=0;o>i;i++)n+=(n?" ":"")+r.builder[i].cmd;return(r.isIM?"convert":"gm -convert")+' "'+e+'" '+n+' "'+t+'"'},n.prototype.arg=function(e,t){var r=this,n=[];r.isIM||n.push("-convert"),e&&n.push(e),r.builder.sort(function(e,t){return e.priority>t.priority?1:-1});for(var o=r.builder.length,i=0;o>i;i++){var s=r.builder[i],a=s.cmd.indexOf(" ");-1===a?n.push(s.cmd):(n.push(s.cmd.substring(0,a)),n.push(s.cmd.substring(a+1).replace(/\"/g,"")))}return t&&n.push(t),n},n.prototype.identify=function(e){var t=this;return s((t.isIM?"identify":"gm identify")+' "'+t.fileName+'"',function(t,r){if(t)return void e(t,null);var n=r.split(" "),o=n[2].split("x"),i={type:n[1],width:framework_utils.parseInt(o[0]),height:framework_utils.parseInt(o[1])};e(null,i)}),t},n.prototype.$$identify=function(){var e=this;return function(t){e.identify(t)}},n.prototype.push=function(e,t,r){var n=this;return n.builder.push({cmd:e+(t?' "'+t+'"':""),priority:r}),n},n.prototype.output=function(e){var t=this;return"."===e[0]&&(e=e.substring(1)),t.outputType=e,t},n.prototype.resize=function(e,t,r){r=r||"";var n=this,o="";return e&&t?o=e+"x"+t:e&&!t?o=e+"x":!e&&t&&(o="x"+t),n.push("-resize",o+r,1)},n.prototype.thumbnail=function(e,t,r){r=r||"";var n=this,o="";return e&&t?o=e+"x"+t:e&&!t?o=e:!e&&t&&(o="x"+t),n.push("-thumbnail",o+r,1)},n.prototype.geometry=function(e,t,r){r=r||"";var n=this,o="";return e&&t?o=e+"x"+t:e&&!t?o=e:!e&&t&&(o="x"+t),n.push("-geometry",o+r,1)},n.prototype.filter=function(e){return this.push("-filter",e,1)},n.prototype.trim=function(){return this.push("-trim +repage",1)},n.prototype.extent=function(e,t){var r=this,n="";return e&&t?n=e+"x"+t:e&&!t?n=e:!e&&t&&(n="x"+t),r.push("-extent",n,4)},n.prototype.miniature=function(e,t,r,n){return this.filter(n||"Box").thumbnail(e,t).background(r?r:"white").align("center").extent(e,t)},n.prototype.resizeCenter=function(e,t,r){return this.resize(e,t,"^").background(r?r:"white").align("center").crop(e,t)},n.prototype.scale=function(e,t,r){r=r||"";var n=this,o="";return e&&t?o=e+"x"+t:e&&!t?o=e:!e&&t&&(o="x"+t),n.push("-scale",o+r,1)},n.prototype.crop=function(e,t,r,n){return this.push("-crop",e+"x"+t+"+"+(r||0)+"+"+(n||0),4)},n.prototype.quality=function(e){return this.push("-quality",e||80,5)},n.prototype.align=function(e){var t="";switch(e.toLowerCase().replace("-","")){case"left top":case"top left":t="NorthWest";break;case"left bottom":case"bottom left":t="SouthWest";break;case"right top":case"top right":t="NorthEast";break;case"right bottom":case"bottom right":t="SouthEast";break;case"left center":case"center left":case"left":t="West";break;case"right center":case"center right":case"right":t="East";break;case"bottom center":case"center bottom":case"bottom":t="South";break;case"top center":case"center top":case"top":t="North";break;case"center center":case"center":t="Center";break;default:t=e}return this.push("-gravity",t,3)},n.prototype.gravity=function(e){return this.align(e)},n.prototype.blur=function(e){return this.push("-blur",e,10)},n.prototype.normalize=function(){return this.push("-normalize",null,10)},n.prototype.rotate=function(e){return this.push("-rotate",e||0,8)},n.prototype.flip=function(){return this.push("-flip",null,10)},n.prototype.flop=function(){return this.push("-flop",null,10)},n.prototype.minify=function(){return this.push("+profile","*")},n.prototype.grayscale=function(){return this.push("-colorspace","Gray",10)},n.prototype.bitdepth=function(e){return this.push("-depth",e,10)},n.prototype.colors=function(e){return this.push("-colors",e,10)},n.prototype.background=function(e){return this.push("-background",e,2)},n.prototype.fill=function(e){return this.push("-fill",e,2)},n.prototype.sepia=function(){return this.push("-modulate","115,0,100",4).push("-colorize","7,21,50",5)},n.prototype.command=function(e,t,r){return this.push(e,t,r||10)},o.Image=n,o.Picture=n,o.init=function(e,t,r,o){return new n(e,t,r,o)},o.load=function(e,t,r,o){return new n(e,t,r,o)},e}({exports:{}}),function(module){function Database(e,t,r){typeof t===BOOLEAN&&(r=t,t=null),this.isReady=!1,this.status_prev=STATUS_UNKNOWN,this.status=STATUS_UNKNOWN,this.changes=void 0===r?!0:r===!0,this.countRead=0,this.countWrite=0,this.pendingRead=[],this.pendingEach=[],this.pendingLock=[],this.pendingDrop=[],this.pendingWrite=[],this.pendingClear=[],this.isPending=!1,-1!==e.indexOf(EXTENSION)&&(e=e.replace(EXTENSION,"")),this.filename=e+EXTENSION,this.filenameTemp=e+EXTENSION_TMP,this.filenameChanges=e+EXTENSION_CHANGES,this.filenameStored=e+EXTENSION_STORED,this.filenameMeta=e+EXTENSION_META,this.name=path.basename(e),this.directory=path.dirname(e),this.views=new Views(this),this.meta={version:VERSION,views:{},stored:{},description:"",created:new Date,custom:null},this.binary=0===(t||"").length?null:new Binary(this,t),this.changelog=new Changelog(this,this.filenameChanges),this.file=new FileReader(this),this.stored=new Stored(this,this.filenameStored),this._metaLoad()}function Views(e){this.views={},this.db=e,this.directory=e.directory,this.emit=e.emit}function View(e,t,r){this.db=e,this.status=STATUS_UNKNOWN,this.countRead=0,this.pendingRead=[],this.pendingOperation=[],this.filename=r,this.name=t,this.emit=e.emit,this.file=new FileReader(e)}function Stored(e,t){this.filename=t,this.db=e,this.stored={},this.cache={},this.isReaded=!1}function Binary(e,t){this.db=e,this.directory=t,this.exists=!1}function Changelog(e,t){this.filename=t,this.db=e}function FileReader(e){this.db=e}function noop(){}function appendFile(e,t,r,n){if(0===t.length)return void r();var o="";t.slice(0,30).forEach(function(e){o+=JSON.stringify(e)+NEWLINE}),fs.appendFile(e,o,function(o){o&&n.emit("error",o),appendFile(e,t.slice(30),r,n)})}function filterPrepare(fnFilter){return 0===fnFilter.length?function(){return!0}:eval("(function(doc){"+(-1===fnFilter.indexOf("return ")?"return ":"")+fnFilter+"})")}function onBuffer(e,t,r){var n=e.indexOf(NEWLINE);if(-1===n)return void r(e);var o=r(e.substring(0,n));try{t(null,JSON.parse(o),o)}catch(i){t(i,null,o)}onBuffer(e.substring(n+1),t,r)}function updatePrepare(e,t,r,n){return typeof e===STRING&&(e=filterPrepare(e)),{filter:e,callback:t,count:0,type:n,changes:r}}function u16(e,t){return e[t]<<8|e[t+1]}function u32(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function dimensionGIF(e){return{width:e[6],height:e[8]}}function dimensionJPG(e){var t=e.length,r=0,n=255==e[0]&&216==e[1];if(n)for(r+=2;t>r;){for(;255!=e[r];)r++;for(;255==e[r];)r++;{if(sof[e[r]]){var o=u16(e,r+6),i=u16(e,r+4);return{width:o,height:i}}r+=u16(e,++r)}}}function dimensionPNG(e){return{width:u32(e,16),height:u32(e,20)}}var exports=module.exports;global.framework_nosql=module.exports;var fs=require("fs"),path=require("path"),util=require("util"),events=require("events"),VERSION="v3.0.3",STATUS_UNKNOWN=0,STATUS_READING=1,STATUS_WRITING=2,STATUS_LOCKING=3,STATUS_PENDING=4,EXTENSION=".nosql",EXTENSION_VIEW=".nosql",EXTENSION_BINARY=".nosql-binary",EXTENSION_TMP=".nosql-tmp",EXTENSION_CHANGES=".changelog",EXTENSION_STORED=".nosql-stored",EXTENSION_META=".meta",MAX_WRITESTREAM=2,MAX_READSTREAM=4,MAX_BUFFER_SIZE=40960,BINARY_HEADER_LENGTH=2e3,NEWLINE="\n",STRING="string",FUNCTION="function",UNDEFINED="undefined",BOOLEAN="boolean";typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)}),Database.prototype={get created(){var e=this.meta.created;return util.isDate(e)?e:null===e||void 0===e?null:new Date(Date.parse(e.toString()))}},Database.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Database,enumberable:!1}}),Database.prototype.insert=function(e,t,r){var n=this;typeof t===STRING&&(r=t,t=null),e instanceof Array||(e=[e]);var o=e.length;if(n.status===STATUS_LOCKING||n.status===STATUS_PENDING||n.countWrite>=MAX_WRITESTREAM){for(var i=0;o>i;i++)n.pendingWrite.push({json:e[i],changes:r});return t&&t(null,-1),n}for(var s=[],a=[],i=0;o>i;i++){var u=e[i];void 0!==u.json?(s.push(u.json),u.changes&&a.push(u.changes)):(s.push(u),r&&a.push(r))}return 0===s.length?void n.next():(n.emit("insert",!0,s.length),n.status=STATUS_WRITING,n.countWrite++,appendFile(n.filename,s,function(){if(n.countWrite--,n.emit("insert",!1,s.length),n.next(),n.changelog.insert(a),t){var r=s.length;setImmediate(function(){t(null,r)})
}s=null,a=null,e=null;for(var o=Object.keys(n.meta.views),r=o.length,i=0;r>i;i++)n.views.refresh(o[i])},n),n)},Database.prototype.$$insert=function(e,t){var r=this;return function(n){r.insert(e,n,t)}},Database.prototype.read=function(e,t,r,n,o,i){var s=this,a=r||0,u=n||0;if(s.status===STATUS_LOCKING||s.status===STATUS_PENDING||s.countRead>=MAX_READSTREAM)return s.pendingRead.push(function(){s.read(e,t,r,n,o)}),s;void 0===t&&(t=e,e=function(e){return e}),typeof e===STRING&&(e=filterPrepare(e)),null===e&&(e=function(e){return e}),s.emit(i||"read",!0,0),s.countRead++,s.status=STATUS_READING;var c=[],l="",p=0,f=!0,d=function(e){return l+=e},m=function(t,r){if(f&&(l="",!t)){var n=e(r);n!==!1&&null!==n&&void 0!==n&&(p++,a>0&&a>=p||(o||c.push(n===!0?r:n),u>0&&c.length===u&&(f=!1)))}};return s.file.open(s.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e,m,d),f},function(){s.countRead--,s.next(),setImmediate(function(){s.emit(i||"read",!1,o?p:c.length),t(null,o?p:c)})}),s},Database.prototype.all=function(e,t,r,n){return this.read(e,t,r,n,!1,"all")},Database.prototype.$$all=function(e,t,r){var n=this;return function(o){return n.all(e,o,t,r)}},Database.prototype.one=function(e,t){var r=function(e,r){t(e,r?r[0]||null:null)};return this.read(e,r,0,1,!1,"one")},Database.prototype.$$one=function(e){var t=this;return function(r){return t.one(e,r)}},Database.prototype.top=function(e,t,r){return this.read(t,r,0,e,!1,"top")},Database.prototype.$$top=function(e,t){var r=this;return function(){return r.top(e,t)}},Database.prototype.count=function(e,t){return this.read(e,t,0,0,!0,"count")},Database.prototype.$$count=function(e){var t=this;return function(){return t.count(e,fnMap)}},Database.prototype.each=function(e,t){var r=this;if(r.status===STATUS_LOCKING||r.status===STATUS_PENDING||r.countRead>=MAX_READSTREAM)return e&&r.pendingEach.push({item:e,callback:t}),r;var n=[];e&&n.push({item:e,callback:t});for(var o=r.pendingEach.length,i=0;o>i;i++)n.push(r.pendingEach[i]);if(0===n.length)return r.next(),r;r.countRead++,r.status=STATUS_READING;var s="",a=0;r.pendingEach=[];var u=function(e){return s+=e},c=function(e,t){if(s="",e)return void r.emit("error",e,"each-buffer");for(var o=n.length,i=0;o>i;i++)try{n[i].item(t,a,"each-buffer")}catch(u){r.emit("error",u)}a++};return r.emit("each",!0,0),r.file.open(r.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e,c,u),!0},function(){r.countRead--,r.next(),setImmediate(function(){r.emit("each",!1,a);for(var e=n.length,t=0;e>t;t++){var o=n[t];o.callback&&o.callback()}})}),r},Database.prototype.sort=function(e,t,r,n,o){var i=this,s=[],a=0;typeof e===STRING&&(e=filterPrepare(e)),n=n||30,r=r||0;var u=function(){s.sort(t),(r>0||n>0)&&(s=s.slice(r,r+n)),o(null,s,a)},c=function(t){var r=e(t);r!==!1&&null!==r&&void 0!==r&&(a++,s.push(r===!0?t:r))};return i.each(c,u),i},Database.prototype.$$sort=function(e,t,r,n){var o=this;return function(i){o.sort(e,t,r,n,i)}},Database.prototype.clear=function(e,t){var r=this,n=typeof e;if(void 0===e&&(e=null),n===STRING&&(t=e,e=null),r.pendingClear.push(function(){t&&r.changelog.insert(t),e&&e()}),r.status!==STATUS_UNKNOWN)return r;r.status=STATUS_LOCKING;for(var o=[],i=r.pendingClear.length,s=0;i>s;s++){var a=r.pendingClear[s];null!==a&&o.push(a)}return r.emit("clear",!0,!1),r.pendingClear=[],fs.exists(r.filename,function(e){return e?void fs.unlink(r.filename,function(e){e&&r.emit("error",e,"clear"),r.next(),setImmediate(function(){r.emit("clear",!1,null===e);for(var t=o.length,n=0;t>n;n++){var i=o[n];i&&i()}})}):(r.next(),void setImmediate(function(){r.emit("clear",!1,!0);for(var e=o.length,t=0;e>t;t++){var n=o[t];n&&n()}}))}),r},Database.prototype.$$clear=function(e){var t=this;return function(r){t.clear(r,e)}},Database.prototype.drop=function(e){var t=this;if(void 0===e&&(e=null),t.pendingDrop.push(e),t.status!==STATUS_UNKNOWN)return t;t.status=STATUS_LOCKING;var r=[];return t.pendingDrop.forEach(function(e){null!==e&&r.push(e)}),t.emit("drop",!0,!1),t.pendingDrop=[],t._drop(),fs.exists(t.filename,function(e){return e?(fn.unlink(t.filenameMeta,noop),void fs.unlink(t.filename,function(e){e&&t.emit("error",e,"drop"),t.next(),setImmediate(function(){t.emit("drop",!1,null===e),r.forEach(function(t){t&&t(null,null===e)})})})):(t.next(),void setImmediate(function(){t.emit("drop",!1,!0),r.forEach(function(e){e&&e(null)})}))}),t},Database.prototype.drop=function(){var e=this;return function(t){e.drop(t)}},Database.prototype._drop=function(){var e=this;return fs.readdirSync(e.directory).forEach(function(t){var r=-1!==t.indexOf(e.name+"#")&&-1!==t.indexOf(EXTENSION_VIEW);if(r)return void fs.unlink(path.join(e.directory,t),noop);var n=e.name+EXTENSION_CHANGES===t;return n?void fs.unlink(path.join(e.directory,t),noop):void 0}),null===e.binary?e:(fs.readdirSync(e.binary.directory).forEach(function(t){-1!==t.indexOf(e.name+"#")&&-1!==t.indexOf(EXTENSION_BINARY)&&fs.unlink(path.join(e.binary.directory,t),noop)}),e)},Database.prototype.update=function(e,t,r,n){var o=this;if(typeof t===STRING&&(r=t,t=null),void 0!==e&&o.pendingLock.push(updatePrepare(e,t,r,n||"update")),o.status!==STATUS_UNKNOWN)return o;var i=[];if(o.pendingLock.forEach(function(e){i.push(e)}),0===i.length)return o.next(),o;o.status=STATUS_LOCKING;var s="",a=i.length,u=[],c=0,l=0,p=0,f=!1;o.emit("update/remove",!0,0,0),o.pendingLock=[];var d=function(){i.forEach(function(e){return"update"===e.type?void(e.count=l):void("remove"===e.type&&(e.count=c))}),fs.rename(o.filenameTemp,o.filename,function(e){e&&o.emit("error",e,"update/rename-file"),o.emit("update/remove",!1,l,c);var t=[];i.forEach(function(e){void 0!==e.changes&&t.push(e.changes),e.callback&&function(e,t){setImmediate(function(){e(null,t)})}(e.callback,e.count)}),t.length>0&&o.changelog.insert(t),o.next()})},m=function(e,t){if(u.length>25||t){if(0===u.length)return void(f&&0>=p&&d());p++,fs.appendFile(o.filenameTemp,u.join(NEWLINE)+NEWLINE,function(){p--,f&&0>=p&&d()}),u=[]}typeof e===STRING&&u.push(e)},h=function(e){return s+=e},g=function(e,t,r){s="";for(var n=null,u=0;a>u;u++){var p=i[u];if(n=p.filter(t)||null,null===n)break}if(null===n)return o.emit("remove",t),void c++;var f=JSON.stringify(n);f!==r&&(o.emit("update",n),l++),m(f)};return fs.appendFile(o.filenameTemp,""),o.file.open(o.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e.toString(),g,h),!0},function(e){return e?(f=!0,void m(null,!0)):void o.next()}),o},Database.prototype.$$update=function(e,t,r){var n=this;return function(o){n.update(e,o,t,r)}},Database.prototype.prepare=function(e,t,r){var n=this;return void 0!==e&&n.pendingLock.push(updatePrepare(e,t,r,"update")),n},Database.prototype.$$prepare=function(e,t){var r=this;return function(n){r.prepare(e,n,t)}},Database.prototype.remove=function(e,t,r){var n=this;typeof e===STRING&&(e=filterPrepare(e));var o=function(t){return e(t)===!0?null:t};return n.update(o,t,r,"remove"),n},Database.prototype.$$remove=function(e,t){var r=this;return function(n){r.remove(e,n,t)}},Database.prototype.pause=function(){var e=this;return e.isPending===!0?e:(e.isPending=!0,e.status===STATUS_UNKNOWN&&(e.status=STATUS_PENDING,e.emit("pause/resume",!0)),e)},Database.prototype.resume=function(){var e=this;return e.isPending?(e.isPending=!1,e.emit("pause/resume",!1),e.next(),e):e},Database.prototype.next=function(){var e=this;if(e.isPending)return void(e.status!==STATUS_PENDING&&(e.status=STATUS_PENDING,e.emit("pause")));if(e.status_prev=e.status,e.status=STATUS_UNKNOWN,e.countRead>0)return void(e.status=STATUS_READING);if(e.countWrite>0)return void(e.status=STATUS_WRITING);if(e.pendingWrite.length>0)return e.insert(e.pendingWrite),void(e.pendingWrite=[]);if(e.pendingLock.length>0)return void e.update();if(e.pendingEach.length>0)return void e.each();if(!(e.pendingRead.length>0))return e.pendingDrop.length>0?void e.drop():e.pendingClear.length>0?void e.clear():void setImmediate(function(){e.emit("complete",e.status_prev)});var t=e.pendingRead.length;t>MAX_READSTREAM&&(t=MAX_READSTREAM);for(var r=0;t>r;r++)e.pendingRead.shift()()},Database.prototype.description=function(e){var t=this;return void 0===e?t.meta.description:(t.meta.description=(e||"").toString(),t._metaSave(),t)},Database.prototype.custom=function(e){var t=this;return void 0===e?t.meta.custom:(t.meta.custom=e,t._metaSave(),t)},Database.prototype._metaSave=function(){var e=this;return void 0===e.meta.created&&(e.meta.created=new Date),fs.writeFile(e.filenameMeta,JSON.stringify(e.meta),noop),e},Database.prototype._metaLoad=function(e){var t=this;return fs.readFile(t.filenameMeta,function(r,n){var o=t.isReady;if(t.isReady=!0,r)return o||(t.emit("ready"),t.emit("load")),void(e&&e(!1,t.meta));t.meta=JSON.parse(n.toString("utf8"));for(var i=Object.keys(t.meta.views),s=i.length,a=0;s>a;a++)t.meta.views[i[a]].isReady=!0;o||(t.emit("ready"),t.emit("load")),e&&e(!0,t.meta)}),t},Views.prototype.all=function(e,t,r,n,o){var i=this,s=i.views[e];void 0===s&&(s=i.getView(e),i.views[e]=s);var a=typeof r;return a===FUNCTION||a===STRING?(o=r,r=0,n=0):(a=typeof n,(a===FUNCTION||a===STRING)&&(o=n,n=0)),typeof o===STRING&&(o=filterPrepare(o)),typeof o!==FUNCTION&&(o=function(e){return e}),s.read(o,t,r,n),i.db},Views.prototype.$$all=function(e,t,r,n){var o=this;return function(i){o.all(e,i,t,r,n)}},Views.prototype.top=function(e,t,r,n){var o=this,i=o.views[e];return void 0===i&&(i=o.getView(e),o.views[e]=i),typeof n===STRING&&(n=filterPrepare(n)),typeof n!==FUNCTION&&(n=function(e){return e}),i.read(n,r,0,t,!0),o.db},Views.prototype.$$top=function(e,t,r){var n=this;return function(o){n.top(e,t,o,r)}},Views.prototype.one=function(e,t,r){var n=this,o=n.views[e];return void 0===o&&(o=n.getView(e),n.views[e]=o),void 0===r&&(r=t,t=null),typeof t===STRING&&(t=filterPrepare(t)),typeof t!==FUNCTION&&(t=function(e){return e}),o.read(t,r,0,1,!0),n.db},Views.prototype.$$one=function(e,t){var r=this;return function(n){r.one(e,t,n)}},Views.prototype.drop=function(e,t,r){var n=this,o=n.views[e];return typeof t===STRING&&(r=t,t=null),void 0===o&&(o=n.getView(e),n.views[e]=o),delete n.db.meta.views[e],n.db._metaSave(),n.db.emit("view/drop",!0,e),o.operation(function(i){fs.exists(o.filename,function(s){return n.db.emit("view/drop",!1,e),r&&n.db.changelog.insert(r),s?void fs.unlink(o.filename,function(e){e&&n.db.emit("error",e,"view/drop"),t&&t(e,!0),i&&i()}):(t&&t(null,!0),void(i&&i()))})}),n.db},Views.prototype.$$drop=function(e,t,r){var n=this;return function(t){n.drop(e,t,r)}},Views.prototype.refresh=function(name,fnCallback){var self=this,schema=self.db.meta.views[name];schema.isReady=!1;var fnSort=schema.sort||"",fnMap=schema.map;fnSort=0===fnSort.length?null:eval("("+fnSort+")"),fnMap=eval("("+fnMap+")");var selected=[],count=0;self.db.emit("view/refresh",!0,name,"");var onCallback=function(){fnSort&&selected.sort(fnSort);var e=self.views[name];void 0===e&&(e=self.getView(name),self.views[name]=e);var t=self.getFileName(name);e.operation(function(e){var r=function(){appendFile(t,selected,function(){self.db.emit("view/refresh",!1,name,count),schema.isReady=!0,fnCallback&&setImmediate(function(){fnCallback(null,count)}),e&&e()},self.db)};fs.exists(t,function(n){return n?void fs.unlink(t,function(t){return t?(self.db.emit("error",t,"view/refresh"),void(e&&e())):void r()}):void r()})})},onItem=function(e){var t=fnMap(e)||null;null!==t&&(count++,selected.push(t))};self.db.each(onItem,onCallback)},Views.prototype.$$refresh=function(e){var t=this;return function(r){t.refresh(e,r)}},Views.prototype.create=function(e,t,r,n,o){var i=this;return typeof n===STRING&&(o=n,n=null),typeof t===STRING&&(t=filterPrepare(t)),i.db.meta.views[e]={map:t.toString(),sort:(r||"").toString(),isReady:!1},i.db._metaSave(),i.db.emit("view/create",!0,e,0),o&&i.db.changelog.insert(o),i.refresh(e,n),i},Views.prototype.$$create=function(e,t,r,n){var o=this;return function(i){o.create(e,t,r,i,n)}},Views.prototype.getView=function(e){var t=this;return new View(t.db,e,t.getFileName(e))},Views.prototype.getFileName=function(e){var t=this;return path.join(t.directory,t.db.name+"#"+e+EXTENSION_VIEW)},View.prototype.read=function(e,t,r,n,o,i){var s=this,a=r||0,u=n||0;if(o=o||!1,s.status===STATUS_LOCKING||s.countRead>=MAX_READSTREAM)return s.pendingRead.push(function(){s.read(e,t,r,n,i)}),s;s.status=STATUS_READING,typeof e===STRING&&(e=filterPrepare(e)),null===e&&(e=function(e){return e}),s.db.emit("view",!0,s.name,0),s.countRead++;var c=[],l="",p=0,f=!0,d=function(e){return l+=e},m=function(t,r){if(f&&(l="",!t)){var n=e(r);n!==!1&&null!==n&&void 0!==n&&(p++,a>0&&a>=p||(i||c.push(n===!0?r:n),u>0&&c.length===u&&(f=!1)))}};return s.file.open(s.filename,MAX_BUFFER_SIZE,function(e){return o&&!f?(p=-1,!1):(onBuffer(e,m,d),f)},function(){s.countRead--,s.next(),setImmediate(function(){s.emit("view",!1,s.name,p),t(null,c,p)})}),s},View.prototype.operation=function(e){var t=this;if(void 0!==e&&t.pendingOperation.push(e),t.status!==STATUS_UNKNOWN)return t;t.status=STATUS_LOCKING;var r=t.pendingOperation.shift();return r(function(){t.next()}),t},View.prototype.next=function(){var e=this;if(e.status=STATUS_UNKNOWN,e.countRead>0)return void(e.status=STATUS_READING);if(e.pendingOperation.length>0)return void e.operation();if(e.pendingRead.length>0){var t=e.pendingRead.length;t>MAX_READSTREAM&&(t=MAX_READSTREAM);for(var r=0;t>r;r++)e.pendingRead.shift()()}else;},Stored.prototype.create=function(e,t,r,n){if(typeof r===STRING){var o=n;n=r,r=o}var i=this;return i.db.meta.stored[e]=t.toString(),i.db._metaSave(r),delete i.cache[e],n&&i.db.changelog.insert(n),i.db.emit("stored/create",e),i.db},Stored.prototype.$$create=function(e,t,r){var n=this;return function(o){n.create(e,t,o,r)}},Stored.prototype.remove=function(e,t,r){var n=this;if(typeof t===STRING){var o=r;r=t,t=o}return r&&n.db.changelog.insert(r),delete n.cache[e],delete n.db.meta.stored[e],n.db._metaSave(t),n.db},Stored.prototype.$$remove=function(e,t){var r=this;return function(n){r.remove(e,n,t)}},Stored.prototype.clear=function(e,t){var r=this;if(typeof e===STRING){var n=t;t=e,e=n}return t&&r.db.changelog.insert(t),r.cache={},r.db.meta.stored={},r.db._metaSave(e),r.db},Stored.prototype.$$clear=function(e){var t=this;return function(r){t.clear(r,e)}},Stored.prototype.execute=function(name,params,fnCallback,changes){var self=this,type=typeof params;if(type===FUNCTION&&(changes=fnCallback,fnCallback=params,params=null),typeof fnCallback===STRING){var tmp=changes;changes=fnCallback,fnCallback=tmp}changes&&self.db.changelog.insert(changes);var fn=self.db.meta.stored[name];if(void 0===fn)return void(fnCallback&&fnCallback());var cache=self.cache[name];return self.db.emit("stored",name),void 0===fn?void(fnCallback&&fnCallback()):(void 0===cache?(fn=eval("("+fn+")"),self.cache[name]=fn):fn=cache,void 0===fnCallback&&(fnCallback=function(){}),fn.call(self.db,self.db,fnCallback,params||null),self)},Stored.prototype.$$execute=function(e,t,r){var n=this;return function(o){n.execute(e,t,o,r)}},Binary.prototype.insert=function(e,t,r,n,o){typeof r===STRING&&(r=new Buffer(r,"base64")),typeof n===STRING&&(o=n,n=null);var i=this,s=r.length,a={width:0,height:0};i.check(),-1!==e.indexOf(".gif")?a=dimensionGIF(r):-1!==e.indexOf(".png")?a=dimensionPNG(r):-1!==e.indexOf(".jpg")&&(a=dimensionJPG(r));var u=new Buffer(BINARY_HEADER_LENGTH);u.fill(" "),u.write(JSON.stringify({name:e,size:s,type:t,width:a.width,height:a.height}));var c=(new Date).getTime().toString()+Math.random().toString(36).substring(10),l=i.db.name+"#"+c,p=fs.createWriteStream(path.join(i.directory,l+EXTENSION_BINARY));return p.write(u,"binary"),p.end(r),p=null,o&&i.db.changelog.insert(o),n&&n(null,c,u),c},Binary.prototype.$$insert=function(e,t,r,n){var o=this;return function(r){o.insert(e,t,buf,r,n)}},Binary.prototype.update=function(e,t,r,n,o,i){typeof n===STRING&&(n=new Buffer(n,"base64")),typeof o===STRING&&(i=o,o=null);var s=this,a=n.length,u={width:0,height:0},c=e;s.check(),-1===c.indexOf("#")&&(c=s.db.name+"#"+c),-1!==t.indexOf(".gif")?u=dimensionGIF(n):-1!==t.indexOf(".png")?u=dimensionPNG(n):-1!==t.indexOf(".jpg")&&(u=dimensionJPG(n));var l=new Buffer(BINARY_HEADER_LENGTH);l.fill(" "),l.write(JSON.stringify({name:t,size:a,type:r,width:u.width,height:u.height}));var p=fs.createWriteStream(path.join(s.directory,c+EXTENSION_BINARY));return p.write(l,"binary"),p.end(n),p=null,i&&s.db.changelog.insert(i),o&&o(null,e,l),e},Binary.prototype.$$update=function(e,t,r,n,o){var i=this;return function(n){i.update(e,t,r,update,n,o)}},Binary.prototype.read=function(e,t){var r=this;r.check(),-1===e.indexOf("#")&&(e=r.db.name+"#"+e);var n=path.join(r.directory,e+EXTENSION_BINARY),o=fs.createReadStream(n,{start:0,end:BINARY_HEADER_LENGTH-1,encoding:"binary"});return o.on("error",function(e){t(e,null,null)}),o.on("data",function(e){var r=new Buffer(e,"binary").toString("utf8").replace(/^[\s]+|[\s]+$/g,"");o=fs.createReadStream(n,{start:BINARY_HEADER_LENGTH}),t(null,o,JSON.parse(r))}),r.db},Binary.prototype.$$read=function(e){var t=this;return function(r){t.read(e,r)}},Binary.prototype.remove=function(e,t,r){var n=this,o=e;n.check(),-1===o.indexOf("#")&&(o=n.db.name+"#"+o);var i=path.join(n.directory,o+EXTENSION_BINARY);return typeof t===STRING&&(r=t,t=null),fs.exists(i,function(e){return r&&n.db.changelog.insert(r),e?void fs.unlink(i,function(e){t&&t(e,!0)}):void(t&&t(null,!1))}),n.db},Binary.prototype.$$remove=function(e,t){var r=this;return function(n){r.remove(e,n,t)}},Binary.prototype.check=function(){var e=this;return e.exists?e:(e.exists=!0,fs.existsSync(e.directory)?e:(fs.mkdirSync(e.directory),e))},Changelog.prototype.insert=function(e){var t=this;if(!t.db.changes)return t.db;if(void 0===e)return t.db;if(e instanceof Array||(e=[e||""]),0===e.length)return t.db;var r="",n=new Date,o=n.getFullYear(),i=(n.getMonth()+1).toString(),s=n.getDate().toString(),a=n.getHours().toString(),u=n.getMinutes().toString(),c=n.getSeconds().toString();1===i.length&&(i="0"+i),1===s.length&&(s="0"+s),1===u.length&&(u="0"+u),1===a.length&&(a="0"+a),1===c.length&&(c="0"+c);var l=o+"-"+i+"-"+s+" "+a+":"+u+":"+c;return e.forEach(function(e){r+=l+" | "+e+NEWLINE,t.db.emit("change",e)}),fs.appendFile(t.filename,r,function(){}),t.db},Changelog.prototype.read=function(e){var t=this;return fs.exists(t.filename,function(r){return r?void fs.readFile(t.filename,function(t,r){if(t)return void e(t,[]);var n=r.toString("utf8").split("\n");""===n[n.length-1]&&n.pop(),e(null,n)}):void e(null,[])}),t.db},Changelog.prototype.$$read=function(){var e=this;return function(t){e.read(t)}},Changelog.prototype.clear=function(e){var t=this;return fs.exists(t.filename,function(r){return r?void fs.unlink(t.filename,function(t){return t?void(e&&e(t,!1)):void(e&&e(null,!0))}):void(e&&e(!1))}),t.db},Changelog.prototype.$$clear=function(){var e=this;return function(t){e.clear(t)}},FileReader.prototype.open=function(e,t,r,n){var o=this;fs.open(e,"r",function(e,i){if(e)return void n(!1);t=t||1024;var s=function a(e,s){return e?(fs.close(i),i=null,void n(!0)):void o.read(i,s+t,t,r,a)};o.read(i,0,t,r,s)})},FileReader.prototype.read=function(e,t,r,n,o){var i=new Buffer(r);fs.read(e,i,0,r,t,function(e,s){var a=s!==r,u=i.toString("utf8",0,s);if(a)return u=u.replace(/\s+$/g,""),u[u.length-1]!==NEWLINE&&(u+=NEWLINE),n(u),void o(!0);try{a=!n(u)}catch(e){a=!0}setImmediate(function(){o(a,t,r)})})};var sof={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0};return exports.database=Database,exports.load=exports.open=exports.nosql=exports.init=function(e,t,r){return new Database(e,t,r)},module}({exports:{}}),function(e){function t(){this.debug=!1,this.Message=n,this.Mail=n}function r(e,t){f.resolveMx(e,function(r,n){function o(e){if(e>=n.length)return void t(new Error(v.connection));var r=c.createConnection(25,n[e].exchange);r.on("error",function(){o(++e)}),r.on("connect",function(){t(null,r)})}return r?void t(r,n):n&&0!==n.length?(n.sort(function(e,t){return e.priority<t.priority}),void o(0)):void t(new Error(v.resolve+e))})}function n(e,t){this.subject=e||"",this.body=t||"",this.files=[],this.addressTo=[],this.addressReply=[],this.addressCC=[],this.addressBCC=[],this.addressFrom={name:"",address:""},this.callback=null,this.closed=!1,this.tls=!1}function o(e){for(var t=0,r="",n=e.length;n>t;){var o=t+68;o>n&&(o=n),r+=e.substring(t,o)+h,t=o}return r}function i(e){return e.substring(e.indexOf("@")+1)}function s(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1).toUpperCase()}function a(){return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()}function u(e){return e?"=?utf-8?B?"+new Buffer(e).toString("base64")+"?=":""}e.exports;global.framework_mail=e.exports;var c=require("net"),l=require("tls"),p=require("events"),f=require("dns"),d=require("fs"),m=require("path"),h="\r\n",g=/\besmtp\b/i,v={notvalid:"E-mail address is not valid",resolve:"Cannot resolve MX of ",connection:"Cannot connect to any SMTP server."};global.framework_utils||(global.framework_utils=require("./utils")),t.prototype.__proto__=Object.create(p.EventEmitter.prototype,{constructor:{value:t,enumberable:!1}}),t.prototype.create=function(e,t){return new n(e,t)},n.prototype.sender=function(e,t){return this.from(e,t)},n.prototype.from=function(e,t){if(!e.isEmail())throw new Error(v.notvalid);var r=this;return r.addressFrom.name=t||"",r.addressFrom.address=e,r},n.prototype.to=function(e){if(!e.isEmail())throw new Error(v.notvalid);var t=this;return t.addressTo.push(e),t},n.prototype.cc=function(e){if(!e.isEmail())throw new Error(v.notvalid);var t=this;return t.addressCC.push(e),t},n.prototype.bcc=function(e){if(!e.isEmail())throw new Error(v.notvalid);var t=this;return t.addressBCC.push(e),t},n.prototype.reply=function(e){if(!e.isEmail())throw new Error(v.notvalid);var t=this;return t.addressReply.push(e),t},n.prototype.attachment=function(e,t){var r=this;return void 0===t&&(t=m.basename(e)),r.files.push({name:t,filename:e,contentType:framework_utils.getContentType(m.extname(t))}),r},n.prototype.attachmentInline=function(e,t,r){var n=this;return void 0===t&&(t=m.basename(e)),n.files.push({name:t,filename:e,contentType:framework_utils.getContentType(m.extname(t)),disposition:"inline",contentId:r}),n},n.prototype.send=function(e,t,n){var o=this;if(e=e||null,"function"==typeof t){var s=n;n=t,t=s}if(o.callback=n,t.secure&&!t.port&&(t.port=465),t=framework_utils.copy(t,{secure:!1,port:25,user:"",password:"",timeout:1e4,tls:null}),null===e||""===e)return e=i(o.addressFrom.address),r(e,function(e,r){return e?(y.emit("error",e,o),void(n&&n(e))):(r.on("error",function(e){y.emit("error",e,o),n&&n(e)}),void o._send(r,t))}),o;var a;if(t.secure){var u=framework_utils.copy(t);u.host=e,a=l.connect(u,function(){o._send(this,t)})}else a=c.createConnection(t.port,e);return a.$host=e,a.on("error",function(e){a.destroy(),o.closed=!0,o.callback&&o.callback(e),-1===e.stack.indexOf("ECONNRESET")&&y.emit("error",e,o)}),a.on("clientError",function(e){y.emit("error",e,o),o.callback&&o.callback(e)}),a.on("connect",function(){t.secure||o._send(a,t)}),o},n.prototype.switchToTLS=function(e,t){var r=this;r.tls=!0,e.removeAllListeners("data"),e.removeAllListeners("error"),e.removeAllListeners("clientError");var n=framework_utils.copy(t.tls,{socket:e,host:e.$host,ciphers:"SSLv3"}),o=l.connect(n,function(){r._send(this,t,!0)});o.on("error",function(e){o.destroy(),r.closed=!0,r.callback&&r.callback(e),-1===e.stack.indexOf("ECONNRESET")&&y.emit("error",e,r)}),o.on("clientError",function(e){y.emit("error",e,r),r.callback&&r.callback(e)}),o.on("connect",function(){t.secure||r._send(o,t)})},n.prototype._send=function(e,t,r){var n=this,c="",l=[],p=[],f=i(n.addressFrom.address),d=new Date,m="--totaljs"+d.getTime(),v=!1,b=!1,w="",k=[],E=null,S=null,T=!1,_=function(t){n.closed||(y.debug&&console.log("SEND",t),e.write(t+h))},O=!t.tls||n.tls&&t.tls;if(O&&y.emit("send",n),e.setTimeout(t.timeout||5e3,function(){n.closed=!0;var t=new Error(framework_utils.httpStatus(408));y.emit("error",t,n),null!==e&&e.destroy(),e=null,n.callback&&n.callback(t)}),e.setEncoding("utf8"),O){l.push("MAIL FROM: <"+n.addressFrom.address+">"),p.push("Message-ID: <"+a()+"@WIN-"+s()+">"),p.push("MIME-Version: 1.0"),p.push("From: "+(n.addressFrom.name?u(n.addressFrom.name)+" <"+n.addressFrom.address+">":n.addressFrom.address));var N,x=n.addressTo.length,C="";if(x){for(var I=0;x>I;I++)N="<"+n.addressTo[I]+">",l.push("RCPT TO: "+N),C+=(""!==C?", ":"")+N;p.push("To: "+C),C=""}if(x=n.addressCC.length){for(var I=0;x>I;I++)N="<"+n.addressCC[I]+">",l.push("RCPT TO: "+N),C+=(""!==C?", ":"")+N;p.push("Cc: "+C),C=""}if(x=n.addressBCC.length)for(var I=0;x>I;I++)l.push("RCPT TO: <"+n.addressBCC[I]+">");if(l.push("DATA"),l.push("QUIT"),l.push(""),p.push("Date: "+d.toUTCString()),p.push("Subject: "+u(n.subject)),x=n.addressReply.length){for(var I=0;x>I;I++)C+=(""!==C?", ":"")+"<"+n.addressReply[I]+">";p.push("Reply-To: "+C),C=""}p.push("Content-Type: multipart/mixed; boundary="+m),p.push(""),p.push("--"+m),p.push("Content-Type: "+(-1!==n.body.indexOf("<")&&-1!==n.body.lastIndexOf(">")?"text/html":"text/plain")+"; charset=utf-8"),p.push("Content-Transfer-Encoding: base64"),p.push(""),p.push(o(new Buffer(n.body.replace(/\r\n/g,"\n").replace(/\n/g,h)).toString("base64"))),x=n.files.length}e.on("end",function(){n.closed=!0,e&&e.destroy()}),e.on("data",function(t){if(!n.closed)for(var r=t.toString().split(h),o=r.length,i=0;o>i;i++){var s=r[i];""!==s&&e&&e.emit("line",s)}}),e.on("line",function(r){r=r.toUpperCase(),y.debug&&console.log("<âââ",r);var o=parseInt(r.match(/\d+/)[0],10);if(250!==o||b||(-1!==r.indexOf("AUTH LOGIN PLAIN")||-1!==r.indexOf("AUTH PLAIN LOGIN")||t.user&&t.password)&&(w="plain",b=!0,-1===r.indexOf("XOAUTH")?(k.push("AUTH LOGIN"),k.push(new Buffer(t.user).toString("base64")),k.push(new Buffer(t.password).toString("base64"))):k.push("AUTH PLAIN "+new Buffer("\x00"+t.user+"\x00"+t.password).toString("base64"))),"-"!==r.substring(3,4))switch(!v&&b&&(v=!0,o=334),o){case 220:if(T)return void n.switchToTLS(e,t);c=T||t.user&&t.password||g.test(r)?"EHLO":"HELO",_(c+" "+f);break;case 221:case 250:case 251:case 235:_(l.shift()),0===l.length&&(y.emit("success",n),n.callback&&n.callback(null),S=setTimeout(function(){null!==e&&e.destroy(),e=null},500));break;case 334:if(!n.tls&&!T&&t.tls)return T=!0,void _("STARTTLS");var i=k.shift();if(void 0===i){E=new Error("Forbidden."),y.emit("error",E,n),n.callback&&n.callback(E),null!==e&&e.destroy(),e=null;break}_(i);break;case 354:if(_(p.join(h)),n.files.length)return p=null,void n._writeAttachment(_,m,e);_("--"+m+"--"),_(""),_("."),p=null;break;default:if(400>o)break;E=new Error(r),null!==e&&e.destroy(),e=null,y.emit("error",E,n),n.callback&&n.callback(E)}}),r&&_("EHLO "+f)},n.prototype._writeAttachment=function(e,t,r){var n=this,o=n.files.shift();if(void 0===o)return e("--"+t+"--"),e(""),void e(".");var i=o.name,s=d.createReadStream(o.filename,{encoding:"base64"}),a=[];return a.push("--"+t),o.contentId?(a.push('Content-Disposition: inline; filename="'+i+'"'),a.push("Content-ID: <"+o.contentId+">")):a.push('Content-Disposition: attachment; filename="'+i+'"'),a.push("Content-Type: application/octet-stream;"),a.push("Content-Transfer-Encoding: base64"),a.push(h),e(a.join(h)),s.on("data",function(t){for(var r=t.length,n=0,o=0;r>n;)n+=68,n>r&&(n=r),e(t.slice(o,n).toString("base64")),o=n}),s.on("end",function(){e(h),n._writeAttachment(e,t,r)}),n};var y=new t;return e.exports=y,e}({exports:{}}),function(module){function parse_multipart_header(e){var t=[],r=' name="',n=r.length,o=e.indexOf(r),i="";return-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),t.push(i?i:"undefined_"+Math.floor(1e5*Math.random()).toString()),r=' filename="',n=r.length,o=e.indexOf(r),i="",-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),t.push(i?i:null),t}function HttpFile(){this.name,this.filename,this.type,this.path,this.length=0,this.width=0,this.height=0}function compile_autovendor(e){var t=/\n|\s{2,}/g,r=/\s?\{\s{1,}/g,n=/\s?\}\s{1,}/g,o=/\s?\:\s{1,}/g,i=/\s?\;\s{1,}/g,s=/\,\s{1,}/g,a="@#auto-vendor-prefix#@",u=e.startsWith(a);return u?e=e.replace(a,""):(a="/*auto*/",u=-1!==e.indexOf(a),u&&(e=e.replace(a,""))),u&&(e=autoprefixer(e)),e.replace(t,"").replace(r,"{").replace(n,"}").replace(o,":").replace(i,";").replace(s,function(e,t,r){for(var n=t;n>0;n--)if(("'"===r[n]||'"'===r[n])&&":"===r[n-1])return e;return","}).replace(/\s\}/g,"}").replace(/\s\{/g,"{").trim()}function autoprefixer(e){var t=["filter","appearance","column-count","column-gap","column-rule","display","transform","transform-style","transform-origin","transition","user-select","animation","perspective","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-play-state","opacity","background","background-image","font-smoothing","text-size-adjust","backface-visibility","box-sizing","overflow-scrolling"];e=autoprefixer_keyframes(e);for(var r,n=[],o=0,i=0;i<t.length;i++)for(r=t[i],o=0;-1!==o;)if(o=e.indexOf(r,o+1),-1!==o){var s=e.indexOf(";",o),a=e.indexOf("}",o),u=Math.min(s,a);if(-1===u&&(u=Math.max(s,a)),-1!==u){var c="-"===e.substring(o-1,o);if(!c){var l=e.substring(o,u);u=l.indexOf(":"),-1!==u&&l.substring(0,u+1).replace(/\s/g,"")===r+":"&&n.push({name:r,property:l})}}}for(var p=[],f=n.length,i=0;f>i;i++){var d=n[i].name;r=n[i].property;var m=r,h=";",g=m+h;if("opacity"!==d)if("background"!==d&&"background-image"!==d)if("text-overflow"!==d)if("display"!==d)g+="-webkit-"+m+h,g+="-moz-"+m,-1===d.indexOf("animation")&&(g+=h+"-ms-"+m),g+=h+"-o-"+m,e=e.replacer(r,"@[["+p.length+"]]"),p.push(g);else{if(-1===r.indexOf("box"))continue;g=m+h,g+=m.replacer("box","-webkit-box")+h,g+=m.replacer("box","-moz-box"),e=e.replacer(r,"@[["+p.length+"]]"),p.push(g)}else g=m+h,g+=m.replacer("text-overflow","-ms-text-overflow"),e=e.replacer(r,"@[["+p.length+"]]"),p.push(g);else{if(-1===r.indexOf("linear-gradient"))continue;g=m.replacer("linear-","-webkit-linear-")+h,g+=m.replacer("linear-","-moz-linear-")+h,g+=m.replacer("linear-","-o-linear-")+h,g+=m.replacer("linear-","-ms-linear-")+h,g+=m+(";"===m[m.length-1]?"":h),e=e.replacer(r,"@[["+p.length+"]]"),p.push(g)}else{var v=parseFloat(m.replace("opacity","").replace(":","").replace(/\s/g,""));if(isNaN(v))continue;g+="filter:alpha(opacity="+Math.floor(100*v)+");",e=e.replacer(r,"@[["+p.length+"]]"),p.push(g)}}f=p.length;for(var i=0;f>i;i++)e=e.replacer("@[["+i+"]]",p[i]);return p=null,n=null,t=null,e}function autoprefixer_keyframes(e){for(var t=[],r=0;-1!==r;)if(r=e.indexOf("@keyframes",r+1),-1!==r){for(var n=0,o=-1,i=r+10;i<e.length;i++)if("{"===e[i]&&n++,"}"===e[i]){if(!(n>1)){o=i;break}n--}if(-1!==o){var s=e.substring(r,o+1);t.push({name:"keyframes",property:s})}}for(var a=[],u=t.length,c=0;u>c;c++){var l=t[c].name,p=t[c].property;if("keyframes"===l){var f=p.substring(1),d="\n",m="@"+f+d;m+="@-webkit-"+f+d,m+="@-moz-"+f+d,m+="@-o-"+f+d,e=e.replacer(p,"@[["+a.length+"]]"),a.push(m)}}u=a.length;for(var c=0;u>c;c++)e=e.replace("@[["+c+"]]",a[c]);return t=null,a=null,e}function JavaScript(e){function t(){for(u=13,r(3);u!==p;)switch(u){case 32:r(a(l)?1:2);break;case 13:switch(l){case 123:case 91:case 40:case 43:case 45:r(1);break;case 32:r(3);break;default:r(a(l)?1:2)}break;default:switch(l){case 32:if(a(u)){r(1);break}r(3);break;case 13:switch(u){case 125:case 93:case 41:case 43:case 45:case 34:case 92:r(1);break;default:r(a(u)?1:3)}break;default:r(1)}}}function r(e){if(1>=e&&s(u),2>=e&&(u=l,39===u||34===u))for(;s(u),u=i(),u!==l;){if(13>=u)return void(framework&&framework.error("Error: JSMIN unterminated string literal: "+u,"JavaScript compressor"));92===u&&(s(u),u=i())}if(3>=e&&(l=n(),47===l&&(40===u||44===u||61===u||91===u||33===u||58===u||38===u||124===u||63===u||123===u||125===u||59===u||13===u))){for(s(u),s(l);u=i(),47!==u;){if(92===u)s(u),u=i();else if(13>=u)return void(c=p);s(u)}l=n()}}function n(){var e=i();if(47!==e)return e;switch(o()){case 47:for(;;)if(e=i(),13>=e)return e;
break;case 42:for(i();;)switch(i()){case 42:if(47===o())return i(),32;break;case p:return void(e=p)}break;default:return e}return e}function o(){return d=i()}function i(){var t=d;return d=p,t===p&&(t=e.charCodeAt(m++),isNaN(t)&&(t=p)),t>=32||13===t||t===p?t:10===t?13:32}function s(e){f.push(13===e||10===e?" ":String.fromCharCode(e))}function a(e){return e>=97&&122>=e||e>=48&&57>=e||e>=65&&90>=e||95===e||36===e||92===e||e>126}var u,l,p=-1,f=[],d=p,m=0;return t(),f.join("")}function MultipartParser(){this.boundary=null,this.boundaryChars=null,this.lookbehind=null,this.state=S.PARSER_UNINITIALIZED,this.index=null,this.flags=0}function View(){}function view_parse_localization(e,t){var r=view_find_localization(e,0),n="",o=0;if(null===r)return e;for(;null!==r;)null!==r&&(n+=e.substring(0===o?0:o+1,r.beg)+framework.translate(t,r.command)),o=r.end,r=view_find_localization(e,r.end);return n+=e.substring(o+1)}function view_parse(content,minify,filename){function escaper(e){var t=e.match(/[^\>]\n\s{1,}$/);return nocompressHTML?isFirst||(isFirst=!0,e=e.replace(/^\s+/,"")):e=compressHTML(e,minify),""===e?"$EMPTY":(nocompressHTML||" "!==e[0]||"<"!==e[1]||(e=e.substring(1)),!nocompressHTML&&t&&(e+=" "),null!==e.match(/\n|\r|\'|\\/)?DELIMITER_UNESCAPE+escape(e)+DELIMITER_UNESCAPE_END:DELIMITER+e+DELIMITER)}minify&&(content=removeComments(content));var nocompressHTML=!1,nocompressJS=!1,nocompressCSS=!1;content=content.replace(/@\{nocompress\s\w+}/gi,function(e){var t=e.lastIndexOf(" ");if(-1===t)return"";switch(e.substring(t,e.length-1).trim()){case"all":nocompressHTML=!0,nocompressJS=!0,nocompressCSS=!0;break;case"html":nocompressHTML=!0;break;case"js":case"script":case"javascript":nocompressJS=!0;break;case"css":case"style":nocompressCSS=!0}return""}).trim(),nocompressJS||(content=compressJS(content,0,filename)),nocompressCSS||(content=compressCSS(content,0,filename)),content=framework._version_prepare(content);var DELIMITER="'",DELIMITER_UNESCAPE="unescape('",DELIMITER_UNESCAPE_END="')",SPACE=" ",builder="var $EMPTY='';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY",command=view_find_command(content,0),compressed="",nocompress=!1,isFirst=!1,pharse="";null===command&&(builder+="+"+escaper(content));for(var old=null,newCommand="",tmp="",index=0,counter=0,functions=[],functionsName=[],isFN=!1,isSECTION=!1,isCOMPILATION=!1,builderTMP="",sectionName="",compileName="",isSitemap=!1,text;null!==command;){null!==old?(text=content.substring(old.end+1,command.beg),""!==text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text))):(text=content.substring(0,command.beg),""!==text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text)));var cmd=content.substring(command.beg+2,command.end),cmd8=cmd.substring(0,8),cmd7=cmd.substring(0,7);pharse=cmd,"compile"===cmd7&&-1===cmd.lastIndexOf(")")?(builderTMP=builder+"+(framework.onCompileView.call(self,'"+(" "===cmd8[7]?cmd.substring(8):"")+"',",builder="",sectionName=cmd.substring(8),isCOMPILATION=!0,isFN=!0):"section "===cmd8&&-1===cmd.lastIndexOf(")")?(builderTMP=builder,builder="+(function(){var $output=$EMPTY",sectionName=cmd.substring(8),isSECTION=!0,isFN=!0):"helper "===cmd7?(builderTMP=builder,builder="function "+cmd.substring(7).trim()+"{var $output=$EMPTY",isFN=!0,functionsName.push(cmd.substring(7,cmd.indexOf("(",7)).trim())):"foreach "===cmd8?(counter++,-1!==cmd.indexOf("foreach var ")&&(cmd=cmd.replace(" var ",SPACE)),newCommand=(cmd.substring(8,cmd.indexOf(SPACE,8))||"").trim(),index=cmd.trim().indexOf(SPACE,newCommand.length+10),-1===index&&(index=cmd.indexOf("[",newCommand.length+10)),builder+="+(function(){var $source="+cmd.substring(index).trim()+";if (!($source instanceof Array) || !source.length)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var i=0;i<$length;i++){index = i;var "+newCommand+"=$source[i];$output+=$EMPTY"):"end"===cmd?isFN&&0>=counter?(counter=0,isCOMPILATION?(builder=builderTMP+"unescape($EMPTY"+builder+"),model) || $EMPTY)",builderTMP=""):isSECTION?(builder=builderTMP+builder+";repository['$section_"+sectionName+"']=$output;return $EMPTY})()",builderTMP=""):(builder+=";return $output;}",functions.push(builder),builder=builderTMP,builderTMP=""),isSECTION=!1,isCOMPILATION=!1,isFN=!1):(counter--,builder+="}return $output;})()",newCommand=""):"if "===cmd.substring(0,3)?builder+=";if ("+cmd.substring(3)+"){$output+=$EMPTY":"else"===cmd?builder+="} else {$output+=$EMPTY":"endif"===cmd||"fi"===cmd?builder+="}$output+=$EMPTY":(tmp=view_prepare(command.command,newCommand,functionsName,function(){nocompress=!0}),tmp&&(view_parse_plus(builder)&&(builder+="+"),builder+=wrapTryCatch(tmp,command.command))),old=command,command=view_find_command(content,command.end),command&&command.command&&-1!==command.command.indexOf("sitemap(")&&(isSitemap=!0)}null!==old&&(text=content.substring(old.end+1),text&&(builder+="+"+escaper(text)));var fn="(function(self,repository,model,session,query,body,url,global,helpers,user,config,functions,index,output,date,cookie,files,mobile){var get=query;var post=body;var language=this.language;var cookie=function(name){return controller.req.cookie(name);};"+(isSitemap?"var sitemap=function(){return self.sitemap.apply(self,arguments);};":"")+(functions.length?functions.join("")+";":"")+"var controller=self;"+builder+";return $output;})";return eval(fn)}function wrapTryCatch(e,t){return framework.isDebug?"(function(){try{return "+e+"}catch(e){throw new Error(unescape('"+escape(t)+"') + ' - ' + e.message.toString());}return $EMPTY})()":e}function view_parse_plus(e){var t=e[e.length-1];return"!"!==t&&"?"!==t&&"+"!==t&&"."!==t&&":"!==t?!0:!1}function view_prepare(e,t,r){var n=e.indexOf("."),o=e.indexOf("("),i=e.indexOf("["),s=[],a=0;-1!==n&&s.push(n),-1!==o&&s.push(o),-1!==i&&s.push(i);var u=Math.min.apply(this,s);-1===u&&(u=e.length);var c=e.substring(0,u);if(c===t)return"$STRING("+e+").encode()";if("!"===c[0]&&c.substring(1)===t)return"$STRING("+e.substring(1)+")";switch(c){case"foreach":case"end":return"";case"section":return a=e.indexOf("("),-1===a?"":"(repository['$section_"+e.substring(a+1,e.length-1).replace(/\'/g,"")+"'] || '')";case"log":case"LOG":return"("+("log"===c?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"logger":case"LOGGER":return"("+("logger"===c?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"console":return"("+e+"?$EMPTY:$EMPTY)";case"cookie":return"$STRING("+e+").encode()";case"!cookie":return"$STRING("+e+")";case"isomorphic":return"$STRING("+e+").encode()";case"!isomorphic":return"$STRING("+e+")";case"model":case"repository":case"get":case"post":case"query":case"global":case"session":case"user":case"config":case"controller":return view_is_assign(e)?"self.$set("+e+")":"$STRING("+e+").encode()";case"body":return view_is_assign(e)?"self.$set("+e+")":-1===e.lastIndexOf(".")?"output":"$STRING("+e+").encode()";case"files":return e;case"mobile":return e;case"CONFIG":case"FUNCTION":case"MODEL":case"SCHEMA":case"MODULE":case"functions":return"$STRING("+e+").encode()";case"!controller":case"!repository":case"!get":case"!post":case"!body":case"!query":case"!global":case"!session":case"!user":case"!config":case"!functions":case"!model":case"!CONFIG":case"!SCHEMA":case"!FUNCTION":case"!MODEL":case"!MODULE":return"$STRING("+e.substring(1)+")";case"language":return e;case"resource":case"RESOURCE":return"$STRING(self."+e+").encode()";case"!resource":case"!RESOURCE":return"$STRING(self."+e.substring(1)+")";case"host":case"hostname":return-1===e.indexOf("(")?"self.host()":"self."+e;case"url":return-1!==e.indexOf("(")?"self.$"+e:"self."+e;case"title":case"description":case"keywords":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '').toString().encode()";case"!title":case"!description":case"!keywords":return"(repository['$"+e.substring(1)+"'] || '')";case"head":return-1!==e.indexOf("(")?"self.$"+e:"self."+e+"()";case"sitemap":case"place":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '')";case"meta":return-1!==e.indexOf("(")?"self.$"+e:"self.$meta()";case"js":case"script":case"css":case"favicon":case"import":return"self.$"+e+(-1===e.indexOf("(")?"()":"");case"index":return"("+e+")";case"routeJS":case"routeCSS":case"routeScript":case"routeStyle":case"routeImage":case"routeFont":case"routeDownload":case"routeVideo":case"routeStatic":return"self."+e;case"translate":return"self."+e;case"json":case"image":case"layout":case"template":case"templateToggle":case"view":case"viewToggle":case"helper":case"download":case"selected":case"currentContent":case"currentCSS":case"currentDownload":case"currentImage":case"currentJS":case"currentTemplate":case"currentVideo":case"currentView":case"disabled":case"checked":case"etag":case"header":case"modified":case"options":case"readonly":case"canonical":case"dns":case"next":case"prefetch":case"prerender":case"prev":return"self.$"+e;case"now":return"(new Date()"+e.substring(3)+")";case"radio":case"text":case"checkbox":case"hidden":case"textarea":case"password":return"self.$"+exports.appendModel(e);default:return framework.helpers[c]?"helpers."+view_insert_call(e):"$STRING("+(-1===r.indexOf(c)?"!"===e[0]?e.substring(1)+")":e+").encode()":e+")")}return e}function view_insert_call(e){var t=e.indexOf("(");if(-1===t)return e;for(var r=e.length,n=0,o=t+1;r>o;o++){var i=e[o];if("("===i||")"===i)if("("!==i){if(!(n>0)){var s=e.substring(t+1);return e.substring(0,t)+".call(self"+(s.length>1?","+s:")")}n--}else n++}return e}function view_is_assign(e){for(var t=e.length,r=0,n=0;t>n;n++){var o=e[n];if("["!==o)if("]"!==o){var i=e[n+1]||"";if("+"===o&&("+"===i||"="===i)&&0===r)return!0;if("-"===o&&("-"===i||"="===i)&&0===r)return!0;if("*"===o&&("*"===i||"="===i)&&0===r)return!0;if("="===o&&0===r)return!0}else r--;else r++}return!1}function view_find_command(e,t){if(t=e.indexOf("@{",t),-1===t)return null;for(var r=e.length,n=0,o=t+2;r>o;o++){var i=e[o];if("{"!==i){if("}"===i){if(!(n>0))return{beg:t,end:o,command:e.substring(t+2,o).trim()};n--}}else n++}return null}function view_find_localization(e,t){if(t=e.indexOf("@(",t),-1===t)return null;for(var r=e.length,n=0,o=t+2;r>o;o++){var i=e[o];if("("!==i){if(")"===i){if(!(n>0))return{beg:t,end:o,command:e.substring(t+2,o).trim()};n--}}else n++}return null}function removeCondition(e,t){if(t){if("+"===e[0])return e.substring(1,e.length)}else if("+"===e[e.length-1])return e.substring(0,e.length-1);return e}function removeComments(e){for(var t="<!--",r="-->",n=e.indexOf(t),o=0;-1!==n&&(o=e.indexOf(r,n+4),-1!==o);){var i=e.substring(n,o+3);-1===i.indexOf("[if")&&-1===i.indexOf("[endif")?(e=e.replacer(i,""),n=e.indexOf(t,o+3)):n=e.indexOf(t,o+3)}return e}function compressJS(e,t,r){if(!framework.config["allow-compile-script"])return e;var n='<script type="text/javascript">',o="</script>",i=e.indexOf(n,t||0);if(-1===i&&(n="<script>",i=e.indexOf(n,t||0),-1===i))return e;var s=e.indexOf(o,i+n.length);if(-1===s)return e;var a=e.substring(i,s+o.length).trim(),u=e.indexOf(a);if(-1===u)return e;var c=a.substring(n.length,a.length-o.length).trim(),l=exports.compile_javascript(c,r);return e=e.replacer(a,n+l.dollar().trim()+o.trim()),compressJS(e,i+l.length+9,r)}function compressCSS(e,t,r){var n='<style type="text/css">',o="</style>",i=e.indexOf(n,t||0);if(-1===i&&(n="<style>",i=e.indexOf(n,t||0),-1===i))return e;var s=e.indexOf(o,i+n.length);if(-1===s)return e;var a=e.substring(i,s+o.length),u=a.substring(n.length,a.length-o.length).trim(),c=exports.compile_css(u,r);return e=e.replacer(a,(n+c.trim()+o).trim()),compressCSS(e,i+c.length+8,r)}function variablesCSS(e){if(!e)return e;var t={};return e=e.replace(/\$[a-z0-9-_]+\:.*?;/gi,function(e){var r=e.indexOf(":");if(-1===r)return e;var n=e.substring(0,r).trim();return t[n]=e.substring(r+1,e.length-1).trim(),""}),e=e.replace(/\$[a-z0-9-_]+/gi,function(e,r){var n=(e.length+r,t[e]);return n?n:e}).trim()}function nested(e,t,r){if(!e)return e;for(var n,o,i=0,s="",a=!1,u=0,c=!1,l="",p=!1,f="";;){var d=e[i++];if(!d)break;if("\n"!==d&&"\r"!==d)if("$"===d&&r&&r(),"@"===d&&(o=i,p=!0),!p||f||";"!==d&&"{"!==d||(f=d,";"!==d))if(l+=d,"{"!==d){if("}"===d){if(u>0){u--,c=!0;continue}if(!c){s+=l,l="",a=!1,p=!1,f="";continue}if(p){-1!==l.indexOf("@keyframes")?s+=l:(o=l.indexOf("{"),s+=l.substring(0,o+1)+process_nested(l.substring(o),t).trim()+"}"),a=!1,p=!1,f="",l="";continue}for(var m=n-1,h="";;){var g=e[m--];if("{"!==g){if("}"===g||"\n"===g||"\r"===g||void 0===g||f&&f===g)break;h=g+h}}a=!1,p=!1,f="",l="",s+=process_nested(e.substring(n-1,i),(t||"")+h.trim())}}else{if(a){u++;continue}a=!0,u=0,n=i,c=!1}else s+=e.substring(o-1,i),p=!1,l=""}return s+l}function process_nested(e,t){return e=e.trim(),e=make_nested(e.substring(1,e.length-1),t),nested(e,t)}function make_nested(e,t){for(var r,n=0,o="",i="",s=0,a=!1,u=!1;;){var c=e[n++];if(!c)break;if("\n"!==c&&"\r"!==c)if((" "!==c||" "!==o[o.length-1])&&(o+=c),"{"!==c){if("}"===c){if(s>0){s--,u=!0;continue}if(!u){i+=t+" "+o.trim(),o="",a=!1;continue}i+=o}}else{if(a){s++;continue}a=!0,s=0,r=n,u=!1}}return i}function compressHTML(e,t){if(null===e||""===e||!t)return e;e=removeComments(e);for(var r=["script","textarea","pre","code"],n="["+(new Date).getTime()+"]#",o={},i=0,s=r.length,a=0;s>a;a++)for(var u=r[a],c="<"+u,l="</"+u,p=e.indexOf(c),f=0,d=l.length;-1!==p&&(f=e.indexOf(l,p+3),-1!==f);){var m=n+i++,h=e.substring(p,f+d);if(0===a){if(f=h.indexOf(">"),d=h.indexOf('type="text/template"'),f>d&&-1!==d)break;if(d=h.indexOf('type="text/html"'),f>d&&-1!==d)break;if(d=h.indexOf('type="text/ng-template"'),f>d&&-1!==d)break}o[m]=h,e=e.replacer(h,m),p=e.indexOf(c,p+c.length)}e=e.replace(/>\n\s+/g,">").replace(/(\w|\W)\n\s+</g,function(e){return e.trim().replace(/\s/g,"")}).replace(REG_5,"><").replace(REG_4,function(e){var t=e[e.length-1];return"<"===t?t:" "+t}).replace(REG_1,"").replace(REG_2,"");for(var m in o)e=e.replacer(m,o[m]);return e}function cleanURL(e,t){for(var r,n=e.substring(0,t),o=!1,i=t,s=e.length;s>i;i++){var a=e[i];("/"!==a||"/"!==r||o)&&(r=a,n+=a)}return n}function destroyStream(e){return e instanceof ReadStream?(e.destroy(),typeof e.close!==FUNCTION?e:(e.on("open",function(){typeof this.fd===NUMBER&&this.close()}),e)):e instanceof Stream?(typeof e.destroy===FUNCTION&&e.destroy(),e):e}function first(e,t){function r(){n(),t.apply(null,arguments)}function n(){for(var e,t=0,r=i.length;r>t;t++)e=i[t],e.ee.removeListener(e.event,e.fn)}function o(e){t=e}for(var i=[],s=0,a=e.length;a>s;s++)for(var u=e[s],c=u[0],l=1,p=u.length;p>l;l++){var f=u[l],d=listener(f,r);c.on(f,d),i.push({ee:c,event:f,fn:d})}return o.cancel=n,o}function listener(e,t){return function(r){for(var n=new Array(arguments.length),o=this,i="error"===e?r:null,s=0;s<n.length;s++)n[s]=arguments[s];t(i,o,e,n)}}function onFinished(e,t){return isFinished(e)!==!1?(setImmediate(t,null,e),e):(attachListener(e,t),e)}function attachFinishedListener(e,t){function r(e){o.cancel(),i.cancel(),s=!0,t(e)}function n(t){e.removeListener("socket",n),s||o!==i||(i=first([[t,"error","close"]],r))}var o,i,s=!1;return o=i=first([[e,"end","finish"]],r),e.socket?void n(e.socket):(e.on("socket",n),void(void 0===e.socket&&patchAssignSocket(e,n)))}function attachListener(e,t){var r=e.__onFinished;r&&r.queue||(r=e.__onFinished=createListener(e),attachFinishedListener(e,r)),r.queue.push(t)}function createListener(e){function t(r){if(e.__onFinished===t&&(e.__onFinished=null),t.queue){var n=t.queue;t.queue=null;for(var o=0,i=n.length;i>o;o++)n[o](r,e)}}return t.queue=[],t}function patchAssignSocket(e,t){var r=e.assignSocket;typeof r===FUNCTION&&(e.assignSocket=function(e){r.call(this,e),t(e)})}function isFinished(e){var t=e.socket;return typeof e.finished===BOOLEAN?Boolean(e.finished||t&&!t.writable):typeof e.complete===BOOLEAN?Boolean(e.upgrade||!t||!t.readable||e.complete&&!e.readable):void 0}var exports=module.exports;global.framework_internal=module.exports;var crypto=require("crypto"),fs=require("fs"),ReadStream=require("fs").ReadStream,Stream=require("stream"),ENCODING="utf8",UNDEFINED="undefined",FUNCTION="function",OBJECT="object",BOOLEAN="boolean",NUMBER="number",REG_1=/[\n\r\t]+/g,REG_2=/\s{2,}/g,REG_3=/\/{1,}/g,REG_4=/\n\s{2,}./g,REG_5=/>\n\s{1,}</g,HTTPVERBS={GET:!0,POST:!0,OPTIONS:!0,PUT:!0,DELETE:!0,PATCH:!0,upload:!0,HEAD:!0,TRACE:!0,PROPFIND:!0};global.$STRING=function(e){return null===e||void 0===e?"":e.toString()},exports.parseMULTIPART=function(e,t,r,n,o){for(var i=new MultipartParser,s=t.split(";")[1],a=0,u=null,c=r.length,l=Date.now(),p=new HttpFile,f=0,d=null,m="",h=0,g=e.ip.length;g>h;h++)"."!==e.ip[h]&&(m+=e.ip[h]);s=s.substring(s.indexOf("=",2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,i.initWithBoundary(s),i.onPartBegin=function(){p.$data=new Buffer(""),p.$step=0,p.$is=!1,p.length=0},i.onHeaderValue=function(t,r,o){if(!e.buffer_exceeded){var i=t.slice(r,o).toString(ENCODING);if(1===p.$step){var s=i.indexOf(";");return p.type=-1===s?i.trim():i.substring(0,s).trim(),void(p.$step=2)}if(0===p.$step){if(i=parse_multipart_header(i),p.$step=1,p.$is=null!==i[1],p.name=i[0],!p.$is)return void destroyStream(u);p.filename=i[1],p.path=framework_utils.combine(n,m+"-"+l+"-"+framework_utils.random(1e5)+".upload"),u=fs.createWriteStream(p.path,{flags:"w"}),u.once("close",function(){f--}),u.once("error",function(){f--}),f++}}},i.onPartData=function(t,r,n){if(!e.buffer_exceeded){var o=t.slice(r,n),i=o.length;if(a+=i,a>=c)return e.buffer_exceeded=!0,void(null===d?d=[p.path]:d.push(p.path));if(!p.$is)return void(p.$data=Buffer.concat([p.$data,o]));if(p.length)return u.write(o),void(p.length+=i);var s=null;if(!e.behaviour("disable-measuring"))switch(p.type){case"image/jpeg":s=framework_image.measureJPG(t.slice(r));break;case"image/gif":s=framework_image.measureGIF(o);break;case"image/png":s=framework_image.measurePNG(o);break;case"image/svg+xml":s=framework_image.measureSVG(o)}s?(p.width=s.width,p.height=s.height):(p.width=0,p.height=0),framework.emit("upload-begin",e,p),u.write(o),p.length+=i}},i.onPartEnd=function(){if(null!==u&&(u.end(),u=null),!e.buffer_exceeded){if(p.$is)return delete p.$data,delete p.$is,delete p.$step,e.files.push(p),void framework.emit("upload-end",e,p);p.$data=p.$data.toString(ENCODING);var t=e.body[p.name];if(void 0===t)return void(e.body[p.name]=p.$data);if(t instanceof Array)return void e.body[p.name].push(p.$data);t=[t],t.push(p.$data),e.body[p.name]=t}},i.onEnd=function(){var e=function(){return f>0?void setImmediate(e):(null!==d&&framework.unlink(d),void o.doEnd())};e()},e.on("data",function(e){i.write(e)}),e.on("end",function(){i.end()})},exports.routeSplit=function(e,t){var r;if(!t&&(r=framework.temporary.other[e]))return r;if(!e||"/"===e)return r=new Array(1),r[0]="/",r;var n=!1,o="",i=0;r=[];for(var s=0,a=e.length;a>s;s++){var u=e[s];if("/"!==u)o+=t?u:u.toLowerCase(),n="/"===u;else{if(n)continue;o&&(r.push(o),i++,o="")}}return o?r.push(o):0===i&&r.push("/"),r},exports.routeSplitCreate=function(e,t){t||(e=e.toLowerCase()),"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));for(var r=0,n=0,o=[],i=0,s=e.length;s>i;i++)switch(e[i]){case"/":if(0!==r)break;o.push(e.substring(n+(o.length?1:0),i)),n=i;break;case"{":r++;break;case"}":r--}return 0===r&&o.push(e.substring(n+(o.length?1:0),e.length)),1===o.length&&""===o[0]&&(o[0]="/"),o},exports.routeCompare=function(e,t,r,n){var o=e.length,i=t.length;if(i!==o&&!n)return!1;if(n&&1===i&&"/"===t[0])return!0;for(var s=1===o&&"/"===e[0],a=0;o>a;a++){var u=t[a];if(!r&&n&&void 0===u)return!0;if((r||s||"{"!==u[0])&&e[a]!==u)return r?!1:n?a>=i:!1}return!0},exports.routeCompareSubdomain=function(e,t){return null!==t&&null!==e&&t.length?t.indexOf(e)>-1:!0},exports.routeCompareFlags=function(e,t,r){for(var n=!1,o=e,i=t,s=e.length,a=t.length,u=s>a?o:i,c=s>a?i:o,l=Math.max(s,a),p="authorize",f="unauthorize",d=0;l>d;d++){var m=u[d],h=m[0];if("!"!==h&&"#"!==h&&"$"!==h&&"@"!==h&&"+"!==h&&(!r||m!==p&&m!==f)){var g=c.indexOf(m),v=m.toUpperCase();if(-1===g&&!HTTPVERBS[v])return m===p||m===f?-1:0;n=n||-1!==g&&HTTPVERBS[v]}}return n?1:0},exports.routeCompareFlags2=function(e,t,r){if(!t.isWEBSOCKET){if(t.isXHR&&!e.xhr)return 0;if(t.isMOBILE&&!e.mobile)return 0;var n=e.method;if(t.method){if(t.method!==n)return 0}else if(-1===t.flags.indexOf(n.toLowerCase()))return 0;if(t.isREFERER&&-1===e.flags.indexOf("referer"))return 0;if(!t.isMULTIPLE&&t.isJSON&&-1===e.flags.indexOf("json"))return 0}for(var o=!1,i=0,s=e.flags.length;s>i;i++){var a=e.flags[i];switch(a){case"json":continue;case"proxy":if(!t.isPROXY)return 0;continue;case"debug":if(!t.isDEBUG&&t.isRELEASE)return 0;continue;case"release":if(!t.isRELEASE&&t.isDEBUG)return 0;continue;case"referer":continue;case"upload":if(!t.isUPLOAD)return 0;continue;case"https":if(!t.isHTTPS&&t.isHTTP)return 0;continue;case"http":if(!t.isHTTP&&t.isHTTPS)return 0;continue;case"xhr":case"+xhr":if(!t.isBOTH&&!t.isXHR)return 0;continue}if(!r||!t.isMEMBER){var u="@"===a[0];if(!u||!o){var c=t.flags.indexOf(a);if(-1===c)return t.isMEMBER?0:-1;u&&(o=!0)}}}return 1},exports.routeParam=function(e,t){if(!t||!e)return[];var r=t.param.length,n=new Array(r);if(0===r)return n;for(var o=0;r>o;o++){var i=e[t.param[o]];n[o]="/"===i?"":i}return n},HttpFile.prototype={get contentType(){return console.log("OBSOLETE: The HttpFile.contentType is deprecated. Use: HttpFile.type"),this.type}},HttpFile.prototype.copy=function(e,t){var r=this;if(!t)return void fs.createReadStream(r.path).pipe(fs.createWriteStream(e));var n=fs.createReadStream(r.path),o=fs.createWriteStream(e);return n.on("close",t),n.pipe(o),r},HttpFile.prototype.$$copy=function(e){var t=this;return function(r){return t.copy(e,r)}},HttpFile.prototype.readSync=function(){return fs.readFileSync(this.path)},HttpFile.prototype.read=function(e){var t=this;return fs.readFile(t.path,e),t},HttpFile.prototype.$$read=function(){var e=this;return function(t){e.read(t)}},HttpFile.prototype.md5=function(e){var t=this,r=crypto.createHash("md5"),n=fs.createReadStream(t.path);return n.on("data",function(e){r.update(e)}),n.on("error",function(t){e(t,null)}),onFinished(n,function(){destroyStream(n),e(null,r.digest("hex"))}),t},HttpFile.prototype.$$md5=function(){var e=this;return function(t){e.md5(t)}},HttpFile.prototype.stream=function(e){var t=this;return fs.createReadStream(t.path,e)},HttpFile.prototype.pipe=function(e,t){var r=this;return fs.createReadStream(r.path,t).pipe(e,t)},HttpFile.prototype.isImage=function(){var e=this;return-1!==e.type.indexOf("image/")},HttpFile.prototype.isVideo=function(){var e=this;return-1!==e.type.indexOf("video/")},HttpFile.prototype.isAudio=function(){var e=this;return-1!==e.type.indexOf("audio/")},HttpFile.prototype.image=function(e){var t=e;return void 0===t&&(t="im"===framework.config["default-image-converter"]),framework_image.init(this.path,t,this.width,this.height)},exports.compile_css=function(e,t){if(global.framework){if(framework.modificators)for(var r=0,n=framework.modificators.length;n>r;r++){var o=framework.modificators[r]("style",t,e);o&&(e=o)}if(null!==framework.onCompileStyle)return framework.onCompileStyle(t,e);if(null!==framework.onCompileCSS)return console.log("OBSOLETE: framework.onCompileCSS() is deprecated, use framework.onCompileStyle()"),framework.onCompileCSS(t,e)}try{var i=!1;return e=nested(e,"",function(){i=!0}),e=compile_autovendor(e),i&&(e=variablesCSS(e)),e}catch(s){return framework.error(new Error("CSS compiler exception: "+s.message)),""}},exports.compile_javascript=function(e,t){var r=typeof global.framework===OBJECT;try{if(r){if(framework.modificators)for(var n=0,o=framework.modificators.length;o>n;n++){var i=framework.modificators[n]("script",t,e);i&&(e=i)}if(null!==framework.onCompileScript)return framework.onCompileScript(t,e).trim();if(null!==framework.onCompileJS)return console.log("OBSOLETE: framework.onCompileJS() is deprecated, use framework.onCompileScript()"),framework.onCompileJS(t,e).trim()}return JavaScript(e).trim()}catch(s){return r&&framework.error(s,"JavaScript compressor"),e}},exports.compile_html=function(e){return compressHTML(e,!0)};var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,F={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return 32|e};for(s in S)exports[s]=S[s];return exports.MultipartParser=MultipartParser,MultipartParser.stateToString=function(e){for(var t in S){var r=S[t];if(r===e)return t}},MultipartParser.prototype.initWithBoundary=function(e){var t=this;t.boundary=new Buffer(e.length+4),framework.versionNode>0?(t.boundary.write("\r\n--",0,"ascii"),t.boundary.write(e,4,"ascii")):(t.boundary.write("\r\n--","ascii",0),t.boundary.write(e,"ascii",4)),t.lookbehind=new Buffer(t.boundary.length+8),t.state=S.START,t.boundaryChars={};for(var r=0;r<t.boundary.length;r++)t.boundaryChars[t.boundary[r]]=!0},MultipartParser.prototype.write=function(e){var t,r,n=this,o=0,i=e.length,s=n.index,a=n.index,u=n.state,c=n.flags,l=n.lookbehind,p=n.boundary,f=n.boundaryChars,d=n.boundary.length,m=d-1,h=e.length,g=function(e){n[e+"Mark"]=o},v=function(e){delete n[e+"Mark"]},y=function(e,t,r,o){if(void 0===r||r!==o){var i="on"+e.substr(0,1).toUpperCase()+e.substr(1);i in n&&n[i](t,r,o)}},b=function(t,r){var i=t+"Mark";i in n&&(r?(y(t,e,n[i],o),delete n[i]):(y(t,e,n[i],e.length),n[i]=0))};for(o=0;i>o;o++)switch(t=e[o],u){case S.PARSER_UNINITIALIZED:return o;case S.START:a=0,u=S.START_BOUNDARY;case S.START_BOUNDARY:if(a==p.length-2){if(t==HYPHEN)c|=F.LAST_BOUNDARY;else if(t!=CR)return o;a++;break}if(a-1==p.length-2){if(c&F.LAST_BOUNDARY&&t==HYPHEN)y("end"),u=S.END,c=0;else{if(c&F.LAST_BOUNDARY||t!=LF)return o;a=0,y("partBegin"),u=S.HEADER_FIELD_START}break}t!=p[a+2]&&(a=-2),t==p[a+2]&&a++;break;case S.HEADER_FIELD_START:u=S.HEADER_FIELD,g("headerField"),a=0;case S.HEADER_FIELD:if(t==CR){v("headerField"),u=S.HEADERS_ALMOST_DONE;break}if(a++,t==HYPHEN)break;if(t==COLON){if(1==a)return o;b("headerField",!0),u=S.HEADER_VALUE_START;break}if(r=lower(t),A>r||r>Z)return o;break;case S.HEADER_VALUE_START:if(t==SPACE)break;g("headerValue"),u=S.HEADER_VALUE;case S.HEADER_VALUE:t==CR&&(b("headerValue",!0),y("headerEnd"),u=S.HEADER_VALUE_ALMOST_DONE);break;case S.HEADER_VALUE_ALMOST_DONE:if(t!=LF)return o;u=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(t!=LF)return o;y("headersEnd"),u=S.PART_DATA_START;break;case S.PART_DATA_START:u=S.PART_DATA,g("partData");case S.PART_DATA:if(s=a,0===a){for(o+=m;h>o&&!(e[o]in f);)o+=d;o-=m,t=e[o]}if(a<p.length)p[a]==t?(0===a&&b("partData",!0),a++):a=0;else if(a==p.length)a++,t==CR?c|=F.PART_BOUNDARY:t==HYPHEN?c|=F.LAST_BOUNDARY:a=0;else if(a-1==p.length)if(c&F.PART_BOUNDARY){if(a=0,t==LF){c&=~F.PART_BOUNDARY,y("partEnd"),y("partBegin"),u=S.HEADER_FIELD_START;break}}else c&F.LAST_BOUNDARY&&t==HYPHEN?(y("partEnd"),y("end"),u=S.END,c=0):a=0;a>0?l[a-1]=t:s>0&&(y("partData",l,0,s),s=0,g("partData"),o--);break;case S.END:break;default:return o}return b("headerField"),b("headerValue"),b("partData"),n.index=a,n.state=u,n.flags=c,i},MultipartParser.prototype.end=function(){var e=this,t=function(e,t){var r="on"+t.substr(0,1).toUpperCase()+t.substr(1);r in e&&e[r]()};if(e.state==S.HEADER_FIELD_START&&0===e.index||e.state==S.PART_DATA&&e.index==e.boundary.length)t(e,"partEnd"),t(e,"end");else if(e.state!=S.END)return t(e,"partEnd"),t(e,"end"),new Error("MultipartParser.end(): stream ended unexpectedly: "+e.explain())},MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)},View.prototype.read=function(e,t){var r=framework.config,n="."===e[0],o=n?e.substring(1):framework.path.views(e);if(fs.existsSync(o))return view_parse(view_parse_localization(this.modify(fs.readFileSync(o).toString("utf8"),o),t),r["allow-compile-html"],o);if(n)return null;var i=e.lastIndexOf("/");return-1===i?null:(o=framework.path.views(e.substring(i+1)),fs.existsSync(o)?view_parse(view_parse_localization(this.modify(fs.readFileSync(o).toString("utf8"),o),t),r["allow-compile-html"],o):null)},View.prototype.modify=function(e,t){if(!framework.modificators)return e;for(var r=0,n=framework.modificators.length;n>r;r++){var o=framework.modificators[r]("view",t,e);o&&(e=o)}return e},View.prototype.load=function(e,t,r){var n=this;if(-1!==e.indexOf("@{")||-1!==e.indexOf("<"))return n.dynamic(e,r);var o=framework.routes.views[e];o?t="."+o.filename:t+=".html";var i="view#"+t;r&&(i+=r);var s=framework.temporary.views[i]||null;return null!==s?s:(s=n.read(t,r),framework.isDebug||(framework.temporary.views[i]=s),s)},View.prototype.dynamic=function(e,t){var r=e.hash(),n=framework.temporary.views[r]||null;return null!==n?n:(n=view_parse(view_parse_localization(this.modify(e,""),t),framework.config["allow-compile-html"]),framework.isDebug||(framework.temporary.views[r]=n),n)},exports.generateView=function(e,t,r){return(new View).load(e,t,r)},exports.appendModel=function(e){var t=e.indexOf("(");if(-1===t)return e;var r=e.substring(t+1);return e.substring(0,t)+"(model"+(")"===r[0]?r:","+r)},exports.parseURI=function(e,t){var r,n,o=t.host.lastIndexOf(":"),i=t.url.indexOf("?",1),s=null;-1===o?(o=null,r=t.host):(r=t.host.substring(0,o),o=t.host.substring(o+1)),-1===i?(i=null,n=t.url):(n=t.url.substring(0,i),i=t.url.substring(i),s=i.substring(1));var a=n.indexOf("//");return-1!==a&&(n=cleanURL(n,a),t.url=n,i&&(t.url+=i)),{auth:null,hash:null,host:t.host,hostname:r,href:e+"://"+t.host+t.url,path:t.url,pathname:n,port:o,protocol:e+":",query:s,search:i,slashes:!0}},exports.parseLocalization=view_parse_localization,exports.findLocalization=view_find_localization,exports.destroyStream=destroyStream,exports.onFinished=onFinished,module}({exports:{}});var qs=require("querystring"),os=require("os"),fs=require("fs"),zlib=require("zlib"),path=require("path"),crypto=require("crypto"),parser=require("url"),events=require("events"),http=require("http"),directory=process.cwd(),child=require("child_process"),util=require("util"),ENCODING="utf8",UNDEFINED="undefined",STRING="string",TYPE_FUNCTION="function",NUMBER="number",OBJECT="object",BOOLEAN="boolean",EXTENSION_JS=".js",RESPONSE_HEADER_CACHECONTROL="Cache-Control",RESPONSE_HEADER_CONTENTTYPE="Content-Type",RESPONSE_HEADER_CONTENTLENGTH="Content-Length",CONTENTTYPE_TEXTPLAIN="text/plain",CONTENTTYPE_TEXTHTML="text/html",REQUEST_COMPRESS_CONTENTTYPE={"text/plain":!0,"text/javascript":!0,"text/css":!0,"application/x-javascript":!0,"application/json":!0,"text/xml":!0,"image/svg+xml":!0,"text/x-markdown":!0,"text/html":!0},TEMPORARY_KEY_REGEX=/\//g,REG_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i,REG_VERSIONS=/(href|src)="[a-zA-Z0-9\/\:\-\.]+\.(jpg|js|css|png|gif|svg|html|ico|json|less|sass|scss|swf|txt|webp|woff|woff2|xls|xlsx|xml|xsl|xslt|zip|rar|csv|doc|docx|eps|gzip|jpe|jpeg|manifest|mov|mp3|mp4|ogg|package|pdf)"/gi,REQUEST_PROXY_FLAGS=["post","json"],_controller="",_test;global.framework_internal||(global.framework_internal=require("./internal")),global.framework_builders||(global.framework_builders=require("./builders")),global.framework_utils||(global.framework_utils=require("./utils")),global.framework_mail||(global.framework_mail=require("./mail")),global.framework_image||(global.framework_image=global.Image=require("./image")),global.framework_nosql||(global.framework_nosql=require("./nosql")),global.Builders=global.builders=framework_builders;var utils=global.Utils=global.utils=global.U=framework_utils;global.Mail=global.MAIL=framework_mail,global.include=global.INCLUDE=global.source=global.SOURCE=function(e,t){return framework.source(e,t)},global.MODULE=function(e){return framework.module(e)},global.DB=global.DATABASE=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},global.CONFIG=function(e){return framework.config[e]
},global.INSTALL=function(e,t,r,n,o){return framework.install(e,t,r,n,o)},global.UNINSTALL=function(e,t,r){return framework.uninstall(e,t,r)},global.RESOURCE=function(e,t){return framework.resource(e,t)},global.TRANSLATE=function(e,t){return framework.translate(e,t)},global.TRANSLATOR=function(e,t){return framework.translator(e,t)},global.LOG=function(){return framework.log.apply(framework,arguments)},global.LOGGER=function(){return framework.logger.apply(framework,arguments)},global.MODEL=function(e){return framework.model(e)},global.SCHEMA=function(e,t,r){return Builders.load(e,t,r)},global.GETSCHEMA=function(e,t){return Builders.getschema(e,t)},global.NEWSCHEMA=function(e,t){return t||(t=e,e="default"),Builders.newschema(e,t)},global.FUNCTION=function(e){return framework.functions[e]},global.ROUTING=function(e){return framework.routing(e)},global.SCHEDULE=function(e,t,r){return framework.schedule(e,t,r)},global.FINISHED=function(e,t){framework_internal.onFinished(e,t)},global.DESTROY=function(e){framework_internal.destroyStream(e)},global.CLEANUP=function(e,t){FINISHED(e,function(){t&&t(),DESTROY(e)})},global.SUCCESS=function(e,t){var r;e instanceof Error?(r=e,e=!1):e instanceof Builders.ErrorBuilder?e.hasError()?(r=e.output(),e=!1):e=!0:(null===e||void 0===e)&&(e=!0);var n={success:e};return r&&(n.error=r),void 0===t?n:(n.value=t,n)},void 0===global.setImmediate&&(global.setImmediate=function(e){process.nextTick(e)}),global.DEBUG=!1,global.TEST=!1,global.RELEASE=!1,global.is_client=!1,global.is_server=!0,Framework.prototype={get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async}},Framework.prototype.__proto__=new events.EventEmitter,Framework.prototype.behaviour=function(e,t){var r=this;r.behaviours||(r.behaviours={}),typeof t===STRING&&(t=[t]),r.behaviours[e]||(r.behaviours[e]={});for(var n=0;n<t.length;n++)r.behaviours[e][t[n]]=!0;return r},Framework.prototype.refresh=function(){var e=this;return e.emit("clear","refresh"),e.resources={},e.databases={},e._configure(),e._configure_versions(),e.temporary.path={},e.temporary.range={},e.temporary.views={},e.temporary.other={},e.emit("reconfigure"),e},Framework.prototype.controller=function(e){return this.controllers[e]||null},Framework.prototype.useConfig=function(e){return this._configure(e,!0)},Framework.prototype._routesSort=function(){var e=this;e.routes.web.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0}),e.routes.websockets.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0});for(var t={},r=e.routes.web.length,n=0;r>n;n++){var o=e.routes.web[n];if(o.isMOBILE&&!(o.isUPLOAD||o.isXHR||o.isJSON||o.isSYSTEM||o.isXML)&&-1!==o.flags.indexOf("get")){var i=o.url.join("/");t[i]=!0}}for(var n=0;r>n;n++){var o=e.routes.web[n];if(!(o.isMOBILE||o.isUPLOAD||o.isXHR||o.isJSON||o.isSYSTEM||o.isXML)&&-1!==o.flags.indexOf("get")){var i=o.url.join("/");o.isMOBILE_VARY=t[i]===!0}}return e},Framework.prototype.database=function(e){var t=this,r=t.databases[e];return void 0!==r?r:(t.path.verify("databases"),r=framework_nosql.load(path.join(directory,this.config["directory-databases"],e),path.join(directory,this.config["directory-databases"],e+"-binary"),!0),t.databases[e]=r,r)},Framework.prototype.stop=function(e){var t=this;for(var r in framework.workers){var n=framework.workers[r];n&&n.kill&&n.kill(e||"SIGTERM")}return framework.emit("exit"),typeof process.send===TYPE_FUNCTION&&process.send("stop"),t.cache.stop(),t.server&&t.server.close(),process.exit(e||"SIGTERM"),t},Framework.prototype.redirect=function(e,t,r,n){var o=this,i=e.startsWith("http://")||e.startsWith("https");if(i===!1){"/"!==e[0]&&(e="/"+e);var s;return r instanceof Array?(s=r,r=n===!0):n instanceof Array?(s=n,r=r===!0):r=r===!0,n=r,framework.route(e,function(){return t.startsWith("http://")||t.startsWith("https://")?void this.redirect(t,n):("/"!==t[0]&&(t="/"+t),void this.redirect(t,n))},s),o}return"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),o.routes.redirects[e]={url:t,path:r,permanent:n},o._request_check_redirect=!0,o},Framework.prototype.schedule=function(e,t,r){void 0===r&&(r=t,t=!1);var n=this,o=typeof e;o===STRING?e=e.parseDate():o===NUMBER&&(e=new Date(e));{var i=e.getTime();framework_utils.GUID(5)+framework_utils.random(1e4)}return t&&(t=t.replace("each","1")),n.schedules.push({expire:i,fn:r,repeat:t}),n},Framework.prototype.resize=function(e,t,r,n,o,i){var s=this,a=null,u=e.lastIndexOf(".");a=-1!==u?[e.substring(u)]:i||[".jpg",".png",".gif"];for(var c=a.length,l=0;c>l;l++)a[l]=("."!==a[l][0]?".":"")+a[l].toLowerCase();u=e.lastIndexOf("/"),-1!==u&&(e=e.substring(0,u)),"/"!==e[0]&&(e="/"+e),"/"!==e[e.length-1]&&(e+="/"),o=o||e,n||(n={});for(var p={},l=0,c=a.length;c>l;l++)p[a[l]]=!0;return s.routes.resize[e]={width:t,height:r,extension:p,path:o||e,grayscale:n.grayscale,blur:n.blur,rotate:n.rotate,flip:n.flip,flop:n.flop,sepia:n.sepia,quality:n.quality,cache:n.cache===!1?!1:!0},s},Framework.prototype.restful=function(e,t,r,n,o,i){function s(e){for(var t=0,r=e.length;r>t;t++)if("*"===e[t][0])return e.splice(t,1),e;return e}var a,u=this;r&&(a=[],t&&a.push.apply(a,s(t)),u.route(e,a,r));var c=framework_utils.path(e)+"{id}";return n&&(a=[],t&&a.push.apply(a,s(t)),u.route(c,a,n)),o&&(a=["post"],t&&a.push.apply(a,t),u.route(e,a,o),a=["put"],t&&a.push.apply(a,t),u.route(c,a,o)),i&&(a=["delete"],t&&a.push.apply(a,s(t)),u.route(c,a,i)),u},Framework.prototype.route=function(e,t,r,n,o,i,s){for(var a,u,c,l=!0,p=0;p<arguments.length;p++)if(typeof arguments[p]===TYPE_FUNCTION){l=!1;break}var f=typeof e===TYPE_FUNCTION?e:null;f&&(e="/"),l||"string"!=typeof t||void 0===r||(a=e,e=t,t=r,r=n,n=o,o=i,i=s,s=void 0),""===e&&(e="/"),"["!==e[0]&&"/"!==e[0]&&(e="/"+e),e.endsWith("/")&&(e=e.substring(0,e.length-1)),utils.isArray(n)&&(u=o,o=n,n=u);var d=typeof t,m=0;a||(a=e),(d===OBJECT||t instanceof Array)&&(u=t,t=r,r=u),d===STRING?(c=t,t=function(){this.view(c)}):typeof t!==TYPE_FUNCTION&&(c=e,c.endsWith("/")&&(c=c.substring(0,c.length-1)),m=c.lastIndexOf("/"),-1!==m&&(c=c.substring(m+1)),(""===c||"/"===c)&&(c="index"),t=function(){this.view(c)}),utils.isArray(r)||"object"!=typeof r?r instanceof Array&&n&&typeof n===OBJECT?(s=n,n=void 0):r instanceof Array&&typeof n===NUMBER&&typeof o===OBJECT&&!(o instanceof Array)&&(s=o,o=void 0):(n=r.max||r.length||r.maximum||r.maximumSize||r.size,o=r.middleware||r.partials||r.partial,i=r.timeout,s=r.options,r.name&&(a=r.name),r.id&&(a=r.id),r=r.flags||r.flag);var h=this,g=0,v=null,y=-1!==e.indexOf("*");m=e.indexOf("]"),g=e.count("/"),y&&(e=e.replace("*","").replace("//","/"),g-=100),m>0&&(v=e.substring(1,m).trim().toLowerCase().split(","),e=e.substring(m+1),g+=2);var b,w=!1,k=!1,E="",S="GeneratorFunction"===t.constructor.name||0===t.toString().indexOf("function*"),T=!1,_=!1,O=!1;if(r){u=[];for(var N=0,p=0;p<r.length;p++)if(typeof r[p]!==NUMBER){var x=r[p][0];if("%"!==x)if("#"!==x)if("*"!==x){N++;var C=r[p].toString().toLowerCase();switch(C){case"json":_=!0;continue;case"xss":N--;continue;case"delay":N--,O=!0;continue;case"sync":case"yield":case"synchronize":S=!0,N--;continue;case"noxhr":case"-xhr":k=!0;continue;case"raw":w=!0;break;case"mobile":T=!0,h._request_check_mobile=!0;break;case"authorize":case"authorized":g+=2,u.push("authorize");break;case"unauthorize":case"unauthorized":g+=2,u.push("unauthorize");break;case"logged":g+=2,u.push("authorize");break;case"unlogged":u.push("unauthorize");break;case"referer":case"referrer":u.push("referer");break;case"delete":case"get":case"head":case"options":case"patch":case"post":case"propfind":case"put":case"trace":u.push(C),E+=(E?",":"")+C;break;default:u.push(C)}}else b=r[p].substring(1).split("/"),1===b.length&&(b[1]=b[0],b[0]="default");else null===(o||null)&&(o=[]),o.push(r[p].substring(1));else h.behaviour(""===e?"/":e,r[p].substring(1))}else i=r[p];r=u,g+=2*N}else r=["get"],E="get";var I=!1;-1===r.indexOf("logged")&&-1===r.indexOf("authorize")&&-1===r.indexOf("unauthorize")&&-1===r.indexOf("unlogged")&&(I=!0);var R=framework_internal.routeSplitCreate(e.trim()),A=[],F=null,D=null;-1!==e.indexOf("{")&&(R.forEach(function(e,t){if("{"===e.substring(0,1)){A.push(t);var r=e.substring(1,e.length-1);if("/"===r[0]){var n=r.lastIndexOf("/");-1!==n&&(F||(F={},D=[]),F[t]=new RegExp(r.substring(1,n),r.substring(n+1)),D.push(t))}}}),g-=A.length),-1!==e.indexOf("#")&&(g-=100),-1!==r.indexOf("proxy")&&(_=!0,g++),(_||-1!==r.indexOf("xml")||w)&&-1===r.indexOf("delete")&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&-1===r.indexOf("patch")&&(r.push("post"),E+=(E?",":"")+"post",g++),-1!==r.indexOf("upload")&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&(r.push("post"),E+=(E?",":"")+"post"),-1===r.indexOf("get")&&-1===r.indexOf("options")&&-1===r.indexOf("post")&&-1===r.indexOf("delete")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&-1===r.indexOf("head")&&-1===r.indexOf("trace")&&-1===r.indexOf("patch")&&-1===r.indexOf("propfind")&&(r.push("get"),E+=(E?",":"")+"get"),-1!==r.indexOf("referer")&&(h._request_check_referer=!0),h._request_check_POST||-1===r.indexOf("delete")&&-1===r.indexOf("post")&&-1===r.indexOf("put")&&-1===r.indexOf("upload")&&-1===r.indexOf("json")&&-1===r.indexOf("patch")&&-1===r.indexOf("options")||(h._request_check_POST=!0),o&&o instanceof Array&&o.length||(o=null);var $=!1;return-1!==E.indexOf(",")&&($=!0),E=-1!==E.indexOf(",")||""===E?void 0:E.toUpperCase(),"#"===a[1]&&(a=a.substring(1)),h.routes.web.push({name:a,priority:g,schema:b,subdomain:v,controller:_controller?_controller:"unknown",url:R,param:A,flags:r||[],method:E,execute:t,length:1024*(n||h.config["default-request-length"]),middleware:o,timeout:void 0===i?O?0:h.config["default-request-timeout"]:i,isMULTIPLE:$,isJSON:_,isXML:-1!==r.indexOf("xml"),isRAW:w,isMOBILE:T,isMOBILE_VARY:T,isGENERATOR:S,isMEMBER:I,isASTERIX:y,isREFERER:-1!==r.indexOf("referer"),isHTTPS:-1!==r.indexOf("https"),isHTTP:-1!==r.indexOf("http"),isDEBUG:-1!==r.indexOf("debug"),isRELEASE:-1!==r.indexOf("release"),isPROXY:-1!==r.indexOf("proxy"),isBOTH:k?!1:!0,isXHR:-1!==r.indexOf("xhr"),isUPLOAD:-1!==r.indexOf("upload"),isSYSTEM:e.startsWith("/#"),isCACHE:!(e.startsWith("/#")||f||A.length||y),isPARAM:A.length>0,isDELAY:O,CUSTOM:f,options:s,regexp:F,regexpIndexer:D}),h.emit("route-add","web",h.routes.web[h.routes.web.length-1]),_controller||h._routesSort(),h},Framework.prototype.routing=function(e){for(var t=this,r=0,n=t.routes.web.length;n>r;r++){var o=t.routes.web[r];if(o.name===e){var i=Utils.path(o.url.join("/"));return"/"!==i[0]&&(i="/"+i),{controller:o.controller,url:i,id:o.id,flags:o.flags,middleware:o.middleware,execute:o.execute,timeout:o.timeout,options:o.options,length:o.length}}}},Framework.prototype.merge=function(e){for(var t=[],r=this,n=1,o=arguments.length;o>n;n++){var i=arguments[n];i instanceof Array||(i=[i]);for(var s=0,a=i.length;a>s;s++){var u=i[s];"@"===u[0]&&(u="~"+framework.path["package"](u.substring(1))),t.push(u)}}e=r._version(e),"/"!==e[0]&&(e="/"+e);var c=r.path.temp("merge-"+createTemporaryKey(e));return r.routes.merge[e]={filename:c,files:t},r},Framework.prototype.mapping=function(){return this.map.apply(this,arguments)},Framework.prototype.send=function(e,t){return process.send(e,t),this},Framework.prototype.map=function(e,t,r){"/"!==e[0]&&(e="/"+e);var n=!1,o=this;if(e=o._version(e),"#"===t[0])return o.routes.mapping[e]=t,o;"@"===t[0]&&(t=o.path["package"](t.substring(1)),n=!0);var i=path.extname(t).length>0;if(i)return o.routes.mapping[e]=t,o;e=framework_utils.path(e),t=framework_utils.path(t);var s=t,a="",u=!1;if("/"===s[0]&&(u=!0),"~"===s[0]&&(a+="~",s=s.substring(1)),"."===s[0]&&(a+=".",s=s.substring(1)),u||"/"!==s[0]||(a+="/",s=s.substring(1)),r instanceof Array)for(var c=0,l=r.length;l>c;c++)r[c]=("."!==r[c][0]?".":"")+r[c].toLowerCase();return setTimeout(function(){framework_utils.ls(t,function(t){for(var n=0,i=t.length;i>n;n++){var u=t[n].replace(s,"");if(r)if("function"==typeof r){if(!r(u))continue}else if(-1===r.indexOf(path.extname(u).toLowerCase()))continue;"/"===u[0]&&(u=u.substring(1));var c=e+u;o.routes.mapping[c]=a+t[n]}})},n?500:1),this},Framework.prototype.middleware=function(e,t){var r=this;return r.install("middleware",e,t),r},Framework.prototype.use=function(e){var t=this;if(arguments.length)for(var r=0;r<arguments.length;r++)t.routes.request.push(arguments[r]);else if(e instanceof Array)for(var r=0;r<e.length;r++)t.routes.request.push(e[r]);else t.routes.request.push(e);return t._length_request_middleware=t.routes.request.length,t},Framework.prototype.websocket=function(e,t,r,n,o,i,s,a){var u,c=typeof e===TYPE_FUNCTION?e:null;c&&(e="/"),""===e&&(e="/"),utils.isArray(i)&&(u=s,s=i,i=u),typeof funcExecute===OBJECT&&(u=r,funcExecute=r,r=u),r instanceof Array||typeof r!==OBJECT||(n=r.protocols||r.protocol,o=r.allow||r.origin,i=r.max||r.length||r.maximum||r.maximumSize,s=r.middleware,a=r.options,r=r.flags),void 0===s&&(s=null);var l=this,p=0,f=e.indexOf("]"),d=null,m=-1!==e.indexOf("*");p=e.count("/"),f>0&&(d=e.substring(1,f).trim().toLowerCase().split(","),e=e.substring(f+1),p+=2),m&&(e=e.replace("*","").replace("//","/"),p=-10-p);var h=framework_internal.routeSplitCreate(e.trim()),g=[],v=null,y=null;-1!==e.indexOf("{")&&(h.forEach(function(e,t){if("{"===e.substring(0,1)){g.push(t);var r=e.substring(1,e.length-1);if("/"===r[0]){var n=r.lastIndexOf("/");-1!==n&&(v||(v={},y=[]),v[t]=new RegExp(r.substring(1,n),r.substring(n+1)),y.push(t))}}}),p-=g.length),typeof o===STRING&&(o=o[o]),typeof n===STRING&&(n=n[n]),typeof r===STRING&&(r=r[r]),u=[];var b=!1,w=!1,k=0;void 0===r&&(r=[]);for(var E=0;E<r.length;E++)"#"!==r[E][0]?(r[E]=r[E].toString().toLowerCase(),k++,"json"===r[E]&&(b=!0),"binary"===r[E]&&(w=!0),"raw"===r[E]&&(w=!1,b=!1),"json"!==r[E]&&"binary"!==r[E]&&"raw"!==r[E]&&u.push(r[E])):(null===(s||null)&&(s=[]),s.push(r[E].substring(1)));r=u,-1===r.indexOf("get")&&r.unshift("get"),p+=2*k;var S=!1;return r&&-1!==r.indexOf("authorize")||(S=!0),s&&s instanceof Array&&s.length||(s=null),l.routes.websockets.push({controller:_controller?_controller:"unknown",url:h,param:g,subdomain:d,priority:p,flags:r||[],onInitialize:t,protocols:n||[],allow:o||[],length:1024*(i||l.config["default-websocket-request-length"]),isWEBSOCKET:!0,isMEMBER:S,isJSON:b,isBINARY:w,isASTERIX:m,isHTTPS:r.indexOf("https"),isHTTP:r.indexOf("http"),isDEBUG:r.indexOf("debug"),isRELEASE:r.indexOf("release"),CUSTOM:c,middleware:s,options:a,isPARAM:g.length>0,regexp:v,regexpIndexer:y}),l.emit("route-add","websocket",l.routes.websockets[l.routes.websockets.length-1]),_controller||l._routesSort(),l},Framework.prototype.file=function(e,t,r,n,o){var i,s=this;if(utils.isArray(t)){i=r;var a=n;n=t,t=i,r=a}else utils.isArray(r)&&(i=r,r=n,n=i);if(void 0===n&&(n=null),n)for(var u=0,c=n.length;c>u;u++)n[u]=n[u].replace("#","");return n&&n instanceof Array&&n.length||(n=null),s.routes.files.push({controller:_controller?_controller:"unknown",name:e,onValidation:t,execute:r||t,middleware:n,options:o}),s.emit("route-add","file",s.routes.files[s.routes.files.length-1]),s._length_files++,s},Framework.prototype.localize=function(e,t,r,n){var o=this;t=t.replace("*","");var i=t.lastIndexOf("."),s="html|htm|md|txt";-1!==i&&(s=t.substring(i+1),t=t.substring(0,i));var a=function(e,r,n){if(n)return e.url.substring(0,t.length)===t&&-1!==s.indexOf(e.extension);var i="locate_"+(e.$language?e.$language:"default")+"_"+e.url,a=framework.temporary.other[i];if(a)return void framework.responseContent(e,r,200,a,framework_utils.getContentType(e.extension),!0);var u=e.uri.pathname,c=o.onMapping(u,framework.path["public"]($decodeURIComponent(u)));fs.readFile(c,function(t,n){return t?r.throw404():(n=framework.translator(e.$language,n.toString(ENCODING)),framework.isDebug||(framework.temporary.other[i]=n),void framework.responseContent(e,r,200,n,framework_utils.getContentType(e.extension),!0))})};return o.file(e,a,r,n),o},Framework.prototype.error=function(e,t,r){if(null===e)return this;if(void 0===e)return function(e){e&&framework.error(e,t,r)};var n=this;return null!==n.errors&&(n.errors.push({error:e.stack,name:t,url:r?parser.format(r):null,date:new Date}),n.errors.length>50&&n.errors.shift()),n.onError(e,t,r),n},Framework.prototype.problem=function(e,t,r,n){var o=this;return null!==o.problems&&(o.problems.push({message:e,name:t,url:r?parser.format(r):null,ip:n}),o.problems.length>50&&o.problems.shift()),o.emit("problem",e,t,r,n),o},Framework.prototype.change=function(e,t,r,n){var o=this;return null!==o.changes&&(o.changes.push({message:e,name:t,url:r?parser.format(r):null,ip:n}),o.changes.length>50&&o.changes.shift()),o.emit("change",e,t,r,n),o},Framework.prototype.module=function(e){return this.modules[e]||null},Framework.prototype.modify=function(e){var t=this;return t.modificators||(t.modificators=[]),t.modificators.push(e),t},Framework.prototype.$load=function(e){function t(e,r,o,i){fs.existsSync(n)&&(i||(i=EXTENSION_JS),fs.readdirSync(e).forEach(function(s){var a=fs.statSync(path.join(e,s)).isDirectory();if(a)return r++,void t(path.join(e,s),r,o,i);var u=path.extname(s).toLowerCase();if(u===i){var c=(r>0?e.replace(n,"")+"/":"")+s.substring(0,s.length-u.length);o.push({name:"/"===c[0]?c.substring(1):c,filename:path.join(n,c)+i})}}))}var r=this,n="",o=[];return e&&-1===e.indexOf("modules")||(n=path.join(directory,r.config["directory-modules"]),o=[],t(n,0,o,".js"),o.forEach(function(e){r.install("module",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("isomorphic")||(n=path.join(directory,r.config["directory-isomorphic"]),o=[],t(n,0,o,".js"),o.forEach(function(e){r.install("isomorphic",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("packages")||(n=path.join(directory,r.config["directory-packages"]),o=[],t(n,0,o,".package"),o.forEach(function(e){r.install("package",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("models")||(n=path.join(directory,r.config["directory-models"]),o=[],t(n,0,o),o.forEach(function(e){r.install("model",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("definitions")||(n=path.join(directory,r.config["directory-definitions"]),o=[],t(n,0,o),o.forEach(function(e){r.install("definition",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("controllers")||(o=[],n=path.join(directory,r.config["directory-controllers"]),t(n,0,o),o.forEach(function(e){r.install("controller",e.name,e.filename,void 0,void 0,void 0,!0)})),r._routesSort(),e&&-1===e.indexOf("dependencies")||r._configure_dependencies(),r},Framework.prototype.install=function(type,name,declaration,options,callback,internal,useRequired,skipEmit){var self=this,obj=null;"config"!==type&&"version"!==type&&typeof name===STRING&&(name.startsWith("http://")||name.startsWith("https://"))&&typeof declaration===OBJECT&&(callback=options,options=declaration,declaration=name,name="");var t=typeof declaration,key="",tmp=null;if(t===OBJECT&&(t=typeof options,t===TYPE_FUNCTION&&(callback=options),options=declaration,declaration=void 0),void 0===declaration&&(declaration=name,name=""),typeof declaration===STRING&&(declaration.startsWith("http://")||declaration.startsWith("https://")))return"package"===type?(utils.download(declaration,["get"],function(e,t){if(e)return self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e));var r=path.basename(declaration,".package"),n=framework.path.temp(r+".package"),o=fs.createWriteStream(n);t.pipe(o),o.on("finish",function(){self.install(type,r,n,options,void 0,void 0,!0)})}),self):(utils.request(declaration,["get"],function(e,t,r){return 200===r||e||(e=new Error(t)),e?(self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e))):void self.install(type,name,t,options,callback,declaration)}),self);if("middleware"===type)return self.routes.middleware[name]=typeof declaration===TYPE_FUNCTION?declaration:eval(declaration),self._length_middleware=Object.keys(self.routes.middleware).length,callback&&callback(null),key=type+"."+name,self.dependencies[key]?self.dependencies[key].updated=new Date:(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].count++,setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self;if("config"===type||"configuration"===type||"settings"===type)return self._configure(declaration instanceof Array?declaration:declaration.toString().split("\n"),!0),setTimeout(function(){delete self.temporary["mail-settings"],self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("version"===type||"versions"===type)return self._configure_versions(declaration.toString(),!0),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("package"===type){var backup=new Backup,id=path.basename(declaration,".package"),dir=path.join(framework.path.root(),framework.config["directory-temp"],id);return self.routes.packages[id]=dir,backup.restore(declaration,dir,function(){var e=path.join(dir,"index.js");self.install("module",id,e,options,function(e){setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(e)},internal,useRequired,!0)}),self}var plus=null===self.id?"":"instance-"+self.id+"-";if("view"===type){var item=self.routes.views[name];return key=type+"."+name,void 0===item&&(item={},item.filename=self.path.temporary("installed-"+plus+"view-"+utils.GUID(10)+".tmp"),item.url=internal,item.count=0,self.routes.views[name]=item),item.count++,fs.writeFileSync(item.filename,declaration),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self}if("definition"===type||"eval"===type){_controller="";try{useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))):obj=eval(typeof declaration===TYPE_FUNCTION?"("+declaration.toString()+")()":declaration)}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return callback&&callback(null),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self}if("isomorphic"===type){var content="";try{useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),content=fs.readFileSync(declaration).toString(ENCODING),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))):(obj=eval(typeof declaration===TYPE_FUNCTION?"("+declaration.toString()+")()":declaration),content=declaration.toString())}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return typeof obj.id===STRING?name=obj.id:typeof obj.name===STRING&&(name=obj.name),obj.url&&framework.map(obj.url,"#"+name),framework.isomorphic[name]=obj,framework.isomorphic[name].$$output=framework_internal.compile_javascript(content,"#"+name),callback&&callback(null),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self}if("model"===type||"source"===type){_controller="";try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{typeof declaration!==STRING&&(declaration=declaration.toString());var filename=directory+self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js").substring(1);fs.writeFileSync(filename,declaration),obj=require(filename),function(e,t){setTimeout(function(){fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+name+"')",null),callback&&callback(ex),self}return typeof obj.id===STRING?name=obj.id:typeof obj.name===STRING&&(name=obj.name),key=type+"."+name,tmp=self.dependencies[key],self.uninstall(type,name),tmp?(self.dependencies[key]=tmp,self.dependencies[key].updated=new Date):(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].count++,obj.reinstall?self.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete self.dependencies[key],"model"===type?self.models[name]=obj:self.sources[name]=obj,typeof obj.install===TYPE_FUNCTION&&(framework.config["allow-compatibility"]||0===obj.install.toString().indexOf("function (framework")?(console.log("OBSOLETE "+key+": exports.install = function(framework <-- REMOVE ARGUMENT, options, name) { ..."),obj.install(self,options,name)):obj.install(options,name)),skipEmit||setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self}if("module"===type||"controller"===type){var _ID=_controller="TMP"+Utils.random(1e4);try{useRequired?(obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))):(typeof declaration!==STRING&&(declaration=declaration.toString()),filename=directory+self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js").substring(1),fs.writeFileSync(filename,declaration),obj=require(filename),function(e,t){setTimeout(function(){fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename))}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+(name?"":internal)+"')",null),callback&&callback(ex),self}if(typeof obj.id===STRING?name=obj.id:typeof obj.name===STRING&&(name=obj.name),key=type+"."+name,tmp=self.dependencies[key],self.uninstall(type,name),tmp?(self.dependencies[key]=tmp,self.dependencies[key].updated=new Date):(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0,_id:_ID},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].dependencies=obj.dependencies,self.dependencies[key].count++,self.dependencies[key].processed=!1,obj.reinstall?self.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete self.dependencies[key].reinstall,_controller=_ID,obj.dependencies instanceof Array)for(var i=0,length=obj.dependencies.length;length>i;i++)if(!self.dependencies[type+"."+obj.dependencies[i]])return self.temporary.dependencies[key]={obj:obj,options:options,callback:callback,skipEmit:skipEmit},self;return self.install_make(key,name,obj,options,callback,skipEmit),"module"===type?self.modules[name]=obj:self.controllers[name]=obj,self.install_prepare(),self}return self},Framework.prototype.install_prepare=function(e){var t=this,r=Object.keys(t.temporary.dependencies);if(r.length){for(var n=0,o=r.length;o>n;n++){var i=r[n],s=t.temporary.dependencies[i],a=t.dependencies[i],u=!1;if(!a.processed){for(var c=0,l=a.dependencies.length;l>c;c++){var p=t.dependencies["module."+a.dependencies[c]];if(!p||!p.processed){u=!0;break}}u||(delete t.temporary.dependencies[i],"module"===a.type?t.modules[a.name]=s.obj:t.controllers[a.name]=s.obj,t.install_make(i,a.name,s.obj,s.options,s.callback,s.skipEmit))}}return r=Object.keys(t.temporary.dependencies),clearTimeout(t.temporary.other.dependencies),t.temporary.other.dependencies=setTimeout(function(){var e=Object.keys(framework.temporary.dependencies);if(e.length)throw new Error("Dependency exception (module): missing dependencies for: "+e.join(", ").trim());delete t.temporary.other.dependencies},1500),r.length?e?t:(t.install_prepare(!0),t):t}},Framework.prototype.install_make=function(e,t,r,n,o,i){var s=this,a=s.dependencies[e],u=a._id,c=a.type;_controller=u,typeof r.install===TYPE_FUNCTION&&(framework.config["allow-compatibility"]||0===r.install.toString().indexOf("function (framework")?(console.log("OBSOLETE "+e+": exports.install = function(framework <-- REMOVE ARGUMENT, options, name) { ..."),r.install(s,n,t)):r.install(n,t)),a.processed=!0;for(var l=("module"===c?"#":"")+t,p=s.routes.web.length,f=0;p>f;f++)s.routes.web[f].controller===u&&(s.routes.web[f].controller=l);p=s.routes.websockets.length;for(var f=0;p>f;f++)s.routes.websockets[f].controller===u&&(s.routes.websockets[f].controller=l);p=s.routes.files.length;for(var f=0;p>f;f++)s.routes.files[f].controller===u&&(s.routes.files[f].controller=l);return s._routesSort(),_controller="",i||setTimeout(function(){s.emit(c+"#"+t),s.emit("install",c,t)},500),o&&o(null),s},Framework.prototype.uninstall=function(e,t,r,n){var o=this,i=null;if("schema"===e)return Builders.remove(t),o.emit("uninstall",e,t),o;if("mapping"===e)return delete o.routes.mapping[t],o.emit("uninstall",e,t),o;if("isomorphic"===e){var i=o.isomorphic[t];return i.url&&delete o.routes.mapping[o._version(i.url)],delete o.isomorphic[t],o.emit("uninstall",e,t),o}if("middleware"===e)return o.routes.middleware[t]?(delete o.routes.middleware[t],delete o.dependencies[e+"."+t],o._length_middleware=Object.keys(o.routes.middleware).length,o.emit("uninstall",e,t),o):o;if("package"===e)return delete o.routes.packages[t],o.uninstall("module",t,r,!0),o;if("view"===e||"precompile"===e)return(i=o.routes.views[t])?(delete o.routes.views[t],delete o.dependencies[e+"."+t],fsFileExists(i.filename,function(e){e&&fs.unlink(i.filename)}),o.emit("uninstall",e,t),o):o;if("model"===e||"source"===e)return(i="model"===e?o.models[t]:o.sources[t])?(i.id&&delete require.cache[require.resolve(i.id)],typeof i.uninstall===TYPE_FUNCTION&&(framework.config["allow-compatibility"]?i.uninstall(o,r,t):i.uninstall(r,t)),"model"===e?delete o.models[t]:delete o.sources[t],delete o.dependencies[e+"."+t],o._routesSort(),o.emit("uninstall",e,t),o):o;if("module"===e||"controller"===e){var s="module"===e;if(i=s?o.modules[t]:o.controllers[t],!i)return o;i.id&&delete require.cache[require.resolve(i.id)];var a=(s?"#":"")+t;return o.routes.web=o.routes.web.remove("controller",a),o.routes.files=o.routes.files.remove("controller",a),o.routes.websockets=o.routes.websockets.remove("controller",a),i&&(i.uninstall&&(framework.config["allow-compatibility"]?i.uninstall(o,r,t):i.uninstall(r,t)),s?delete o.modules[t]:delete o.controllers[t]),o._routesSort(),delete o.dependencies[e+"."+t],n||o.emit("uninstall",e,t),o}return o},Framework.prototype.eval=function(e){return this.install("eval",e)},Framework.prototype.onError=function(e,t,r){return console.log("======= "+(new Date).format("yyyy-MM-dd HH:mm:ss")+": "+(t?t+" ---> ":"")+e.toString()+(r?" ("+parser.format(r)+")":""),e.stack),this},Framework.prototype.onAuthorization=null,Framework.prototype.onLocate=null,Framework.prototype.onVersion=null,Framework.prototype.onMapping=function(e,t){return"/"!==e[0]&&(e="/"+e),this.routes.mapping[e]?this.routes.mapping[e]:t},Framework.prototype.snapshot=function(e,t,r){var n=this;if(!e.match(/^http:|https:/gi)){"/"!==e[0]&&(e="/"+e);var o="auto"===n.ip?"0.0.0.0":n.ip;e="http://"+o+":"+n.port+e}return framework_utils.download(e,["get"],function(e,n){var o=fs.createWriteStream(t);n.pipe(o),FINISHED(o,function(){DESTROY(o),r&&setImmediate(r)})}),n},Framework.prototype.onValidation=null,Framework.prototype.onSchema=function(e,t,r,n){var o=GETSCHEMA(t,r);return o?void o.make(e.body,function(e,t){e?n(e):n(null,t)}):void n(new Error("Schema not found."))},Framework.prototype.onMail=function(e,t,r,n,o){var i;typeof n===STRING&&(i=o,o=n,n=i);var s=Mail.create(t,r);if(e instanceof Array)for(var a=e.length,u=0;a>u;u++)s.to(e[u]);else s.to(e);var c=this;s.from(c.config["mail.address.from"]||"",c.config.name),i=c.config["mail.address.reply"],o?s.reply(o):i&&i.isEmail()&&s.reply(c.config["mail.address.reply"]),i=c.config["mail.address.copy"],i&&i.isEmail()&&s.bcc(i);var l=c.temporary["mail-settings"];if(void 0===l){var p=c.config["mail.smtp.options"];p&&p.isJSON()&&(l=JSON.parse(p)),c.temporary["mail-settings"]=l}return setTimeout(function(){s.send(c.config["mail.smtp"],l,n)},2),s},Framework.prototype.onMeta=function(){for(var e=this,t="",r=arguments.length,n=0;r>n;n++){var o=utils.encode(arguments[n]);
if(null!==o&&o.length)switch(n){case 0:t+="<title>"+(o+("/"===e.url||e.config["allow-custom-titles"]?"":" - "+e.config.name))+"</title>";break;case 1:t+='<meta name="description" content="'+o+'" />';break;case 2:t+='<meta name="keywords" content="'+o+'" />';break;case 3:var i=o.substring(0,6),s="http:/"===i||"https:"===i||"//"===o.substring(0,2)?o:e.hostname(e.routeImage(o));t+='<meta property="og:image" content="'+s+'" /><meta name="twitter:image" content="'+s+'" />'}}return t},Framework.prototype.log=function(){for(var e=this,t=new Date,r=t.getFullYear()+"-"+(t.getMonth()+1).toString().padLeft(2,"0")+"-"+t.getDate().toString().padLeft(2,"0"),n=t.getHours().toString().padLeft(2,"0")+":"+t.getMinutes().toString().padLeft(2,"0")+":"+t.getSeconds().toString().padLeft(2,"0"),o="",i=arguments.length,s=0;i>s;s++){var a=arguments[s];void 0===a?a="undefined":null===a?a="null":typeof a===OBJECT&&(a=util.inspect(a)),o+=(o?" ":"")+a}return e.path.verify("logs"),fs.appendFile(utils.combine(e.config["directory-logs"],r+".log"),n+" | "+o+"\n"),e},Framework.prototype.logger=function(){for(var e=this,t=new Date,r=t.getFullYear()+"-"+(t.getMonth()+1).toString().padLeft(2,"0")+"-"+t.getDate().toString().padLeft(2,"0")+" "+t.getHours().toString().padLeft(2,"0")+":"+t.getMinutes().toString().padLeft(2,"0")+":"+t.getSeconds().toString().padLeft(2,"0"),n="",o=arguments.length,i=1;o>i;i++){var s=arguments[i];void 0===s?s="undefined":null===s?s="null":typeof s===OBJECT&&(s=util.inspect(s)),n+=(n?" ":"")+s}return e.path.verify("logs"),fs.appendFile(utils.combine(e.config["directory-logs"],arguments[0]+".log"),r+" | "+n+"\n"),e},Framework.prototype.logmail=function(e,t,r,n){typeof r===FUNCTION?(n=r,r=t,t=null):void 0===r&&(r=t,t=null),t||(t=framework.config.name+" v"+framework.config.version);var r="<!DOCTYPE html><html><head><title>"+t+'</title><meta charset="utf-8" /></head><body><pre>'+(typeof r===OBJECT?JSON.stringify(r).escape():r)+"</pre></body></html>";return framework.onMail(e,t,r,n)},Framework.prototype.usage=function(e){var t=this,r=process.memoryUsage(),n=Object.keys(t.cache.items),o=Object.keys(t.resources),i=Object.keys(t.controllers),s=Object.keys(t.connections),a=Object.keys(t.workers),u=Object.keys(t.modules),c=Object.keys(t.isomorphic),l=Object.keys(t.models),p=Object.keys(t.helpers),f=Object.keys(t.temporary.path),d=Object.keys(t.temporary.range),m=Object.keys(t.routes.redirects),h={};h.framework={pid:process.pid,node:process.version,version:"v"+t.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(r.heapTotal/1024/1024).floor(2),memoryUsage:(r.heapUsed/1024/1024).floor(2),mode:t.config.debug?"debug":"release",port:t.port,ip:t.ip,directory:process.cwd()};for(var g=Object.keys(framework_utils.queuecache),v=0,y=0,b=g.length;b>y;y++)v+=framework_utils.queuecache[g[y]].pending.length;return h.counter={resource:o.length,controller:i.length,module:u.length,isomorphic:c.length,cache:n.length,worker:a.length,connection:s.length,schedule:t.schedules.length,helpers:p.length,error:t.errors.length,problem:t.problems.length,queue:v,files:f.length,streaming:d.length,modificator:t.modificators?t.modificators.length:0},h.routing={webpage:t.routes.web.length,websocket:t.routes.websockets.length,file:t.routes.files.length,middleware:Object.keys(t.routes.middleware).length,redirect:m.length},h.stats=t.stats,h.redirects=m,t.restrictions.isRestrictions&&(h.restrictions={allowed:[],blocked:[],allowedHeaders:t.restrictions.allowedCustomKeys,blockedHeaders:t.restrictions.blockedCustomKeys}),e?(h.controllers=[],i.forEach(function(e){var r=t.controllers[e];h.controllers.push({name:e,usage:void 0===r.usage?null:r.usage()})}),h.connections=[],s.forEach(function(e){h.connections.push({name:e,online:t.connections[e].online})}),h.modules=[],u.forEach(function(e){var r=t.modules[e];h.modules.push({name:e,usage:void 0===r.usage?null:r.usage()})}),h.models=[],l.forEach(function(e){var r=t.models[e];h.models.push({name:e,usage:void 0===r.usage?null:r.usage()})}),h.helpers=p,h.cache=n,h.resources=o,h.errors=t.errors,h.problems=t.problems,h.changes=t.changes,h.files=f,h.streaming=d,h.other=Object.keys(t.temporary.other),h):h},Framework.prototype.onCompileView=function(e,t){return t},Framework.prototype.onCompileStyle=null,Framework.prototype.onCompileCSS=null,Framework.prototype.onCompileScript=null,Framework.prototype.onCompileJS=null,Framework.prototype.compileContent=function(e,t,r){var n=this;if(r&&(-1!==r.indexOf(".min.")||-1!==r.indexOf("-min.")))return t;switch(e){case"js":return n.config["allow-compile-script"]?framework_internal.compile_javascript(t,r):t;case"css":t=n.config["allow-compile-style"]?framework_internal.compile_css(t,r):t;var o=t.match(/url\(.*?\)/g);return null===o?t:(o.forEach(function(e){var r=e.substring(4,e.length-1);t=t.replace(e,"url("+n._version(r)+")")}),t)}return t},Framework.prototype.compileFile=function(e,t,r,n,o){var i=this;return fsFileRead(r,function(s,a){if(s)return i.error(s,r,e),i.temporary.path[t]=null,void o();var u=i.path.temp((null===i.id?"":"instance-"+i.id+"-")+createTemporaryKey(e.pathname));i.path.verify("temp"),fs.writeFileSync(u,i.compileContent(n,a.toString(ENCODING),r),ENCODING),i.temporary.path[t]=u+";"+fs.statSync(u).size,o()}),i},Framework.prototype.compileMerge=function(e,t,r,n){var o=this,i=o.routes.merge[e.pathname],s=i.filename;if(!o.config.debug&&fs.existsSync(s))return o.temporary.path[t]=s+";"+fs.statSync(s).size,n(),o;var a=fs.createWriteStream(i.filename);a.on("finish",function(){o.temporary.path[t]=s+";"+fs.statSync(s).size,n()});var u=0;return i.files.wait(function(t,n){if(t.startsWith("http://")||t.startsWith("https://"))return void Utils.request(t,["get"],function(e,i){var s=o.compileContent(r,i,t).trim();"js"===r?";"!==s[s.length-1]&&(s+=";"):"html"===r&&s[s.length-1]!==NEWLINE&&(s+=NEWLINE),framework.isDebug&&merge_debug_writer(a,t,r,u++),a.write(s,ENCODING),n()});if("#"===t[0])return framework.isDebug&&merge_debug_writer(a,t,"js",u++),a.write(prepare_isomorphic(t.substring(1)),ENCODING),void n();if("~"!==t[0]){var s=o.path["public"](t);o.isVirtualDirectory&&!fs.existsSync(s)&&(s=o.path.virtual(t)),t=s}else t=t.substring(1);fsFileRead(t,function(s,c){if(s)return o.error(s,i.filename,e),void n();var l=o.compileContent(r,c.toString(ENCODING),t).trim();"js"===r?";"!==l[l.length-1]&&(l+=";"):"html"===r&&l[l.length-1]!==NEWLINE&&(l+=NEWLINE),framework.isDebug&&merge_debug_writer(a,t,r,u++),a.write(l,ENCODING),n()})},function(){a.end()}),o},Framework.prototype.compileValidation=function(e,t,r,n,o){var i=this;if(i.routes.merge[e.pathname])return void i.compileMerge(e,t,n,o);if(!fs.existsSync(r)){if(!i.isVirtualDirectory)return i.temporary.path[t]=null,o(),i;var s=r.replace(i.config["directory-public"],i.config["directory-public-virtual"]),a=!0;if(s!==r&&(r=s,a=!fs.existsSync(r)),a)return i.temporary.path[t]=null,o(),i}return"js"!==n&&"css"!==n||-1!==r.lastIndexOf(".min.")||-1!==r.lastIndexOf("-min.")?(i.temporary.path[t]=r+";"+fs.statSync(r).size,o(),i):(i.compileFile(e,t,r,n,o),i)},Framework.prototype.responseStatic=function(e,t,r){var n=this;if(t.success||t.headersSent)return r&&r(),n;var o=e.extension;if(!n.config["static-accepts"]["."+o])return n.response404(e,t),r&&r(),n;var i,s=e.uri.pathname,a=s.lastIndexOf("/"),u=n.routes.resize[s.substring(0,a+1)]||null,c=!1;if(null!==u?(s=s.substring(a+1),a=s.lastIndexOf("."),c=u.extension["*"]||u.extension[s.substring(a).toLowerCase()],c?(s=u.path+$decodeURIComponent(s),i=n.onMapping(s,"~"===s[0]?s.substring(1):"."===s[0]?s:framework.path["public"](s))):i=n.onMapping(s,framework.path["public"]($decodeURIComponent(s)))):i=n.onMapping(s,framework.path["public"]($decodeURIComponent(s))),!c){if("#"!==i[0])return n.responseFile(e,t,i,void 0,void 0,r),n;var l=i.substring(1),p=framework.isomorphic[l];if(!p)return void n.response404(e,t);var f=framework_utils.etag(i,(p.version||"")+"-"+(n.config["etag-version"]||""));if(RELEASE&&framework.notModified(e,t,f))return;var d={};return d.Etag=f,d.Expires=(new Date).add("M",3),d[RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",framework.responseContent(e,t,200,prepare_isomorphic(l),"text/javascript",!0,d),n}var m=u.cache?n.responseImage:n.responseImageWithoutCache;return m.call(n,e,t,i,function(e){(u.width||u.height)&&(u.width&&u.height?e.resizeCenter(u.width,u.height):e.resize(u.width,u.height)),u.grayscale&&e.grayscale(),u.blur&&e.blur("number"==typeof u.blur?u.blur:1),u.rotate&&typeof u.rotate==NUMBER&&e.rotate(u.rotate),u.flop&&e.flop(),u.flip&&e.flip(),u.sepia&&e.sepia("number"==typeof u.sepia?u.sepia:100),e.quality(u.quality?u.quality:n.config["default-image-quality"]),e.minify()},void 0,r),n},Framework.prototype.exists=function(e,t,r,n){typeof r===TYPE_FUNCTION&&(n=r,r=10);var o=this,i=createTemporaryKey(e),s=o.path.temp(i),a=!1;if(RELEASE){var u=framework_utils.etag(e.url,o.config["etag-version"]);e.headers["if-none-match"]===u&&(a=!0)}return o.isProcessed(i)||a?(o.responseFile(e,t,s),o):(framework_utils.queue("framework.exists",r,function(r){fsFileExists(s,function(o){return o?void framework.responseFile(e,t,s,void 0,void 0,r):void n(r,s)})}),o)},Framework.prototype.isProcessed=function(e){var t=this;if(e.url){var r=e.url,n=r.indexOf("?");-1!==n&&(r=r.substring(0,n)),e=framework.path["public"]($decodeURIComponent(r))}return void 0!==t.temporary.path[e]?!0:!1},Framework.prototype.isProcessing=function(e){var t,r=this;if(e.url){t=e.url;var n=t.indexOf("?");-1!==n&&(t=t.substring(0,n)),e=utils.combine(r.config["directory-public"],$decodeURIComponent(t))}return t=r.temporary.processing[e],void 0!==r.temporary.processing[e]?!0:!1},Framework.prototype.noCache=function(e,t){return e.noCache(),t&&t.noCache(),this},Framework.prototype.responseFile=function(e,t,r,n,o,i,s){var a=this;if(t.success||t.headersSent)return i&&i(),a;"@"===r[0]&&(r=framework.path["package"](r.substring(1))),e.clear(!0),s||(s=createTemporaryKey(e));var u=a.temporary.path[s];if(null===u)return a.config.debug&&delete a.temporary.path[s],a.response404(e,t),i&&i(),a;var c="no-cache"!==e.headers.pragma,l=c?framework_utils.etag(e.url,a.config["etag-version"]):null,p={};if(!a.config.debug&&e.headers["if-none-match"]===l)return!t.getHeader("ETag")&&l&&(p.Etag=l),t.getHeader("Expires")||(p.Expires=(new Date).add("M",3)),p[RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",t.success=!0,t.writeHead(304,p),t.end(),a.stats.response.notModified++,a._request_stats(!1,e.isStaticFile),i&&i(),e.isStaticFile||a.emit("request-end",e,t),a;var f=e.extension;if(f||(s&&(f=path.extname(s)),f||(f=path.extname(u))),void 0===u)return a.isProcessing(s)?e.processing>a.config["default-request-timeout"]?void a.response408(e,t):(e.processing+=500,setTimeout(function(){framework.responseFile(e,t,r,n,o,i,s)},500),a):(a.temporary.processing[s]=!0,a.compileValidation(e.uri,s,r,f,function(){delete a.temporary.processing[s],framework.responseFile(e,t,r,n,o,i,s)}),a);var d=u.lastIndexOf(";"),m=null;-1===d?d=u.length:m=u.substring(d+1),u=u.substring(0,d);var h=e.headers["accept-encoding"]||"";p["Accept-Ranges"]="bytes",p[RESPONSE_HEADER_CACHECONTROL]="public"+(RELEASE&&c?", max-age=11111111":""),RELEASE&&c&&!t.getHeader("Expires")&&(p.Expires=(new Date).add("M",3)),p.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),o&&utils.extend(p,o,!0),n&&(p["Content-Disposition"]='attachment; filename="'+n+'"'),RELEASE&&c&&l&&!t.getHeader("ETag")&&(p.Etag=l),p[RESPONSE_HEADER_CONTENTTYPE]||(p[RESPONSE_HEADER_CONTENTTYPE]=utils.getContentType(f));var g=a.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[p[RESPONSE_HEADER_CONTENTTYPE]]&&-1!==h.lastIndexOf("gzip"),v=e.headers.range||"";return t.success=!0,v?a.responseRange(u,v,p,e,t,i):(a.config.debug&&a.isProcessed(s)&&delete a.temporary.path[s],null===m||"0"===m||g||(p[RESPONSE_HEADER_CONTENTLENGTH]=m),a.stats.response.file++,a._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(g&&(p["Content-Encoding"]="gzip"),t.writeHead(200,p),t.end(),i&&i(),e.isStaticFile||a.emit("request-end",e,t),a):g?(p["Content-Encoding"]="gzip",fsStreamRead(u,function(r,n){t.writeHead(200,p),framework_internal.onFinished(t,function(){framework_internal.destroyStream(r),n()}),r.pipe(zlib.createGzip()).pipe(t),i&&i(),e.isStaticFile||a.emit("request-end",e,t)}),a):(fsStreamRead(u,function(r,n){t.writeHead(200,p),r.pipe(t),framework_internal.onFinished(t,function(){framework_internal.destroyStream(r),n()}),i&&i(),e.isStaticFile||a.emit("request-end",e,t)}),a))},Framework.prototype.responsePipe=function(e,t,r,n,o,i){var s=this;if(t.success||t.headersSent)return s;var a=parser.parse(r),u={};u[RESPONSE_HEADER_CACHECONTROL]="private",n&&utils.extend(u,n,!0),u["X-Powered-By"]="total.js v"+s.version_header;var c={protocol:a.protocol,auth:a.auth,method:"GET",hostname:a.hostname,port:a.port,path:a.path,agent:!1,headers:u},l="https:"===c.protocol?require("https"):http,p=-1!==(e.headers["accept-encoding"]||"").lastIndexOf("gzip"),f=l.get(c,function(r){var n=r.headers["content-type"],o=-1!==(r.headers["content-encoding"]||"").lastIndexOf("gzip"),i=!o&&p&&(-1!==n.indexOf("text/")||-1!==n.lastIndexOf("javascript")||-1!==n.lastIndexOf("json")),s=r.headers["content-disposition"]||"";return s&&t.setHeader("Content-Disposition",s),t.setHeader(RESPONSE_HEADER_CONTENTTYPE,n),t.setHeader("Vary","Accept-Encoding"+(e.$mobile?", User-Agent":"")),t.on("error",function(){r.close()}),i?(t.setHeader("Content-Encoding","gzip"),void r.pipe(zlib.createGzip()).pipe(t)):void(!p&&o?r.pipe(zlib.createGunzip()).pipe(t):r.pipe(t))});return(o||0)>0&&f.setTimeout(o||3e3,function(){s.response408(e,t),i&&i()}),f.on("close",function(){t.success||t.headersSent||(e.clear(!0),t.success=!0,s.stats.response.pipe++,s._request_stats(!1,e.isStaticFile),t.success=!0,e.isStaticFile||s.emit("request-end",e,t),i&&i())}),s},Framework.prototype.responseCustom=function(e,t){var r=this;if(!t.success&&!t.headersSent)return e.clear(!0),t.success=!0,r.stats.response.custom++,r._request_stats(!1,e.isStaticFile),e.isStaticFile||r.emit("request-end",e,t),r},Framework.prototype.responseImage=function(e,t,r,n,o,i){var s=this,a=createTemporaryKey(e),u=s.temporary.path[a];if(null===u)return s.response404(e,t),i&&i(),s;var c=null;if(typeof r===OBJECT?c=r:"@"===r[0]&&(r=framework.path["package"](r.substring(1))),void 0!==u)return s.responseFile(e,t,"",void 0,o,i,a),s;var l="im"===s.config["default-image-converter"];if(s.isProcessing(a))return e.processing>s.config["default-request-timeout"]?(s.response408(e,t),void(i&&i())):(e.processing+=500,void setTimeout(function(){s.responseImage(e,t,r,n,o,i)},500));var p=null===s.id?"":"instance-"+s.id+"-";return u=s.path.temp(p+a),s.temporary.processing[a]=!0,null!==c?(fsFileExists(u,function(r){if(r)return delete s.temporary.processing[a],s.temporary.path[a]=u,s.responseFile(e,t,u,void 0,o,i,a),void(s.isDebug&&delete s.temporary.path[a]);s.path.verify("temp");var p=framework_image.load(c,l);n(p);var f=path.extname(u);f.substring(1)!==p.outputType&&(u=u.substring(0,u.lastIndexOf(f))+"."+p.outputType),p.save(u,function(r){return delete s.temporary.processing[a],r?(s.temporary.path[a]=null,s.response500(e,t,r),i&&i(),void(s.isDebug&&delete s.temporary.path[a])):(s.temporary.path[a]=u+";"+fs.statSync(u).size,void s.responseFile(e,t,u,void 0,o,i,a))})}),s):(fsFileExists(r,function(c){if(!c)return delete s.temporary.processing[a],s.temporary.path[a]=null,s.response404(e,t),i&&i(),void(s.isDebug&&delete s.temporary.path[a]);s.path.verify("temp");var p=framework_image.load(r,l);n(p);var f=path.extname(u);f.substring(1)!==p.outputType&&(u=u.substring(0,u.lastIndexOf(f))+"."+p.outputType),p.save(u,function(r){return delete s.temporary.processing[a],r?(s.temporary.path[a]=null,s.response500(e,t,r),i&&i(),void(s.isDebug&&delete s.temporary.path[a])):(s.temporary.path[a]=u+";"+fs.statSync(u).size,void s.responseFile(e,t,u,void 0,o,i,a))})}),s)},Framework.prototype.responseImagePrepare=function(e,t,r,n,o,i){var s=this,a=createTemporaryKey(e),u=s.temporary.path[a];return null===u?(s.response404(e,t),i&&i(),s):void 0!==u?(s.responseFile(e,t,"",void 0,o,i,a),s):s.isProcessing(a)?e.processing>s.config["default-request-timeout"]?(s.response408(e,t),void(i&&i())):(e.processing+=500,void setTimeout(function(){s.responseImage(e,t,filename,n,o,i)},500)):(r.call(s,function(r){return r?void s.responseImage(e,t,r,n,o,i):(s.response404(e,t),void(i&&i()))}),s)},Framework.prototype.responseImageWithoutCache=function(e,t,r,n,o,i){var s=this,a=null;typeof r===OBJECT?a=r:"@"===r[0]&&(r=framework.path["package"](r.substring(1)));var u="im"===s.config["default-image-converter"];if(null!==a){var c=framework_image.load(a,u);return n(c),s.responseStream(e,t,utils.getContentType(c.outputType),c.stream(),null,o,i),s}return fsFileExists(r,function(a){if(!a)return s.response404(e,t),void(i&&i());s.path.verify("temp");var c=framework_image.load(r,u);n(c),s.responseStream(e,t,utils.getContentType(c.outputType),c.stream(),null,o,i)}),s},Framework.prototype.responseStream=function(e,t,r,n,o,i,s,a){var u=this;if(t.success||t.headersSent)return s&&s(),u;e.clear(!0),-1===r.lastIndexOf("/")&&(r=utils.getContentType(r));var c=e.headers["accept-encoding"]||"",l=u.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[r]&&-1!==c.lastIndexOf("gzip"),p={};if(p[RESPONSE_HEADER_CACHECONTROL]="public"+(RELEASE?", max-age=11111111":""),RELEASE&&(p.Expires=(new Date).add("M",3)),p.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),i&&utils.extend(p,i,!0),o=o||"",o&&(p["Content-Disposition"]="attachment; filename="+encodeURIComponent(o)),p[RESPONSE_HEADER_CONTENTTYPE]=r,u.stats.response.stream++,u._request_stats(!1,e.isStaticFile),"HEAD"===e.method)return l&&(p["Content-Encoding"]="gzip"),t.writeHead(200,p),t.end(),s&&s(),e.isStaticFile||u.emit("request-end",e,t),u;if(l&&!a){p["Content-Encoding"]="gzip",t.writeHead(200,p),t.on("error",function(){n.close()});var f=zlib.createGzip();return framework_internal.onFinished(t,function(){framework_internal.destroyStream(n)}),n.pipe(f).pipe(t),s&&s(),e.isStaticFile||u.emit("request-end",e,t),u}return t.writeHead(200,p),framework_internal.onFinished(t,function(){framework_internal.destroyStream(n)}),n.pipe(t),s&&s(),e.isStaticFile||u.emit("request-end",e,t),u},Framework.prototype.responseRange=function(e,t,r,n,o,i){var s=this,a=t.replace(/bytes=/,"").split("-"),u=parseInt(a[0]||"0",10),c=parseInt(a[1]||"0",10),l=s.temporary.range[e]||0;0===l&&(l=fs.statSync(e).size,s.temporary.range[e]=l),0===c&&(c=l-1),u>c&&(u=0,c=l-1);var p=c-u+1;return r[RESPONSE_HEADER_CONTENTLENGTH]=p,r["Content-Range"]="bytes "+u+"-"+c+"/"+l,"HEAD"===n.method?(o.writeHead(206,r),o.end(),s.stats.response.streaming++,s._request_stats(!1,n.isStaticFile),i&&i(),n.isStaticFile||s.emit("request-end",n,o),s):(fsStreamRead(e,{start:u,end:c},function(e,t){o.writeHead(206,r),framework_internal.onFinished(o,function(){framework_internal.destroyStream(e),t()}),e.pipe(o),s.stats.response.streaming++,s._request_stats(!1,n.isStaticFile),i&&i(),n.isStaticFile||s.emit("request-end",n,o)}),s)},Framework.prototype.responseBinary=function(e,t,r,n,o,i,s,a){var u=this;if(t.success||t.headersSent)return a&&a(),u;o||(o="binary"),e.clear(!0),-1===r.lastIndexOf("/")&&(r=utils.getContentType(r));var c=e.headers["accept-encoding"]||"",l=u.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[r]&&-1!==c.lastIndexOf("gzip"),p={};return p[RESPONSE_HEADER_CACHECONTROL]="public",p.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),s&&utils.extend(p,s,!0),i=i||"",i&&(p["Content-Disposition"]="attachment; filename="+encodeURIComponent(i)),p[RESPONSE_HEADER_CONTENTTYPE]=r,u.stats.response.binary++,u._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(l&&(p["Content-Encoding"]="gzip"),t.writeHead(200,p),t.end(),a&&a(),e.isStaticFile||u.emit("request-end",e,t),u):l?(p["Content-Encoding"]="gzip",t.writeHead(200,p),zlib.gzip("binary"===o?n:n.toString(o),function(e,r){t.end(r)}),a&&a(),e.isStaticFile||u.emit("request-end",e,t),u):(t.writeHead(200,p),t.end("binary"===o?n:n.toString(o)),a&&a(),e.isStaticFile||u.emit("request-end",e,t),u)},Framework.prototype.setModified=function(e,t,r){var n=this,o=typeof r===STRING;return o?(t.setHeader("Etag",r+":"+n.config["etag-version"]),n):(r=r||new Date,t.setHeader("Last-Modified",r.toUTCString()),n)},Framework.prototype.notModified=function(e,t,r,n){var o=this,i=typeof r;if(i===BOOLEAN){var s=r;r=n,n=s,i=typeof r}var a=i===STRING,u=e.headers[a?"if-none-match":"if-modified-since"];if(a){if(void 0===u)return!1;var c=r+":"+o.config["etag-version"];if(u!==c)return!1}else{if(void 0===u)return!1;var l=void 0===r?(new Date).toUTCString():r.toUTCString();if(n){if(new Date(Date.parse(u))===new Date(l))return!1}else if(new Date(Date.parse(u))<new Date(l))return!1}return t.success=!0,t.writeHead(304),t.end(),o.stats.response.notModified++,o._request_stats(!1,e.isStaticFile),e.isStaticFile||o.emit("request-end",e,t),!0},Framework.prototype.responseCode=function(e,t,r,n){var o=this;if(n&&o.problem(n,"response"+r+"()",e.uri,e.ip),t.success||t.headersSent)return o;o._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var i={},s=r;i[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(s,i),"HEAD"===e.method?t.end():t.end(utils.httpStatus(s)),e.isStaticFile||o.emit("request-end",e,t);var a="error"+r;return o.stats.response[a]++,o},Framework.prototype.response400=function(e,t,r){return this.responseCode(e,t,400,r)},Framework.prototype.response401=function(e,t,r){return this.responseCode(e,t,401,r)},Framework.prototype.response403=function(e,t,r){return this.responseCode(e,t,403,r)},Framework.prototype.response404=function(e,t,r){return this.responseCode(e,t,404,r)},Framework.prototype.response408=function(e,t,r){return this.responseCode(e,t,408,r)},Framework.prototype.response431=function(e,t,r){return this.responseCode(e,t,431,r)},Framework.prototype.response500=function(e,t,r){var n=this;if(r&&n.error(r,null,e.uri),t.success||t.headersSent)return n;n._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var o={},i=500;return o[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,t.writeHead(i,o),"HEAD"===e.method?t.end():t.end(utils.httpStatus(i)+prepare_error(r)),e.isStaticFile||n.emit("request-end",e,t),n.stats.response.error500++,n},Framework.prototype.response501=function(e,t,r){return this.responseCode(e,t,501,r)},Framework.prototype.responseContent=function(e,t,r,n,o,i,s){var a=this;if(t.success||t.headersSent)return a;e.clear(!0),t.success=!0,(null===n||void 0===n)&&(n="");var u=e.headers["accept-encoding"]||"",c={},l=i?-1!==u.lastIndexOf("gzip"):!1;return c[RESPONSE_HEADER_CACHECONTROL]="private",c.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),s&&utils.extend(c,s,!0),"application/json"===o&&(c[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate"),/text|application/.test(o)&&(o+="; charset=utf-8"),c[RESPONSE_HEADER_CONTENTTYPE]=o,"HEAD"===e.method?(l&&(c["Content-Encoding"]="gzip"),t.writeHead(r,c),t.end(),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,t),a):l?(zlib.gzip(new Buffer(n),function(e,o){return e?(t.writeHead(r,c),void t.end(n,ENCODING)):(c["Content-Encoding"]="gzip",t.writeHead(r,c),void t.end(o,ENCODING))}),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,t),a):(t.writeHead(r,c),t.end(n,ENCODING),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,t),a)},Framework.prototype.responseRedirect=function(e,t,r,n){var o=this;if(!t.success&&!t.headersSent){o._request_stats(!1,e.isStaticFile),e.clear(!0),t.success=!0;var i={Location:r};return i[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML+"; charset=utf-8",t.writeHead(n?301:302,i),t.end(),e.isStaticFile||o.emit("request-end",e,t),o}},Framework.prototype.load=function(e,t,r){var n=this;r&&(n.directory=directory=r),n.isWorker=!0,n.config.debug=e,n.isDebug=e,global.DEBUG=e,global.RELEASE=!e,global.isomorphic=n.isomorphic,n._configure(),n._configure_versions(),n.cache.init(),n.emit("init"),n.isLoaded=!0,setTimeout(function(){try{n.emit("load",n),n.emit("ready",n)}catch(e){n.error(e,'framework.on("load/ready")')}n.removeAllListeners("load"),n.removeAllListeners("ready"),delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert},500),n.$load(t)},Framework.prototype.initialize=function(e,t,r){var n=this;if(null!==n.server)return n;r||(r={});var o=r.port,i=r.ip;return r.config&&framework_utils.copy(r.copy,n.config),n.isHTTPS=typeof e.STATUS_CODES===UNDEFINED,isNaN(o)&&typeof o!==STRING&&(o=null),n.config.debug=t,n.isDebug=t,global.DEBUG=t,global.RELEASE=!t,global.isomorphic=n.isomorphic,n._configure(),n._configure_versions(),n.isTest&&n._configure("config-test",!1),n.cache.init(),n.emit("init"),n.clear(function(){if(n.$load(),n.server=r.https?e.createServer(r.https,n.listener):e.createServer(n.listener),n.config["allow-performance"]&&n.server.on("connection",function(e){e.setNoDelay(!0),e.setKeepAlive(!0,10)}),n.config["allow-websocket"]&&n.server.on("upgrade",framework._upgrade),!o)if("auto"===n.config["default-port"]){var t=parseInt(process.env.PORT||"");isNaN(t)||(o=t)}else o=n.config["default-port"];if(n.port=o||8e3,null!==i?(n.ip=i||n.config["default-ip"]||"127.0.0.1",("null"===n.ip||n.ip===UNDEFINED||"auto"===n.ip)&&(n.ip=void 0)):n.ip=void 0,typeof r.sleep===NUMBER?setTimeout(function(){n.server.listen(n.port,n.ip)},r.sleep):n.server.listen(n.port,n.ip),(void 0===n.ip||null===n.ip)&&(n.ip="auto"),n.isLoaded=!0,process.connected||n.console(),setTimeout(function(){try{n.emit("load",n),n.emit("ready",n)}catch(e){n.error(e,'framework.on("load/ready")')}n.removeAllListeners("load"),n.removeAllListeners("ready")},500),n.isTest){var s=r.sleep||r.delay||1e3;return global.TEST=!0,global.assert=require("assert"),setTimeout(function(){n.test(!0,r.tests||r.test)},s),n}setTimeout(function(){framework.isTest||(delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert)},5e3)},!0),n},Framework.prototype.http=function(e,t){return void 0===t&&(t={}),t.port||(t.port=parseInt(process.argv[2])),this.mode(require("http"),e,t)},Framework.prototype.https=function(e,t){return void 0===t&&(t={}),this.mode(require("https"),e,t)},Framework.prototype.mode=function(e,t,r){var n=!1,o=!1,i=this;switch(t.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":o=!0;break;case"test":case"testing":case"test-debug":case"testing-debug":n=!0,o=!0,i.isTest=!0;break;case"test-release":case"testing-release":case"test-production":case"testing-production":n=!0,o=!1}return i.initialize(e,o,r)},Framework.prototype.console=function(){console.log("===================================================="),console.log("PID          : "+process.pid),console.log("iojs"===process.argv[0]?"io.js        : "+process.version:"node.js      : "+process.version),console.log("total.js     : v"+framework.version_header),console.log("===================================================="),console.log("Name         : "+framework.config.name),console.log("Version      : "+framework.config.version),console.log("Author       : "+framework.config.author),console.log("Date         : "+(new Date).format("yyyy-MM-dd HH:mm:ss")),console.log("Mode         : "+(framework.config.debug?"debug":"release")),console.log("====================================================\n"),console.log("{2}://{0}:{1}/".format(framework.ip,framework.port,framework.isHTTPS?"https":"http")),console.log("")},Framework.prototype.reconnect=function(){var e=this;return void 0!==e.config["default-port"]&&(e.port=e.config["default-port"]),void 0!==e.config["default-ip"]&&(e.ip=e.config["default-ip"]),e.server.close(function(){e.server.listen(e.port,e.ip)}),e},Framework.prototype._service=function(e){var t=this;if(t.config.debug&&(t.resources={}),e%framework.config["default-interval-clear-cache"]===0&&(t.emit("clear","temporary",t.temporary),t.temporary.path={},t.temporary.range={},t.temporary.views={},t.temporary.other={}),e%framework.config["default-interval-precompile-views"]===0)for(var r in t.routes.views){var n=t.routes.views[r];t.install("view",r,n.url,null)}e%framework.config["default-interval-clear-dnscache"]===0&&framework_utils.clearDNS();var o=framework.config["default-interval-websocket-ping"];if(o>0&&e%o===0)for(var n in framework.connections){var i=framework.connections[n];i&&(i.check(),i.ping())}e%framework.config["default-interval-clear-resources"]===0&&(t.emit("clear","resources"),t.resources={},typeof gc!==UNDEFINED&&setTimeout(gc,1e3)),t.emit("service",e);var s=t.schedules.length;if(!s)return t;for(var a=(new Date).getTime(),u=0;;){var c=t.schedules[u++];if(!c)break;c.expire>a||(u--,c.repeat?c.expire=(new Date).add(c.repeat):t.schedules.splice(u,1),c.fn.call(t))}return t},Framework.prototype.listener=function(e,t){var r=framework;if(!e.host)return r.stats.response.destroy++,t.writeHead(403),void t.end();var n=e.headers,o=e.connection.encrypted||"https"===n["x-forwarded-protocol"]?"https":"http";if(t.req=e,e.res=t,e.uri=framework_internal.parseURI(o,e),r.stats.request.request++,r.emit("request",e,t),r._request_check_redirect){var i=r.routes.redirects[o+"://"+e.host];if(i)return r.stats.response.forward++,r.responseRedirect(e,t,i.url+(i.path?e.url:""),i.permanent),r}if(r.restrictions.isRestrictions){if(r.restrictions.isAllowedIP&&-1===r.restrictions.allowedIP.indexOf(e.ip))return r.stats.response.restriction++,t.writeHead(403),t.end(),r;if(r.restrictions.isBlockedIP&&-1!==r.restrictions.blockedIP.indexOf(e.ip))return r.stats.response.restriction++,t.writeHead(403),t.end(),r;if(r.restrictions.isAllowedCustom&&!r.restrictions._allowedCustom(n))return r.stats.response.restriction++,t.writeHead(403),t.end(),r;if(r.restrictions.isBlockedCustom&&r.restrictions._blockedCustom(n))return r.stats.response.restriction++,t.writeHead(403),t.end(),r}if(!e.host)return r.stats.response.destroy++,t.writeHead(403),t.end(),r;e.path=framework_internal.routeSplit(e.uri.pathname),e.body={},e.files=new Array(0),e.processing=0,e.session=null,e.user=null,e.isAuthorized=!0,e.xhr="XMLHttpRequest"===n["x-requested-with"],t.success=!1,t.setHeader("X-Powered-By","total.js v"+r.version_header),r.isDebug&&t.setHeader("Mode","debug"),e.isStaticFile=framework.config["allow-handle-static-files"]?framework_utils.isStaticFile(e.uri.pathname):!1;var s=!0;if(e.isStaticFile)switch(e.extension=path.extname(e.uri.pathname).substring(1),e.extension){case"html":case"htm":case"txt":case"md":s=!0;break;default:s=!1}if(s&&r.onLocate&&(e.$language=r.onLocate(e,t,e.isStaticFile)),r._request_stats(!0,!0),0===r._length_request_middleware)return r._request_continue(e,t,n,o);if(e.behaviour("disable-middleware"))return r._request_continue(e,t,n,o);for(var a=new Array(r._length_request_middleware),u=0,c=0;c<r._length_request_middleware;c++){var l=r.routes.middleware[r.routes.request[c]];l?!function(e){a[u++]=function(r){e.call(framework,t.req,t,r)}}(l):r.error("Middleware not found: "+route.middleware[c],null,e.uri)}a._async_middleware(t,function(){r._request_continue(t.req,t,t.req.headers,o)})},Framework.prototype._request_continue=function(e,t,r,n){var o=this;if(null===e||null===t||t.headersSent||t.success)return o;if(e.isStaticFile)return o.stats.request.file++,0===o._length_files?(o.responseStatic(e,t),o):(new Subscribe(o,e,t,3).file(),o);e.isProxy="total.js"===r["x-proxy"],e.buffer_exceeded=!1,e.buffer_data=new Buffer(""),e.buffer_has=!1,e.$flags=e.method;var i=r.accept;o.stats.request.web++;var s=[e.method.toLowerCase()],a=e.headers["content-type"]||"";e.mobile?(e.$flags+="_m_",o.stats.request.mobile++):o.stats.request.desktop++,e.$flags+=n,e.$type=0,s.push(n);var u=e.method,c=u[0];if("P"===c||"D"===c){var l=a.lastIndexOf(";"),p=a;switch(-1!==l&&(p=p.substring(0,l)),p.substring(p.length-4)){case"json":e.$flags+="json",s.push("json"),e.$type=1,a="";break;case"/xml":e.$flags+="xml",s.push("xml"),e.$type=2,a="";
break;case"oded":e.$type=3,a="";break;case"data":e.$flags+="upload",s.push("upload")}}if(e.isProxy&&(e.$flags+="proxy",s.push("proxy")),"text/event-stream"===i&&(e.$flags+="sse",s.push("sse")),o.config.debug&&(e.$flags+="debug",s.push("debug")),e.xhr&&(o.stats.request.xhr++,e.$flags+="xhr",s.push("xhr")),o._request_check_referer){var f=r.referer||"";""!==f&&-1!==f.indexOf(r.host)&&(e.$flags+="referer",s.push("referer"))}switch(e.flags=s,o.emit("request-begin",e,t),c){case"G":return o.stats.request.get++,new Subscribe(o,e,t,0).end(),o;case"H":return o.stats.request.head++,new Subscribe(o,e,t,0).end(),o;case"D":return o.stats.request["delete"]++,new Subscribe(o,e,t,1).urlencoded(),o;case"P":if(o._request_check_POST)return a?(o.stats.request.upload++,new Subscribe(o,e,t,2).multipart(a)):("PUT"===u?o.stats.request.put++:o.stats.request.post++,new Subscribe(o,e,t,1).urlencoded()),o}return o.emit("request-end",e,t),o._request_stats(!1,!1),o.stats.request.blocked++,t.writeHead(403),t.end(),o},Framework.prototype._upgrade=function(e,t,r){if("websocket"===(e.headers.upgrade||"").toLowerCase()){t.setTimeout(0);var n=framework,o=e.headers,i=e.connection.encrypted||"https"===o["x-forwarded-protocol"]?"https":"http";if(e.uri=framework_internal.parseURI(i,e),n.emit("websocket",e,t,r),n.stats.request.websocket++,n.restrictions.isRestrictions){if(n.restrictions.isAllowedIP&&-1===n.restrictions.allowedIP.indexOf(e.ip))return n.stats.response.restriction++,res.writeHead(403),res.end(),n;if(n.restrictions.isBlockedIP&&-1!==n.restrictions.blockedIP.indexOf(e.ip))return n.stats.response.restriction++,res.writeHead(403),res.end(),n;if(n.restrictions.isAllowedCustom&&!n.restrictions._allowedCustom(o))return n.stats.response.restriction++,res.writeHead(403),res.end(),n;if(n.restrictions.isBlockedCustom&&n.restrictions._blockedCustom(o))return n.stats.response.restriction++,res.writeHead(403),res.end(),n}e.session=null,e.user=null,e.flags=[e.isSecure?"https":"http","get"];var s=framework_utils.path(e.uri.pathname),a=new WebSocketClient(e,t,r);if(e.path=framework_internal.routeSplit(e.uri.pathname),e.websocket=a,n.onLocate&&(e.$language=n.onLocate(e,t)),0===n._length_request_middleware)return n._upgrade_prepare(e,s,o);if(e.behaviour("disable-middleware"))return n._upgrade_prepare(e,s,o);for(var u=new Array(n._length_request_middleware),c=0,l=0;l<n._length_request_middleware;l++){var p=n.routes.middleware[n.routes.request[l]];p?!function(t){u[c++]=function(r){t.call(framework,e,e.websocket,r)}}(p):n.error("Middleware not found: "+route.middleware[l],null,e.uri)}u._async_middleware(a,function(){n._upgrade_prepare(e,s,e.headers)})}},Framework.prototype._upgrade_prepare=function(e,t){var r=this;if(null===r.onAuthorization){var n=r.lookup_websocket(e,e.websocket.uri.pathname,!0);return null===n?(e.websocket.close(),void e.connection.destroy()):void r._upgrade_continue(n,e,t)}r.onAuthorization.call(r,e,e.websocket,e.flags,function(n,o){o&&(e.user=o),e.flags.push(n?"authorize":"unauthorize");var i=r.lookup_websocket(e,e.websocket.uri.pathname,!1);return null===i?(e.websocket.close(),void e.connection.destroy()):void r._upgrade_continue(i,e,t)})},Framework.prototype._upgrade_continue=function(e,t,r){var n=this,o=t.websocket;if(!o.prepare(e.flags,e.protocols,e.allow,e.length,n.version_header))return o.close(),t.connection.destroy(),n;var i=r+(e.flags.length?"#"+e.flags.join("-"):"");e.isBINARY?o.type=1:e.isJSON&&(o.type=3);var s=function(){if(void 0===n.connections[i]){var s=new WebSocket(n,r,e.controller,i);s.route=e,n.connections[i]=s,e.onInitialize.apply(s,framework_internal.routeParam(e.param.length?framework_internal.routeSplit(t.uri.pathname,!0):t.path,e))}o.upgrade(n.connections[i])};if(e.middleware instanceof Array&&e.middleware.length){for(var a=new Array(e.middleware.length),u=0,c=0,l=e.middleware.length;l>c;c++){var p=framework.routes.middleware[e.middleware[c]];p&&!function(r){a[u++]=function(n){r.call(framework,t,o,n,e.options)}}(p)}return a._async_middleware(o,s),n}return s(),n},Framework.prototype._request_stats=function(e){var t=this;return e?t.stats.request.pending++:t.stats.request.pending--,t.stats.request.pending<0&&(t.stats.request.pending=0),t},Framework.prototype.model=function(e){var t=this,r=t.models[e];if(r||null===r)return r;if(void 0!==t.models[e])return t.models[e];var n=path.join(directory,t.config["directory-models"],e+EXTENSION_JS);return fs.existsSync(n)&&t.install("model",e,n,void 0,void 0,void 0,!0),t.models[e]||null},Framework.prototype.source=function(e,t,r){var n=this,o=n.sources[e];if(o||null===o)return o;if(void 0!==n.sources[e])return n.sources[e];var i=path.join(directory,n.config["directory-source"],e+EXTENSION_JS);return fs.existsSync(i)&&n.install("source",e,i,t,r,void 0,!0),n.sources[e]||null},Framework.prototype.include=function(e,t,r){return this.source(e,t,r)},Framework.prototype._log=function(){var e=this;if(!e.isDebug)return!1;for(var t=arguments.length,r=["---->"],n=0;t>n;n++)r.push(arguments[n]);setTimeout(function(){console.log.apply(console,r)},1e3)},Framework.prototype.mail=function(e,t,r,n,o,i){var s=new Controller("",null,null,null,"");s.layoutName="";var a;return i&&(-1!==i.indexOf("@")?(a=i,i=void 0,console.log("OBSOLETE: F.mail(..., ..., [replyTo] --> has been replaced for [language]).")):s.language=i),typeof repository===OBJECT&&null!==repository&&(s.repository=repository),s.mail(e,t,r,n,o,a)},Framework.prototype.view=function(e,t,r,n,o){var i=new Controller("",null,null,null,"");if(typeof r===OBJECT){var s=n;n=r,r=s}i.layoutName=r||"",i.language=o,typeof n===OBJECT&&null!==n&&(i.repository=n);var a=i.view(e,t,!0);return i=null,a},Framework.prototype.assert=function(e,t,r,n,o,i,s){var a=this;if(typeof t===TYPE_FUNCTION)return a.tests.push({name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,run:t}),a;var u="GET",c=0,l=0;if(s=s?framework_utils.extend({},s):{},r instanceof Array){c=r.length;for(var p=0;c>p;p++)switch(r[p].toLowerCase()){case"xhr":s["X-Requested-With"]="XMLHttpRequest";break;case"referer":case"referrer":s.Referer=t;break;case"json":s["Content-Type"]="application/json",l=1;break;case"xml":s["Content-Type"]="text/xml",l=2;break;case"get":case"options":u=r[p].toUpperCase();break;case"upload":s["Content-Type"]="multipart/form-data";break;case"post":case"put":case"delete":u=r[p].toUpperCase(),s["Content-Type"]||(s["Content-Type"]="application/x-www-form-urlencoded");break;case"raw":s["Content-Type"]="application/octet-stream"}}if(s["X-Assertion-Testing"]="1",s["X-Powered-By"]="total.js v"+a.version_header,i){var f=[],d=Object.keys(i);c=d.length;for(var p=0;c>p;p++)f.push(d[p]+"="+encodeURIComponent(i[d[p]]));f.length&&(s.Cookie=f.join("; "))}var m={name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,url:t,callback:n,method:u,data:o,headers:s};return a.tests.push(m),a},Framework.prototype.testing=function(e,t){void 0===e&&(e=!0);var r=this;if(0===r.tests.length){if(0===r.testsFiles.length)return t&&t(framework.isTestError===!0),e&&r.stop(framework.isTestError?1:0),r;var n=r.testsFiles.shift();return n.fn.call(r,r),r.testing(e,t),r}var o=function(e,t,r){var n=Math.floor(new Date-t)+" ms";return r?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==r.name.toLowerCase().indexOf("assert")?r.toString():r.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},i=r.tests.shift(),s=i.name,a=new Date;if(i.run){try{framework.testContinue=function(n){o(s,a,n),n?framework.testsNO++:framework.testsOK++,r.testing(e,t)},i.run.call(r,function(){r.testContinue()},s)}catch(u){o(s,a,u),framework.isTestError=!0,framework.testsNO++,r.testing(e,t)}return r}var c=function(n){n._buffer="",n.on("data",function(e){this._buffer+=e.toString(ENCODING)}),n.on("end",function(){var u=n.headers.cookie||"",c={};if(0!==u.length)for(var l=u.split(";"),p=l.length,f=0;p>f;f++){var d=l[f].trim().split("=");c[d.shift()]=unescape(d.join("="))}try{i.callback(null,n._buffer,n.statusCode,n.headers,c,s),o(s,a),framework.testsOK++,r.testing(e,t)}catch(m){throw framework.testsNO++,o(s,a,m),r.testing(e,t),m}}),n.resume()},l=parser.parse((i.url.indexOf("http://")>0||i.url.indexOf("https://")>0?"":"http://"+r.ip+":"+r.port)+i.url);typeof i.data===TYPE_FUNCTION&&(i.data=i.data()),typeof i.data!==STRING&&(i.data=-1!==(i.headers[RESPONSE_HEADER_CONTENTTYPE]||"").indexOf("json")?JSON.stringify(i.data):qs.stringify(i.data));var p;i.data&&i.data.length&&(p=new Buffer(i.data,ENCODING),i.headers[RESPONSE_HEADER_CONTENTLENGTH]=p.length),l.method=i.method,l.headers=i.headers;var f="https:"===l.protocol?https:http,d="POST"===i.method||"PUT"===i.method?f.request(l,c):f.get(l,c);return d.on("error",function(n){o(s,a,n),r.testsNO++,r.testing(e,t)}),i.data?d.end(p):d.end(),r},Framework.prototype.test=function(e,t,r){var n=this;void 0===e&&(e=!0),typeof t===TYPE_FUNCTION?(r=t,t=[]):t=t||[];var o=0;n.isTest=!0;var i=n.config["directory-tests"];if(!fs.existsSync(utils.combine(i)))return r&&r(),e&&setTimeout(function(){framework.stop(0)},500),n;n._configure("config-test",!0);var s=function(e,t,r){var n=Math.floor(new Date-t)+" ms";return r?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==r.name.toLowerCase().indexOf("assert")?r.toString():r.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},a=function(){0!==framework.testsResults.length&&(console.log(""),console.log("====== RESULTS ======"),console.log(""),framework.testsResults.forEach(function(e){e()}))};return framework.testsFiles=[],framework.testsResults||(framework.testsResults=[]),framework.testsOK||(framework.testsOK=0),framework.testsNO||(framework.testsNO=0),utils.ls(utils.combine(i),function(u){return u.forEach(function(e){var r=path.relative(utils.combine(i),e),a=path.join(directory,e),u=path.extname(a).toLowerCase();if(u===EXTENSION_JS&&(!t.length||-1!==t.indexOf(r.substring(0,r.length-3)))){var c=require(a),l=new Date;try{var p=void 0!==c.run,f=void 0!==c.isInstall,d=void 0!==c.init,m=void 0!==c.load;if(_test=r,c.disabled===!0)return;framework.testsPriority=void 0===c.order&&void 0===c.priority?n.testsFiles.length:c.priority;var h=null;if(p?h=c.run:f?h=c.install:d?h=c.init:m&&(h=c.loadname),null===h)return;n.testsFiles.push({index:n.testsFiles.length,fn:h,priority:framework.testsPriority}),c.usage&&!function(e){framework.testsResults.push(function(){e.usage(r)})}(c),o++}catch(g){s("Failed",l,g)}}}),_test="",0===o?(a(),r&&r(),e?(setTimeout(function(){framework.stop(1)},500),n):n):(n.testsFiles.sort(function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:e.index>t.index?1:e.index<t.index?-1:0}),void setTimeout(function(){console.log("====== TESTING ======"),console.log(""),n.testing(e,function(){console.log(""),console.log("Passed ...",framework.testsOK),console.log("Failed ...",framework.testsNO),console.log(""),a(),n.isTest=!1,console.log(""),r&&r()})},100))}),n},Framework.prototype.clear=function(e,t){var r=this,n=r.path.temp();return t&&r.config["disable-clear-temporary-directory"]?(e&&e(),r):fs.existsSync(n)?(framework_utils.ls(n,function(n,o){if(t){for(var i=[],s=0,a=n.length;a>s;s++){var u=n[s].substring(r.config["directory-temp"].length-1);-1===u.indexOf("/")&&i.push(n[s])}n=i,o=[]}r.unlink(n,function(){r.rmdir(o,e)})}),t||(r.temporary.path={},r.temporary.range={}),this):(e&&e(),r)},Framework.prototype.unlink=function(e,t){var r=this;if(typeof e===STRING&&(e=[e]),!e.length)return void(t&&t());var n=e.shift();return n?(fs.unlink(n,function(){r.unlink(e,t)}),r):void(t&&t())},Framework.prototype.rmdir=function(e,t){var r=this;if(typeof e===STRING&&(e=[e]),!e.length)return void(t&&t());var n=e.shift();return n?(fs.rmdir(n,function(){r.rmdir(e,t)}),r):void(t&&t())},Framework.prototype.encrypt=function(e,t,r){var n=this;if(void 0===e)return"";var o=typeof e;if(typeof t===BOOLEAN){var i=r;r=t,t=i}return o===TYPE_FUNCTION&&(e=e()),o===NUMBER&&(e=e.toString()),o===OBJECT&&(e=JSON.stringify(e)),e.encrypt(n.config.secret+"="+t,r)},Framework.prototype.decrypt=function(e,t,r){if(typeof t===BOOLEAN){var n=r;r=t,t=n}typeof r!==BOOLEAN&&(r=!0);var o=this,i=(e||"").decrypt(o.config.secret+"="+t);if(null===i)return null;if(r){if(i.isJSON())try{return JSON.parse(i)}catch(s){}return null}return i},Framework.prototype.hash=function(e,t,r){var n=crypto.createHash(e),o="";return typeof r===STRING?o=r:r!==!1&&(o=this.config.secret||""),n.update(t.toString()+o,ENCODING),n.digest("hex")},Framework.prototype.resource=function(e,t){t||(t=e,e=null),e||(e="default");var r=this,n=r.resources[e];if(void 0!==n)return n[t]||"";var o=utils.combine(r.config["directory-resources"],e+".resource");if(!fs.existsSync(o))return"";var i=fs.readFileSync(o).toString(ENCODING).parseConfig();return r.resources[e]=i,i[t]||""},Framework.prototype.translate=function(e,t){if(t||(t=e,e=void 0),"#"===t[0]&&" "!==t[1])return this.resource(e,t.substring(1));var r=this.resource(e,"T"+t.hash());return r?r:t},Framework.prototype.translator=function(e,t){return framework_internal.parseLocalization(t,e)},Framework.prototype._configure_dependencies=function(e){if(void 0===e){var t=framework_utils.combine("/","dependencies");e=fs.existsSync(t)?fs.readFileSync(t).toString(ENCODING):""}var r=this;if(!e)return r;for(var n=e.split("\n"),o=0,i=n.length;i>o;o++){var s=n[o];if(""!==s&&"#"!==s[0]&&"// "!==s.substring(0,3)){var a=s.indexOf(" :");if(-1!==a||(a=s.indexOf("	:"),-1!==a)){var u=s.substring(0,a).trim(),c=s.substring(a+2).trim(),l={};if(a=c.indexOf("-->"),-1!==a){var p=c.substring(a+3).trim();p.isJSON()&&(l=JSON.parse(p)),c=c.substring(0,a).trim()}switch(u){case"package":case"packages":case"pkg":r.install("package",c,l);break;case"module":case"modules":r.install("module",c,l);break;case"model":case"models":r.install("model",c,l);break;case"source":case"sources":r.install("source",c,l);break;case"controller":case"controllers":r.install("controller",c,l);break;case"controller":case"controllers":r.install("controller",c,l);break;case"view":case"views":r.install("view",c,l);break;case"version":case"versions":r.install("version",c,l);break;case"config":case"configuration":r.install("config",c,l);break;case"isomorphic":case"isomorphics":r.install("isomorphic",c,l);break;case"definition":case"definitions":r.install("definition",c,l);break;case"middleware":case"middlewares":r.install("middleware",c,l)}}}}return r},Framework.prototype._configure_versions=function(e){var t=this;if(void 0===e){var r=framework_utils.combine("/","versions");e=fs.existsSync(r)?fs.readFileSync(r).toString(ENCODING):"",t.versions=null}if(!e)return t.versions=null,t;for(var n=e.split("\n"),o={},i=0,s=n.length;s>i;i++){var a=n[i];if(""!==a&&"#"!==a[0]&&"// "!==a.substring(0,3)){"/"!==a[0]&&(a="/"+a);var u=a.indexOf(" :"),c=!1;if(-1===u&&(u=a.indexOf("	:"),-1===u)){if(u=a.indexOf("-->"),-1===u)continue;c=!0}var l=c?3:2,p=a.substring(0,u).trim(),r=a.substring(u+l).trim();o[p]=r,c&&t.map(r,t.path["public"](p))}}return t.versions=o,t},Framework.prototype._configure=function(e,t){var r=this,n=typeof e;if(n===STRING){var o=utils.combine("/",e);if(!fs.existsSync(o))return r;e=fs.readFileSync(o).toString(ENCODING).split("\n")}if(void 0===e){var i=utils.combine("/","config"),s=utils.combine("/","config-"+(r.config.debug?"debug":"release"));e=[];var a=r.path.configs();if(fs.existsSync(a))for(var u=fs.readdirSync(a),c=0,l=u.length;l>c;c++){var p=u[c].match(/\-(debug|release|test)$/i);if(p){if(p=p[0].toString().toLowerCase(),"-debug"===p&&!r.isDebug)continue;if("-release"===p&&r.isDebug)continue;if("-test"===p&&!r.isTest)continue}e=e.concat(fs.readFileSync(a+u[c]).toString(ENCODING).split("\n"))}fs.existsSync(i)&&fs.lstatSync(i).isFile()&&(e=e.concat(fs.readFileSync(i).toString(ENCODING).split("\n"))),fs.existsSync(s)&&fs.lstatSync(s).isFile()&&(e=e.concat(fs.readFileSync(s).toString(ENCODING).split("\n")))}var f=function(){process.title="total: "+r.config.name.removeDiacritics().toLowerCase().replace(/\s/g,"-").substring(0,8),r.isVirtualDirectory=fs.existsSync(utils.combine(r.config["directory-public-virtual"]))};if(!e instanceof Array)return f(),r;if(!e.length)return f(),r;void 0===t&&(t=!0);for(var u,d={},m=null,l=e.length,c=0;l>c;c++){var h=e[c];if(""!==h&&"#"!==h[0]&&"/"!==h[0]&&"/"!==h[1]){var g=h.indexOf(":");if(-1!==g){var v=h.substring(0,g).trim();if("debug"!==v&&"resources"!==v){var y=h.substring(g+1).trim();switch(v){case"default-request-length":case"default-websocket-request-length":case"default-request-timeout":case"default-interval-clear-cache":case"default-interval-clear-resources":case"default-interval-precompile-views":case"default-interval-websocket-ping":case"default-maximum-file-descriptors":case"default-interval-clear-dnscache":d[v]=utils.parseInt(y);break;case"static-accepts-custom":m=y.replace(/\s/g,"").split(",");break;case"static-accepts":d[v]={},u=y.replace(/\s/g,"").split(",");for(var b=0;b<u.length;b++)d[v][u[b]]=!0;break;case"allow-compile-js":console.log("CONFIG: allow-compile-js is obsolete, use: allow-compile-script"),d["allow-compile-script"]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"allow-compile-css":console.log("CONFIG: allow-compile-css is obsolete, use: allow-compile-style"),d["allow-compile-style"]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"allow-gzip":case"allow-websocket":case"allow-performance":case"allow-compile-html":case"allow-compile-style":case"allow-compile-script":case"disable-strict-server-certificate-validation":case"disable-clear-temporary-directory":d[v]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"allow-compress-html":d["allow-compile-html"]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"version":d[v]=y;break;case"static-url-css":console.log('OBSOLETE "config.static-url-css": use "config.static-url-style"'),d["static-url-style"]=y;break;case"static-url-js":console.log('OBSOLETE "config.static-url-js": use "config.static-url-script"'),d["static-url-script"]=y;break;default:d[v]=y.isNumber()?utils.parseInt(y):y.isNumber(!0)?utils.parseFloat(y):y.isBoolean()?"true"===y.toLowerCase():y}}}}}return utils.extend(r.config,d,t),""===r.config["etag-version"]&&(r.config["etag-version"]=r.config.version.replace(/\.|\s/g,"")),r.config["default-timezone"]&&(process.env.TZ=r.config["default-timezone"]),null!==m&&m.length&&m.forEach(function(e){r.config["static-accepts"][e]=!0}),r.config["disable-strict-server-certificate-validation"]===!0&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),r.config["allow-performance"]&&(http.globalAgent.maxSockets=9999),f(),r.emit("configure",r.config),r},Framework.prototype.routeJS=function(e){return console.log("OBSOLETE framework.routeJS(): use framework.routeScript()"),this.routeScript(e)},Framework.prototype.routeScript=function(e){var t=this;return-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS),t._routeStatic(e,t.config["static-url-script"])},Framework.prototype.routeCSS=function(e){return console.log("OBSOLETE framework.routeCSS(): use framework.routeStyle()"),this.routeStyle(e)},Framework.prototype.routeStyle=function(e){var t=this;return-1===e.lastIndexOf(".css")&&(e+=".css"),t._routeStatic(e,t.config["static-url-style"])},Framework.prototype.routeImage=function(e){var t=this;return t._routeStatic(e,t.config["static-url-image"])},Framework.prototype.routeVideo=function(e){var t=this;return t._routeStatic(e,t.config["static-url-video"])},Framework.prototype.routeFont=function(e){var t=this;return t._routeStatic(e,t.config["static-url-font"])},Framework.prototype.routeDownload=function(e){var t=this;return t._routeStatic(e,t.config["static-url-download"])},Framework.prototype.routeStatic=function(e){var t=this;return t._routeStatic(e,t.config["static-url"])},Framework.prototype._routeStatic=function(e,t){return this._version(("/"===e[0]?"":t)+this._version(e))},Framework.prototype._version=function(e){var t=this;return null!==t.versions&&(e=t.versions[e]||e),null!==t.onVersion&&(e=t.onVersion(e)||e),e},Framework.prototype._version_prepare=function(e){var t=this,r=e.match(REG_VERSIONS);if(!r)return e;for(var n=0,o=r.length;o>n;n++){var i=r[n].toString(),s=5;"h"===i[0]&&(s=6);var a=i.substring(s,i.length-1);e=e.replace(r[n],i.substring(0,s)+t._version(a)+'"')}return e},Framework.prototype.lookup=function(e,t,r,n){var o=this,i="#"===t[0],s=null===e.subdomain?null:e.subdomain.join(".");i&&(e.path=[t]),e.$isAuthorized=!0;var a;if(!i&&(a="#"+t+"$"+e.$flags+(s?"$"+s:""),framework.temporary.other[a]))return framework.temporary.other[a];for(var u=o.routes.web.length,c=0;u>c;c++){var l=o.routes.web[c];if(l.CUSTOM){if(!l.CUSTOM(t,e,r))continue}else{if(!framework_internal.routeCompareSubdomain(s,l.subdomain))continue;if(l.isASTERIX){if(!framework_internal.routeCompare(e.path,l.url,i,!0))continue}else if(!framework_internal.routeCompare(e.path,l.url,i))continue}{if(!i){if(l.isPARAM&&l.regexp){for(var p=!1,f=0,d=l.regexpIndexer.length;d>f;f++){var m=e.path[l.regexpIndexer[f]];if(void 0===m){p=!0;break}if(!l.regexp[l.regexpIndexer[f]].test(m)){p=!0;break}}if(p)continue}if(null!==l.flags&&l.flags.length){var h=framework_internal.routeCompareFlags2(e,l,n?!0:l.isMEMBER);if(-1===h&&(e.$isAuthorized=!1),1>h)continue}return a&&l.isCACHE&&e.$isAuthorized&&(framework.temporary.other[a]=l),l}if(l.isSYSTEM)return l}}return null},Framework.prototype.lookup_websocket=function(e,t,r){var n=this,o=null===e.subdomain?null:e.subdomain.join("."),i=n.routes.websockets.length;e.$isAuthorized=!0;for(var s=0;i>s;s++){var a=n.routes.websockets[s];if(a.CUSTOM){if(!a.CUSTOM(t,e))continue}else{if(!framework_internal.routeCompareSubdomain(o,a.subdomain))continue;if(a.isASTERIX){if(!framework_internal.routeCompare(e.path,a.url,!1,!0))continue}else if(!framework_internal.routeCompare(e.path,a.url,!1))continue}if(a.isPARAM&&a.regexp){for(var u=!1,c=0,l=a.regexpIndexer.length;l>c;c++){var p=e.path[a.regexpIndexer[c]];if(void 0===p){u=!0;break}if(!a.regexp[a.regexpIndexer[c]].test(p)){u=!0;break}}if(u)continue}if(null!==a.flags&&a.flags.length){var f=framework_internal.routeCompareFlags2(e,a,r?!0:a.isMEMBER);if(-1===f&&(e.$isAuthorized=!1),1>f)continue}return a}return null},Framework.prototype.accept=function(e,t){var r=this;return"."!==e[0]&&(e="."+e),r.config["static-accepts"][e]=!0,t&&utils.setContentType(e,t),r},Framework.prototype.worker=function(e,t,r){var n=this,o=null,i=typeof t;if(i===NUMBER&&void 0===r&&(r=t,t=null,i=UNDEFINED),i===STRING&&(o=n.workers[t]||null),null!==o)return o;var s=utils.combine(n.config["directory-workers"],e)+EXTENSION_JS;return o=child.fork(s,{cwd:directory}),t=e+"_"+(new Date).getTime(),o.__id=t,n.workers[t]=o,o.on("exit",function(){var e=this;e.__timeout&&clearTimeout(e.__timeout),delete framework.workers[e.__id]}),typeof r!==NUMBER?o:(o.__timeout=setTimeout(function(){o.kill(),o=null},r),o)},FrameworkRestrictions.prototype.allow=function(e,t){var r=this;return void 0===t?(r.allowedIP.push(e),r.refresh(),framework):(void 0===r.allowedCustom[e]?r.allowedCustom[e]=[t]:r.allowedCustom[e].push(t),r.refresh(),framework)},FrameworkRestrictions.prototype.disallow=function(e,t){var r=this;return void 0===t?(r.blockedIP.push(e),r.refresh(),framework):(void 0===r.blockedCustom[e]?r.blockedCustom[e]=[t]:r.blockedCustom[e].push(t),r.refresh(),framework)},FrameworkRestrictions.prototype.refresh=function(){var e=this;return e.isAllowedIP=e.allowedIP.length>0,e.isBlockedIP=e.blockedIP.length>0,e.isAllowedCustom=!utils.isEmpty(e.allowedCustom),e.isBlockedCustom=!utils.isEmpty(e.blockedCustom),e.allowedCustomKeys=Object.keys(e.allowedCustom),e.blockedCustomKeys=Object.keys(e.blockedCustom),e.isRestrictions=e.isAllowedIP||e.isBlockedIP||e.isAllowedCustom||e.isBlockedCustom,framework},FrameworkRestrictions.prototype.clearIP=function(){var e=this;return e.allowedIP=[],e.blockedIP=[],e.refresh(),framework},FrameworkRestrictions.prototype.clearHeaders=function(){var e=this;return e.allowedCustom={},e.blockedCustom={},e.allowedCustomKeys=[],e.blockedCustomKeys=[],e.refresh(),framework},FrameworkRestrictions.prototype._allowedCustom=function(e){for(var t=this,r=t.allowedCustomKeys.length,n=0;r>n;n++){var o=t.allowedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=t.allowedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!1}return!0},FrameworkRestrictions.prototype._blockedCustom=function(e){for(var t=this,r=t.blockedCustomKeys.length,n=0;r>n;n++){var o=t.blockedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=t.blockedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!0}return!1},FrameworkFileSystem.prototype.deleteStyle=function(e){var t=this;-1===e.lastIndexOf(".css")&&(e+=".css");var r=utils.combine(framework.config["directory-public"],framework.config["static-url-style"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteScript=function(e){var t=this;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var r=utils.combine(framework.config["directory-public"],framework.config["static-url-script"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteView=function(e){var t=this;-1===e.lastIndexOf(".html")&&(e+=".html");var r=utils.combine(framework.config["directory-views"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteDatabase=function(e){var t=this,r=utils.combine(framework.config["directory-databases"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteWorker=function(e){var t=this;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var r=utils.combine(framework.config["directory-workers"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteResource=function(e){var t=this;-1===e.lastIndexOf(".resource")&&(e+=".resource");var r=utils.combine(framework.config["directory-resources"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteTemporary=function(e){var t=this,r=utils.combine(framework.config["directory-temp"],e);return t.deleteFile(r)},FrameworkFileSystem.prototype.deleteFile=function(e){return fsFileExists(e,function(t){t&&fs.unlink(e)}),!0},FrameworkFileSystem.prototype.createStyle=function(e,t,r,n){var o=this;if(!t)return!1;-1===e.lastIndexOf(".css")&&(e+=".css");var i=utils.combine(framework.config["directory-public"],framework.config["static-url-style"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createScript=function(e,t,r,n){var o=this;if(!t)return!1;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var i=utils.combine(framework.config["directory-public"],framework.config["static-url-script"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createDatabase=function(e,t,r,n){var o=this;if(!t)return!1;var i=utils.combine(framework.config["directory-databases"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createView=function(e,t,r,n){var o=this;if(!t)return!1;-1===e.lastIndexOf(".html")&&(e+=".html"),framework.path.verify("views");var i=utils.combine(framework.config["directory-views"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createWorker=function(e,t,r,n){var o=this;if(!t)return!1;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS),framework.path.verify("workers");var i=utils.combine(framework.config["directory-workers"],e);return o.createFile(i,t,n,r)},FrameworkFileSystem.prototype.createResource=function(e,t,r,n){var o=this;if(!t)return!1;-1===e.lastIndexOf(".resource")&&(e+=".resource");var i=t;typeof t===OBJECT&&(i="",Object.keys(t).forEach(function(e){i+=e.padRight(20," ")+": "+t[e]+"\n"})),framework.path.verify("resources");var s=utils.combine(framework.config["directory-resources"],e);return o.createFile(s,i,n,r)},FrameworkFileSystem.prototype.createTemporary=function(e,t,r){var n=this;if("string"==typeof t)return void Utils.download(t,["get"],function(t,o){return t?r?r(t):void F.error(t):void n.createTemporary(e,o,r)});framework.path.verify("temp");var o=utils.combine(framework.config["directory-temp"],e),i=fs.createWriteStream(o);return r?(i.on("error",function(e){r(e,o)}),i.on("finish",function(){r(null,o)}),t.pipe(i),n):(t.pipe(i),n)},FrameworkFileSystem.prototype.createFile=function(e,t,r,n,o){var i=this;if("http://"===t.substring(0,7)||"https://"===t.substring(0,8))return utils.request(t,["get"],function(t,s){t||i.createFile(e,s,r,n),typeof o===TYPE_FUNCTION&&o(t,e)}),!0;if(!t)return!1;var s=fs.existsSync(e);if(s&&r){var a=fs.readFileSync(e).toString(ENCODING);return-1===a.indexOf(t)?(fs.appendFileSync(e,"\n"+t),!0):!1}return s&&!n?!1:(fs.writeFileSync(e,t,ENCODING),typeof o===TYPE_FUNCTION&&o(null,e),!0)},FrameworkPath.prototype.verify=function(e){var t="$directory-"+e;if(framework.temporary.path[t])return framework;var r=utils.combine(framework.config["directory-"+e]);return fs.existsSync(r)||fs.mkdirSync(r),framework.temporary.path[t]=!0,framework},FrameworkPath.prototype["public"]=function(e){return utils.combine(framework.config["directory-public"],e||"")},FrameworkPath.prototype["private"]=function(e){return utils.combine(framework.config["directory-private"],e||"")},FrameworkPath.prototype.isomorphic=function(e){return utils.combine(framework.config["directory-isomorphic"],e||"")},FrameworkPath.prototype.configs=function(e){return utils.combine(framework.config["directory-configs"],e||"")},FrameworkPath.prototype.virtual=function(e){return utils.combine(framework.config["directory-public-virtual"],e||"")},FrameworkPath.prototype.logs=function(e){return this.verify("logs"),utils.combine(framework.config["directory-logs"],e||"")},FrameworkPath.prototype.models=function(e){return utils.combine(framework.config["directory-models"],e||"")},FrameworkPath.prototype.temp=function(e){return this.verify("temp"),utils.combine(framework.config["directory-temp"],e||"")},FrameworkPath.prototype.temporary=function(e){return this.temp(e)},FrameworkPath.prototype.views=function(e){return utils.combine(framework.config["directory-views"],e||"")},FrameworkPath.prototype.workers=function(e){return utils.combine(framework.config["directory-workers"],e||"")},FrameworkPath.prototype.databases=function(e){return this.verify("databases"),utils.combine(framework.config["directory-databases"],e||"")},FrameworkPath.prototype.modules=function(e){return utils.combine(framework.config["directory-modules"],e||"")},FrameworkPath.prototype.controllers=function(e){return utils.combine(framework.config["directory-controllers"],e||"")},FrameworkPath.prototype.definitions=function(e){return utils.combine(framework.config["directory-definitions"],e||"")},FrameworkPath.prototype.tests=function(e){return utils.combine(framework.config["directory-tests"],e||"")},FrameworkPath.prototype.resources=function(e){return utils.combine(framework.config["directory-resources"],e||"")},FrameworkPath.prototype.root=function(e){return path.join(directory,e||"")},FrameworkPath.prototype.services=function(e){return utils.combine(framework.config["directory-services"],e||"")},FrameworkPath.prototype["package"]=function(e,t){return path.join(directory,framework.config["directory-temp"],e,t||"")},FrameworkPath.prototype.packages=function(e){return path.join(directory,framework.config["directory-packages"],e||"")},FrameworkCache.prototype.init=function(e){var t=this;return t.interval=setInterval(function(){framework.cache.recycle()},e||6e4),t},FrameworkCache.prototype.stop=function(){var e=this;return clearInterval(e.interval),e},FrameworkCache.prototype.clear=function(){var e=this;return e.items={},e},FrameworkCache.prototype.recycle=function(){var e=this,t=e.items,r=new Date;e.count++;for(var n in t){var o=t[n];o.expire<r&&(framework.emit("cache-expire",n,o.value),delete t[n])}return framework._service(e.count),e},FrameworkCache.prototype.add=function(e,t,r,n){var o=this,i=typeof r;switch(i){case STRING:r=r.parseDateExpiration();break;case UNDEFINED:r=(new Date).add("m",5)}return o.items[e]={value:t,expire:r},framework.emit("cache-set",e,t,r,n),t},FrameworkCache.prototype.set=function(e,t,r,n){return this.add(e,t,r,n)
},FrameworkCache.prototype.read=function(e){return this.get(e)},FrameworkCache.prototype.get=function(e,t){var r=this,n=r.items[e]||null;return null===n?typeof t===UNDEFINED?null:t:n.expire<new Date?typeof t===UNDEFINED?null:t:n.value},FrameworkCache.prototype.setExpire=function(e,t){var r=this,n=r.items[e];return void 0===n?r:(typeof t===STRING&&(t=t.parseDateExpiration()),n.expire=t,r)},FrameworkCache.prototype.remove=function(e){var t=this,r=t.items[e]||null;return delete t.items[e],r},FrameworkCache.prototype.removeAll=function(e){var t=this,r=0,n=utils.isRegExp(e);for(var o in t.items){if(n){if(!e.test(o))continue}else if(-1===o.indexOf(e))continue;t.remove(o),r++}return r},FrameworkCache.prototype.fn=function(e,t,r){var n=this,o=n.read(e);return null!==o?(r&&r(o),n):(t(function(t,o){n.add(e,t,o),r&&r(t)}),n)};var REPOSITORY_HEAD="$head",REPOSITORY_META="$meta",REPOSITORY_META_TITLE="$title",REPOSITORY_META_DESCRIPTION="$description",REPOSITORY_META_KEYWORDS="$keywords",REPOSITORY_META_IMAGE="$image",REPOSITORY_PLACE="$place",ATTR_END='"';Subscribe.prototype.success=function(){var e=this;return e.timeout&&clearTimeout(e.timeout),e.timeout=null,e.isCanceled=!0,e},Subscribe.prototype.file=function(){var e=this;return e.req.on("end",function(){e.doEndfile(this)}),e.req.resume(),e},Subscribe.prototype.multipart=function(e){var t=this,r=t.req;return t.route=framework.lookup(r,r.uri.pathname,r.flags,!0),t.header=e,null===t.route?(framework._request_stats(!1,!1),framework.stats.request.blocked++,t.res.writeHead(403),t.res.end(),t):(framework.path.verify("temp"),framework_internal.parseMULTIPART(r,e,t.route,framework.config["directory-temp"],t),t)},Subscribe.prototype.urlencoded=function(){var e=this;return e.route=framework.lookup(e.req,e.req.uri.pathname,e.req.flags,!0),null===e.route?(e.req.clear(!0),framework.stats.request.blocked++,framework._request_stats(!1,!1),e.res.writeHead(403),e.res.end(),e):(e.req.buffer_has=!0,e.req.buffer_exceeded=!1,e.req.on("data",function(t){e.doParsepost(t)}),e.end(),e)},Subscribe.prototype.end=function(){var e=this;e.req.on("end",function(){e.doEnd()}),e.req.resume()},Subscribe.prototype.execute=function(e){var t=this,r=t.route,n=t.req,o=t.res;if((null===r||"#"===r.controller[0])&&e>399)switch(e){case 400:framework.stats.response.error400++;break;case 401:framework.stats.response.error401++;break;case 403:framework.stats.response.error403++;break;case 404:framework.stats.response.error404++;break;case 408:framework.stats.response.error408++;break;case 431:framework.stats.response.error431++;break;case 500:framework.stats.response.error500++;break;case 501:framework.stats.response.error501++}if(null===r)return e||(e=404),400===e&&t.exception instanceof Builders.ErrorBuilder?(n.$language&&t.exception.resource(n.$language,framework.config["default-errorbuilder-resource-prefix"]),framework.responseContent(n,o,200,t.exception.json(),"application/json",framework.config["allow-gzip"]),t):(framework.responseContent(n,o,e,utils.httpStatus(e)+prepare_error(t.exception),CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),t);var i=r.controller;r.isMOBILE_VARY&&(n.$mobile=!0),void 0===r.currentViewDirectory&&(r.currentViewDirectory="#"!==i[0]&&"default"!==i&&""!==i?"/"+i+"/":"");var s=new Controller(i,n,o,t,r.currentViewDirectory);if(s.isTransfer=t.isTransfer,s.exception=t.exception,t.controller=s,!t.isCanceled&&r.timeout>0&&(t.timeout=setTimeout(function(){t.doCancel()},r.timeout)),r.isDELAY&&t.res.writeContinue(),0===framework._length_middleware||null===r.middleware)return t.doExecute();for(var a=r.middleware.length,u=new Array(a),c=0,l=0;a>l;l++){var p=framework.routes.middleware[r.middleware[l]];p?!function(e){u[c++]=function(t){e.call(s,n,o,t,r.options,s)}}(p):framework.error("Middleware not found: "+r.middleware[l],s.name,n.uri)}return u._async_middleware(o,function(){t.doExecute()}),t},Subscribe.prototype.prepare=function(e,t){var r=this,n=r.req,o=r.res;if(framework.onAuthorization){var i=e.length;return framework.onAuthorization(n,o,e,function(t,o){i!==e.length&&(n.$flags+=e.slice(i).join("")),typeof t!==BOOLEAN&&(o=t,t=!o),n.isAuthorized=t,r.doAuthorization(t,o)}),r}return null===r.route&&(r.route=framework.lookup(n,n.buffer_exceeded?"#431":t||n.uri.pathname,n.flags)),null===r.route&&(r.route=framework.lookup(n,"#404")),r.execute(n.buffer_exceeded?431:404),r},Subscribe.prototype.doExecute=function(){var e=this,t=e.route.controller,r=e.controller,n=e.req;try{return r.isCanceled?e:(framework.emit("controller",r,t,e.route.options),r.isCanceled?e:(e.route.isCACHE&&!framework.temporary.other[n.uri.pathname]&&(framework.temporary.other[n.uri.pathname]=n.path),e.route.isGENERATOR?async.call(r,e.route.execute,!0)(r,framework_internal.routeParam(e.route.param.length?framework_internal.routeSplit(n.uri.pathname,!0):n.path,e.route)):e.route.execute.apply(r,framework_internal.routeParam(e.route.param.length?framework_internal.routeSplit(n.uri.pathname,!0):n.path,e.route)),e))}catch(o){r=null,framework.error(o,t,n.uri),e.exception=o,e.route=framework.lookup(n,"#500"),e.execute(500)}return e},Subscribe.prototype.doAuthorization=function(e,t){var r=this,n=r.req,o=e?"authorize":"unauthorize";n.flags.push(o),n.$flags+=o,t&&(n.user=t);var i=framework.lookup(n,n.buffer_exceeded?"#431":n.uri.pathname,n.flags),s=n.$isAuthorized?404:401;return null===i&&(i=framework.lookup(n,"#"+s)),r.route=i,r.execute(n.buffer_exceeded?431:s),r},Subscribe.prototype.doEnd=function(){var e=this,t=e.req,r=e.res,n=e.route;if(t.buffer_exceeded)return n=framework.lookup(t,"#431"),null===n?(framework.response431(t,r),e):(e.route=n,e.execute(431),e);t.buffer_data=t.buffer_data.toString(ENCODING);if(!t.buffer_data)return n&&n.schema?(e.onSchema(t,n.schema[0],n.schema[1],function(r,n){return r?(e.route400(r),e):(t.body=n,void e.prepare(t.flags,t.uri.pathname))}),e):(t.buffer_data=null,e.prepare(t.flags,t.uri.pathname),e);if(n.isXML){if(2!==t.$type)return e.route400(new Error("The request validation (The content-type is not text/xml).")),e;try{t.body=utils.parseXML(t.buffer_data.trim()),t.buffer_data=null,e.prepare(t.flags,t.uri.pathname)}catch(o){F.error(o,null,t.uri),e.route500(o)}return e}if(e.route.isRAW)return t.body=t.buffer_data,e.prepare(t.flags,t.uri.pathname),e;if(0===t.$type)return e.route400(new Error("The request validation (The content-type is not x-www-form-urlencoded).")),e;if(1===t.$type)try{t.body=JSON.parse(t.buffer_data)}catch(i){return e.route400(new Error("Not valid JSON data.")),e}else t.body=qs.parse(t.buffer_data);return n.schema?(framework.onSchema(t,n.schema[0],n.schema[1],function(r,n){return r?(e.route400(r),e):(t.body=n,void e.prepare(t.flags,t.uri.pathname))}),e):(e.prepare(t.flags,t.uri.pathname),e)},Subscribe.prototype.route400=function(e){var t=this;return t.route=framework.lookup(t.req,"#400"),t.exception=e,t.execute(400),t},Subscribe.prototype.route500=function(e){var t=this;return t.route=framework.lookup(t.req,"#500"),t.exception=e,t.execute(500),t},Subscribe.prototype.doEndfile=function(){var e=this,t=e.req,r=e.res;if(!framework._length_files)return void framework.responseStatic(e.req,e.res);for(var n=0;n<framework._length_files;n++){var o=framework.routes.files[n];try{if(o.onValidation.call(framework,t,r,!0))return null===o.middleware?o.execute.call(framework,t,r,!1):e.doEndfile_middleware(o),e}catch(i){return framework.error(i,o.controller+" :: "+o.name,t.uri),framework.responseContent(t,r,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),e}}return framework.responseStatic(e.req,e.res),e},Subscribe.prototype.doEndfile_middleware=function(e){for(var t=e.middleware.length,r=new Array(t),n=this,o=n.req,i=n.res,s=0,a=0;t>a;a++){var u=framework.routes.middleware[e.middleware[a]];u&&!function(t){r[s++]=function(r){t.call(framework,o,i,r,e.options)}}(u)}return r._async_middleware(i,function(){try{e.execute.call(framework,o,i,!1)}catch(t){return framework.error(t,e.controller+" :: "+e.name,o.uri),framework.responseContent(o,i,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),n}}),n},Subscribe.prototype.doParsepost=function(e){var t=this,r=t.req;return r.buffer_exceeded?t:(r.buffer_exceeded||(r.buffer_data=Buffer.concat([r.buffer_data,e])),r.buffer_data.length/1024<t.route.length?t:(r.buffer_exceeded=!0,r.buffer_data=new Buffer(""),t))},Subscribe.prototype.doCancel=function(){var e=this;framework.stats.response.timeout++,clearTimeout(e.timeout),e.timeout=null,null!==e.controller&&(e.controller.isTimeout=!0,e.controller.isCanceled=!0,e.route=framework.lookup(e.req,"#408"),e.execute(408))},Controller.prototype={get sseID(){return this.req.headers["last-event-id"]||null},get flags(){return this.subscribe.route.flags},get path(){return framework.path},get fs(){return framework.fs},get get(){return this.req.query},get query(){return this.req.query},get post(){return this.req.body},get body(){return this.req.body},get files(){return this.req.files},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return utils.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return framework.cache},get config(){return framework.config},get controllers(){return framework.controllers},get isProxy(){return this.req.isProxy},get isDebug(){return framework.config.debug},get isTest(){return"1"===this.req.headers["x-assertion-testing"]},get isSecure(){return this.req.isSecure},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e},get global(){return framework.global},set global(e){framework.global=e},get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async},get viewname(){var e=this.req.path[this.req.path.length-1];return(""===e||void 0===e||"/"===e)&&(e="index"),e}},Controller.prototype.validation=function(e,t,r,n){return this.validate(e,t,r,n)},Controller.prototype.clear=function(){var e=this;return e.req.clear(),e},Controller.prototype.translate=function(e){return framework.translate(this.language,e)},Controller.prototype.middleware=function(e,t,r){if(typeof e===STRING&&(e=[e]),typeof t===TYPE_FUNCTION){var n=r;r=t,t=n}(void 0===t||null===t)&&(t={});for(var o=this,i=e.length,s=new Array(i),a=0,u=0;i>u;u++){var c=framework.routes.middleware[e[u]];c&&!function(e,t){s[a++]=function(r){e.call(framework,o.req,o.res,r,t)}}(c,void 0===t[e[u]]?t:t[e[u]])}return s._async_middleware(o.res,r,controller),o},Controller.prototype.pipe=function(e,t,r){var n=this;if(typeof t===TYPE_FUNCTION){var o=r;r=t,t=o}return n.res.success||n.res.headersSent||!n.isConnected?n:(framework.responsePipe(n.req,n.res,e,t,null,function(){n.subscribe.success(),r&&r()}),n)},Controller.prototype.encrypt=function(){return framework.encrypt.apply(framework,arguments)},Controller.prototype.decrypt=function(){return framework.decrypt.apply(framework,arguments)},Controller.prototype.hash=function(){return framework.hash.apply(framework,arguments)},Controller.prototype.date=function(e,t,r){void 0===r&&(r=t,t=new Date);var n=typeof t===STRING?t.parseDate():t,o=typeof r===STRING?r.parseDate():r,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},Controller.prototype.validate=function(e,t,r,n){var o=this,i=function(e){return o.resource(n||"default",(r||"")+e)};if(typeof t===STRING)return builders.validate(t,e,r);var s=new builders.ErrorBuilder(i);return utils.validate.call(o,e,t,framework.onValidation,s)},Controller.prototype.header=function(e,t){var r=this;return r.res.setHeader(e,t),r},Controller.prototype.host=function(e){var t=this;return t.req.hostname(e)},Controller.prototype.hostname=function(e){var t=this;return t.req.hostname(e)},Controller.prototype.cors=function(e,t,r,n){var o=this,i=o.req.headers.origin,s="OPTIONS"===o.req.method.toUpperCase();if(void 0===i)return!0;void 0===e&&(e="*"),typeof t===BOOLEAN&&(n=t,t=null),typeof r===BOOLEAN&&(n=r,r=null),utils.isArray(e)||(e=[e]);var a,u=!1,c=!1,l=o.req.headers;if(r){utils.isArray(r)||(r=[r]);for(var p=0;p<r.length;p++)if(l[r[p].toLowerCase()]){u=!0;break}if(!u)return!1;u=!1}if(t){utils.isArray(t)||(t=[t]);for(var f=l["access-control-request-method"]||o.req.method,p=0;p<t.length;p++)a=t[p].toUpperCase(),t[p]=a,-1!==f.indexOf(a)&&(u=!0);if(!u)return!1;u=!1}for(var p=0;p<e.length;p++)if(a=e[p],"*"===a||-1!==i.indexOf(a)){c="*"===a,u=!0;break}if(!u)return!1;var d,m;return o.res.setHeader("Access-Control-Allow-Origin",c?"*":i),n&&o.res.setHeader("Access-Control-Allow-Credentials","true"),m="Access-Control-Allow-Methods",t?o.res.setHeader(m,t.join(", ")):s&&(d=l["access-control-request-method"],d&&o.res.setHeader(m,d)),m="Access-Control-Allow-Headers",r?o.res.setHeader(m,r.join(", ")):s&&(d=l["access-control-request-headers"],d&&o.res.setHeader(m,d)),!0},Controller.prototype.error=function(e){var t=this,r=framework.error(typeof e===STRING?new Error(e):e,t.name,t.uri);return void 0===e?r:t.subscribe?(t.subscribe.exception=e,t.exception=e,t):t},Controller.prototype.problem=function(e){var t=this;return framework.problem(e,t.name,t.uri,t.ip),t},Controller.prototype.change=function(e){var t=this;return framework.change(e,t.name,t.uri,t.ip),t},Controller.prototype.transfer=function(e,t){var r=this,n=framework.routes.web.length,o=framework_internal.routeSplit(e.trim()),i="#"===e[0],s=null===t||void 0===t||0===t.length,a=null;r.req.$isAuthorized=!0;for(var u=0;n>u;u++){var c=framework.routes.web[u];if(c.isASTERIX){if(!framework_internal.routeCompare(o,c.url,i,!0))continue}else if(!framework_internal.routeCompare(o,c.url,i))continue;if(s){a=c;break}if(null!==c.flags&&c.flags.length){var l=framework_internal.routeCompareFlags(c.flags,t,!0);if(-1===l&&(r.req.$isAuthorized=!1),1>l)continue}a=c;break}return a?(r.cancel(),r.req.path=new Array(0),r.subscribe.isTransfer=!0,r.subscribe.success(),r.subscribe.route=a,r.subscribe.execute(404),!0):!1},Controller.prototype.cancel=function(){var e=this;return typeof e._async!==UNDEFINED&&e._async.cancel(),e.isCanceled=!0,e},Controller.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},Controller.prototype.logger=function(){var e=this;return framework.logger.apply(framework,arguments),e},Controller.prototype.meta=function(){var e=this;return e.repository[REPOSITORY_META_TITLE]=arguments[0]||"",e.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]||"",e.repository[REPOSITORY_META_KEYWORDS]=arguments[2]||"",e.repository[REPOSITORY_META_IMAGE]=arguments[3]||"",e},Controller.prototype.$dns=function(){for(var e="",t=this,r=arguments.length,n=0;r>n;n++)e+='<link rel="dns-prefetch" href="'+t._prepareHost(arguments[n]||"")+'" />';return t.head(e),""},Controller.prototype.$prefetch=function(){for(var e="",t=this,r=arguments.length,n=0;r>n;n++)e+='<link rel="prefetch" href="'+t._prepareHost(arguments[n]||"")+'" />';return t.head(e),""},Controller.prototype.$prerender=function(){for(var e="",t=this,r=arguments.length,n=0;r>n;n++)e+='<link rel="prerender" href="'+t._prepareHost(arguments[n]||"")+'" />';return t.head(e),""},Controller.prototype.$next=function(e){var t=this;return t.head('<link rel="next" href="'+t._prepareHost(e||"")+'" />'),""},Controller.prototype.$prev=function(e){var t=this;return t.head('<link rel="prev" href="'+t._prepareHost(e||"")+'" />'),""},Controller.prototype.$canonical=function(e){var t=this;return t.head('<link rel="canonical" href="'+t._prepareHost(e||"")+'" />'),""},Controller.prototype.$meta=function(){var e=this;if(0!==arguments.length)return e.meta.apply(e,arguments),"";framework.emit("controller-render-meta",e);var t=e.repository;return framework.onMeta.call(e,t[REPOSITORY_META_TITLE],t[REPOSITORY_META_DESCRIPTION],t[REPOSITORY_META_KEYWORDS],t[REPOSITORY_META_IMAGE])},Controller.prototype.title=function(e){var t=this;return t.$title(e),t},Controller.prototype.description=function(e){var t=this;return t.$description(e),t},Controller.prototype.keywords=function(e){var t=this;return t.$keywords(e),t},Controller.prototype.$title=function(e){var t=this;return e?(t.repository[REPOSITORY_META_TITLE]=e,""):t.repository[REPOSITORY_META_TITLE]||""},Controller.prototype.$description=function(e){var t=this;return e?(t.repository[REPOSITORY_META_DESCRIPTION]=e,""):t.repository[REPOSITORY_META_DESCRIPTION]||""},Controller.prototype.$keywords=function(e){var t=this;return e?(t.repository[REPOSITORY_META_KEYWORDS]=e,""):t.repository[REPOSITORY_META_KEYWORDS]||""},Controller.prototype.sitemap=function(e,t,r){var n=this;return void 0===e?n.repository.sitemap||[]:(void 0===t&&(t=n.req.url),void 0===n.repository.sitemap&&(n.repository.sitemap=[]),n.repository.sitemap.push({name:e,url:t,index:r||n.repository.sitemap.length}),void 0!==r&&n.sitemap.length>1&&n.repository.sitemap.sort(function(e,t){return e.index<t.index?-1:e.index>t.index?1:0}),n)},Controller.prototype.$sitemap=function(){var e=this;return e.sitemap.apply(e,arguments),""},Controller.prototype.module=function(e){return framework.module(e)},Controller.prototype.layout=function(e){var t=this;return t.layoutName=e,t},Controller.prototype.$layout=function(e){var t=this;return t.layoutName=e,""},Controller.prototype.model=function(e){return framework.model(e)},Controller.prototype.models=function(e){var t=this;return(t.controllers[e||t.name]||{}).models},Controller.prototype.mail=function(e,t,r,n,o,i){typeof n===TYPE_FUNCTION&&(o=n,n=null);var s=this,a=s.view(r,n,!0);return framework.onMail(e,t,a,o,i)},Controller.prototype.functions=function(e){var t=this;return(t.controllers[e||t.name]||{}).functions},Controller.prototype.notModified=function(e,t){var r=this;return framework.notModified(r.req,r.res,e,t)},Controller.prototype.setModified=function(e){var t=this;return framework.setModified(t.req,t.res,e),t},Controller.prototype.setExpires=function(e){var t=this;return void 0===e?t:(t.res.setHeader("Expires",e.toUTCString()),t)},Controller.prototype.$template=function(e,t,r,n){return this.$viewToggle(!0,e,t,r,n)},Controller.prototype.$templateToggle=function(e,t,r,n,o){return this.$viewToggle(e,t,r,n,o)},Controller.prototype.$view=function(e,t,r,n){return this.$viewToggle(!0,e,t,r,n)},Controller.prototype.$viewToggle=function(e,t,r,n,o){if(!e)return"";var i,s=this;if(n){i="$view."+t+"."+(o||"");var a=s.cache.read(i);if(a)return a}var u=s.layoutName;s.layoutName="";var c=s.view(t,r,null,!0);return s.layoutName=u,null===c?"":(n&&s.cache.add(i,c,n),c)},Controller.prototype.place=function(e){var t=this,r=REPOSITORY_PLACE+"_"+e,n=arguments.length;if(1===n)return t.repository[r]||"";for(var o="",i=1;n>i;i++){var s=arguments[i];s=null===s||void 0===typeof s?"":s.toString(),o+=s}return t.repository[r]=(t.repository[r]||"")+o,t},Controller.prototype.section=function(e,t,r){var n=this,o="$section_"+e;return void 0===t?n.repository[o]:r?(n.repository[o]=t,n):(n.repository[o]?n.repository[o]+=t:n.repository[o]=t,n)},Controller.prototype.$place=function(){var e=this;return 1===arguments.length?e.place.apply(e,arguments):(e.place.apply(e,arguments),"")},Controller.prototype.$url=function(e){var t=this;return e?t.req.hostname(t.url):t.url},Controller.prototype.$helper=function(){var e=this;return e.helper.apply(e,arguments)},Controller.prototype.$checked=function(e,t,r){var n=this;return n.$isValue(e,t,r,'checked="checked"')},Controller.prototype.$disabled=function(e,t,r){var n=this;return n.$isValue(e,t,r,'disabled="disabled"')},Controller.prototype.$selected=function(e,t,r){var n=this;return n.$isValue(e,t,r,'selected="selected"')},Controller.prototype.$set=function(){return""},Controller.prototype.$readonly=function(e,t,r){var n=this;return n.$isValue(e,t,r,'readonly="readonly"')},Controller.prototype.$header=function(e,t){return this.header(e,t),""},Controller.prototype.$text=function(e,t,r){return this.$input(e,"text",t,r)},Controller.prototype.$password=function(e,t,r){return this.$input(e,"password",t,r)},Controller.prototype.$hidden=function(e,t,r){return this.$input(e,"hidden",t,r)},Controller.prototype.$radio=function(e,t,r,n){return typeof n===STRING&&(n={label:n}),n.value=r,this.$input(e,"radio",t,n)},Controller.prototype.$checkbox=function(e,t,r){return typeof r===STRING&&(r={label:r}),this.$input(e,"checkbox",t,r)},Controller.prototype.$textarea=function(e,t,r){var n="<textarea";typeof r!==OBJECT&&(r={}),n+=' name="'+t+'" id="'+(r.id||t)+ATTR_END;for(var o in r)switch(o){case"name":case"id":break;case"required":case"disabled":case"readonly":case"value":n+=" "+o+'="'+o+ATTR_END;break;default:n+=" "+o+'="'+r[o].toString().encode()+ATTR_END}if(void 0===e)return n+"></textarea>";var i=e[t]||r.value||"";return n+">"+i.toString().encode()+"</textarea>"},Controller.prototype.$input=function(e,t,r,n){var o=["<input"];typeof n!==OBJECT&&(n={});var i=n.value||"";o+=' type="'+t+ATTR_END,o+="radio"===t?' name="'+r+ATTR_END:' name="'+r+'" id="'+(n.id||r)+ATTR_END,n.autocomplete&&(o+=n.autocomplete===!0||"on"===n.autocomplete?' autocomplete="on"':' autocomplete="off"');for(var s in n)switch(s){case"name":case"id":case"type":case"autocomplete":case"checked":case"value":case"label":break;case"required":case"disabled":case"readonly":case"autofocus":o+=" "+s+'="'+s+ATTR_END;break;default:o+=" "+s+'="'+n[s].toString().encode()+ATTR_END}var a="";return void 0!==e&&(a=e[r],"checkbox"===t&&(("1"===a||"true"===a||a===!0)&&(o+=' checked="checked"'),a=i||"1"),"radio"===t&&(i=(i||"").toString(),a.toString()===i&&(o+=' checked="checked"'),a=i||"")),o+=void 0!==a?' value="'+(a||"").toString().encode()+ATTR_END:' value="'+(n.value||"").toString().encode()+ATTR_END,o+=" />",n.label?"<label>"+o+" <span>"+n.label+"</span></label>":o},Controller.prototype._prepareHost=function(e){var t=e.substring(0,5);return"http:"!==t&&"https://"!==t&&("/"!==t[0]||"/"!==t[1])&&(e=this.host(e)),e},Controller.prototype.head=function(){var e=this,t=arguments.length;if(0===t)return framework.emit("controller-render-head",e),(e.config.author?'<meta name="author" content="'+e.config.author+'" />':"")+(e.repository[REPOSITORY_HEAD]||"");for(var r=e.repository[REPOSITORY_HEAD]||"",n="",o=0;t>o;o++){var i=arguments[o];if(-1===i.indexOf("<")){var s=i.substring(0,7),a="/"!==s[0]&&"/"!==s[1]&&"http://"!==s&&"https:/"!==s;i.endsWith(".css",!0)?n+='<link type="text/css" rel="stylesheet" href="'+(a?e.routeStyle(i):i)+'" />':-1!==i.endsWith(EXTENSION_JS,!0)&&(n+='<script type="text/javascript" src="'+(a?e.routeScript(i):i)+'"></script>')}else n+=i}return r+=n,e.repository[REPOSITORY_HEAD]=r,e},Controller.prototype.$head=function(){var e=this;return e.head.apply(e,arguments),""},Controller.prototype.$isValue=function(e,t,r,n){return e?(t=t||" ",r=r||"",t+n+r):""},Controller.prototype.$modified=function(e){var t,r=this,n=typeof e;if(n===NUMBER)t=new Date(e);else if(n===STRING){var o=e.split(" ");t=o[0].split("-");var i=(o[1]||"").split(":"),s=utils.parseInt(t[0]||""),a=utils.parseInt(t[1]||"")-1,u=utils.parseInt(t[2]||"")-1;0>a&&(a=0),0>u&&(u=0);var c=utils.parseInt(i[0]||""),l=utils.parseInt(i[1]||""),p=utils.parseInt(i[2]||"");t=new Date(s,a,u,c,l,p,0)}else utils.isDate(e)&&(t=e);return void 0===t?"":(r.setModified(t),"")},Controller.prototype.$etag=function(e){return this.setModified(e),""},Controller.prototype.$options=function(e,t,r,n){var o=typeof e;if(null===e||void 0===e)return"";var i=!1,s=null;e instanceof Array||o!==OBJECT||(i=!0,s=e,e=Object.keys(e)),utils.isArray(e)||(e=[e]),t=t||"";var a="";i||(void 0===n&&(n=n||r||"value"),void 0===r&&(r=r||"name"));var u=!1,c=0;c=e.length;for(var l=0;c>l;l++){var p=e[l],o=typeof p,f="",d="",m=!1;i?r===!0?(d=s[p],f=p,null===n&&(n="")):(d=p,f=s[p],null===f&&(f="")):o===OBJECT?(f=p[r]||"",d=p[n]||"",typeof f===TYPE_FUNCTION&&(f=f(l)),typeof d===TYPE_FUNCTION&&(d=d(l,f))):(f=p,d=p),u||(m=d==t,u=m),a+='<option value="'+d.toString().encode()+'"'+(m?' selected="selected"':"")+">"+f.toString().encode()+"</option>"}return a},Controller.prototype.$script=function(){var e=this;return e.$js.apply(e,arguments)},Controller.prototype.$js=function(){for(var e=this,t="",r=0;r<arguments.length;r++)t+=e.routeScript(arguments[r],!0);return t},Controller.prototype.$import=function(){for(var e=this,t="",r=0;r<arguments.length;r++){var n=arguments[r],o=n.substring(n.lastIndexOf("."));switch(o){case".js":t+=e.routeScript(n,!0);break;case".css":t+=e.routeStyle(n,!0);break;case".ico":t+=e.$favicon(n);break;case".jpg":case".gif":case".png":case".jpeg":t+=e.routeImage(n,!0)}}return t},Controller.prototype.$css=function(){for(var e=this,t="",r=0;r<arguments.length;r++)t+=e.routeStyle(arguments[r],!0);return t},Controller.prototype.$image=function(e,t,r,n,o){var i="";typeof t===OBJECT&&(r=t.height,n=t.alt,o=t["class"],i=t.style,t=t.width);var s='<img src="'+this.routeImage(e)+ATTR_END;return t>0&&(s+=' width="'+t+ATTR_END),r>0&&(s+=' height="'+r+ATTR_END),n&&(s+=' alt="'+n.encode()+ATTR_END),o&&(s+=' class="'+o+ATTR_END),i&&(s+=' style="'+i+ATTR_END),s+' border="0" />'},Controller.prototype.$download=function(e,t,r,n){var o='<a href="'+framework.routeDownload(e)+ATTR_END;return r&&(o+=' download="'+r+ATTR_END),n&&(o+=' class="'+n+ATTR_END),o+">"+(t||e)+"</a>"},Controller.prototype.$json=function(e,t,r){if(typeof t===BOOLEAN){var n=t;t=r,r=n}var o=r?JSON.stringify(e,null,4):JSON.stringify(e);return t?'<script type="application/json" id="'+t+'">'+o+"</script>":o},Controller.prototype.$favicon=function(e){var t="image/x-icon";void 0===e&&(e="favicon.ico");var r="favicon#"+e;return framework.temporary.other[r]?framework.temporary.other[r]:(-1!==e.lastIndexOf(".png")?t="image/png":-1!==e.lastIndexOf(".gif")&&(t="image/gif"),e=framework.routeStatic("/"+e),framework.temporary.other[r]='<link rel="shortcut icon" href="'+e+'" type="'+t+'" />')},Controller.prototype._routeHelper=function(e,t,r){return e?"//"===e.substring(0,2)||"http:/"===e.substring(0,6)||"https:/"===e.substring(0,7)?r.call(framework,e+t):"~"===e[0]?r.call(framework,utils.path(e.substring(1))+t):r.call(framework,utils.path(e)+t):r.call(framework,t)},Controller.prototype.routeJS=function(e,t){return console.log("OBSOLETE controller.routeJS(): use controller.routeScript()"),this.routeScript(e,t)},Controller.prototype.routeScript=function(e,t){var r=this;void 0===e&&(e="default.js");var n=r._routeHelper(r._currentScript,e,framework.routeScript);return t?'<script type="text/javascript" src="'+n+'"></script>':n},Controller.prototype.routeCSS=function(e,t){return console.log("OBSOLETE controller.routeCSS(): use controller.routeStyle()"),this.routeStyle(e,t)},Controller.prototype.routeStyle=function(e,t){var r=this;void 0===e&&(e="default.css");var n=r._routeHelper(r._currentStyle,e,framework.routeStyle);return t?'<link type="text/css" rel="stylesheet" href="'+n+'" />':n},Controller.prototype.routeImage=function(e){var t=this;return t._routeHelper(t._currentImage,e,framework.routeImage)},Controller.prototype.routeVideo=function(e){var t=this;return t._routeHelper(t._currentVideo,e,framework.routeVideo)},Controller.prototype.routeFont=function(e){return framework.routeFont(e)},Controller.prototype.routeDownload=function(e){var t=this;return t._routeHelper(t._currentDownload,e,framework.routeDownload)},Controller.prototype.routeStatic=function(e){return framework.routeStatic(e)},Controller.prototype.$currentJS=function(e){return this.$currentScript(e)},Controller.prototype.$currentScript=function(e){return this._currentScript=e?e:"",""},Controller.prototype.$currentView=function(e){var t=this;return void 0===e?(t._currentView="#"!==t.name[0]&&"default"!==t.name?"/"+t.name+"/":"",t):(t._currentView=e?utils.path(e):"","")},Controller.prototype.currentView=function(e){var t=this;return t.$currentView(e),t._defaultView=t._currentView,t},Controller.prototype.$currentCSS=function(e){return this.$currentStyle(e)},Controller.prototype.$currentStyle=function(e){return this._currentStyle=e?e:"",""},Controller.prototype.$currentImage=function(e){return this._currentImage=e?e:"",""},Controller.prototype.$currentVideo=function(e){return this._currentVideo=e?e:"",""},Controller.prototype.$currentDownload=function(e){return this._currentDownload=e?e:"",""},Controller.prototype.currentImage=function(e){var t=this;return t.$currentImage(e),t._defaultImage=t._currentImage,t},Controller.prototype.currentDownload=function(e){var t=this;return t.$currentDownload(e),t._defaultDownload=t._currentDownload,t},Controller.prototype.currentCSS=function(e){return this.currentStyle(e)},Controller.prototype.currentStyle=function(e){var t=this;return t.$currentStyle(e),t._defaultStyle=t._currentStyle,t},Controller.prototype.currentJS=function(e){return this.currentScript(e)},Controller.prototype.currentScript=function(e){var t=this;return t.$currentScript(e),t._defaultScript=t._currentScript,t},Controller.prototype.currentVideo=function(e){var t=this;return t.$currentVideo(e),t._defaultVideo=t._currentVideo,t},Controller.prototype.resource=function(e,t){return framework.resource(e,t)},Controller.prototype.template=function(e,t){return this.view(e,t,!0)},Controller.prototype.helper=function(e){var t=this,r=framework.helpers[e]||null;if(null===r)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return r.apply(t,o)},Controller.prototype.json=function(e,t,r,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?o:"HEAD"===o.req.method?(o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,"","application/json",o.config["allow-gzip"],t),framework.stats.response.json++,o):(typeof t===BOOLEAN&&(n=r,r=t),e instanceof builders.ErrorBuilder?(o.language&&!e.isResourceCustom&&e.resource(o.language),e=e.json(r)):e=r?JSON.stringify(e,n,4):JSON.stringify(e,n),o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,e,"application/json",o.config["allow-gzip"],t),framework.stats.response.json++,o.precache&&o.precache(e,"application/json",t),o)},Controller.prototype.jsonp=function(e,t,r,n,o){var i=this;return i.res.success||i.res.headersSent||!i.isConnected?i:"HEAD"===i.req.method?(i.subscribe.success(),framework.responseContent(i.req,i.res,i.status,"","application/x-javascript",i.config["allow-gzip"],r),framework.stats.response.json++,i):(typeof r===BOOLEAN&&(o=n,n=r),e||(e="callback"),t instanceof builders.ErrorBuilder?(i.language&&!t.isResourceCustom&&t.resource(i.language),t=t.json(n)):t=n?JSON.stringify(t,o,4):JSON.stringify(t,o),i.subscribe.success(),framework.responseContent(i.req,i.res,i.status,e+"("+t+")","application/x-javascript",i.config["allow-gzip"],r),framework.stats.response.json++,i.precache&&i.precache(e+"("+t+")","application/x-javascript",r),i)},Controller.prototype.callback=function(e){var t=this;return function(r,n){return void 0!==n||util.isError(r)||r instanceof Builders.ErrorBuilder||(n=r,r=null),r?r instanceof Builders.ErrorBuilder&&!e?(t.language&&r.resource(t.language),t.json(r)):t.view500(r):typeof e===STRING?t.view(e,n):void t.json(n)}},Controller.prototype.custom=function(){var e=this;return e.subscribe.success(),e.res.success||e.res.headersSent||!e.isConnected?!1:(framework.responseCustom(e.req,e.res),!0)},Controller.prototype.noClear=function(e){var t=this;return t.req._manual=void 0===e?!0:e,t},Controller.prototype.content=function(e,t,r){var n=this;return n.res.success||n.res.headersSent||!n.isConnected?n:(n.subscribe.success(),framework.responseContent(n.req,n.res,n.status,e,t||CONTENTTYPE_TEXTPLAIN,n.config["allow-gzip"],r),n)},Controller.prototype.plain=function(e,t){var r=this;if(r.res.success||r.res.headersSent||!r.isConnected)return r;if("HEAD"===r.req.method)return r.subscribe.success(),framework.responseContent(r.req,r.res,r.status,"",CONTENTTYPE_TEXTPLAIN,r.config["allow-gzip"],t),framework.stats.response.plain++,r;var n=typeof e;return e=void 0===e?"":n===OBJECT?null===e?"":JSON.stringify(e,null,4):null===e?"":e.toString(),r.subscribe.success(),framework.responseContent(r.req,r.res,r.status,e,CONTENTTYPE_TEXTPLAIN,r.config["allow-gzip"],t),framework.stats.response.plain++,r.precache&&r.precache(e,CONTENTTYPE_TEXTPLAIN,t),r
},Controller.prototype.empty=function(e){var t=this;if(t.res.success||t.res.headersSent||!t.isConnected)return t;var r=200;return typeof e===NUMBER&&(r=e,e=null),t.subscribe.success(),framework.responseContent(t.req,t.res,r,"",CONTENTTYPE_TEXTPLAIN,!1,e),framework.stats.response.empty++,t},Controller.prototype.destroy=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.subscribe.success(),t.req.connection.destroy(),framework.stats.response.destroy++,t)},Controller.prototype.file=function(e,t,r,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?(n&&n(),o):(e="~"===e[0]?"."+e.substring(1):framework.path["public"](e),o.subscribe.success(),framework.responseFile(o.req,o.res,e,t,r,n),o)},Controller.prototype.image=function(e,t,r,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?(n&&n(),o):(typeof e===STRING&&(e="~"===e[0]?"."+e.substring(1):framework.path["public"](e)),o.subscribe.success(),framework.responseImage(o.req,o.res,e,t,r,n),o)},Controller.prototype.stream=function(e,t,r,n,o,i){var s=this;return s.res.success||s.res.headersSent||!s.isConnected?(o&&o(),s):(s.subscribe.success(),framework.responseStream(s.req,s.res,e,t,r,n,o,i),s)},Controller.prototype.throw400=function(e){return this.view400(e)},Controller.prototype.view400=function(e){var t=this;return e&&!e.items&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.path=new Array(0),t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#400"),t.subscribe.exception=e,t.subscribe.execute(400),t)},Controller.prototype.throw401=function(e){return this.view401(e)},Controller.prototype.view401=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.path=new Array(0),t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#401"),t.subscribe.exception=e,t.subscribe.execute(401),t)},Controller.prototype.throw403=function(e){return this.view403(e)},Controller.prototype.view403=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.path=new Array(0),t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#403"),t.subscribe.exception=e,t.subscribe.execute(403),t)},Controller.prototype.throw404=function(e){return this.view404(e)},Controller.prototype.view404=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.path=new Array(0),t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#404"),t.subscribe.exception=e,t.subscribe.execute(404),t)},Controller.prototype.view500=function(e){var t=this;return framework.error(typeof e===STRING?new Error(e):e,t.name,t.req.uri),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.path=new Array(0),t.subscribe.exception=e,t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#500"),t.subscribe.exception=e,t.subscribe.execute(500),t)},Controller.prototype.throw500=function(e){return this.view500(e)},Controller.prototype.view501=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.req.path=new Array(0),t.subscribe.success(),t.subscribe.route=framework.lookup(t.req,"#501"),t.subscribe.exception=e,t.subscribe.execute(501),t)},Controller.prototype.throw501=function(e){return this.view501(e)},Controller.prototype.redirect=function(e,t){var r=this;return r.res.success||r.res.headersSent||!r.isConnected?r:(r.subscribe.success(),r.req.clear(!0),r.res.success=!0,r.res.writeHead(t?301:302,{Location:e}),r.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",r.req,r.res),framework.stats.response.redirect++,r)},Controller.prototype.binary=function(e,t,r,n,o){var i=this,s=i.res;if(i.res.success||i.res.headersSent||!i.isConnected)return i;if(typeof r===OBJECT){var a=r;r=n,n=o,o=a}return typeof n===OBJECT&&(o=n,n=o),i.subscribe.success(),framework.responseBinary(i.req,s,t,e,r,n,o),i},Controller.prototype.baa=function(e){var t=this;return void 0===e?t.req.authorization():(framework.responseContent(t.req,t.res,401,"401: NOT AUTHORIZED",CONTENTTYPE_TEXTPLAIN,!1,{"WWW-Authenticate":'Basic realm="'+(e||"Administration")+'"'}),t.subscribe.success(),t.cancel(),null)},Controller.prototype.sse=function(e,t,r,n){var o=this,i=o.res;if(!o.isConnected)return o;if(0===o.type&&i.success)throw new Error("Response was sent.");if(o.type>0&&1!==o.type)throw new Error("Response was used.");if(0===o.type){o.type=1,void 0===n&&(n=o.subscribe.route.timeout),o.subscribe.success(),o.req.on("close",o.close.bind(o)),i.success=!0;var s={Pragma:"no-cache"};s[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, max-age=0, must-revalidate",s[RESPONSE_HEADER_CONTENTTYPE]="text/event-stream",i.writeHead(o.status,s)}e=typeof e===OBJECT?JSON.stringify(e):e.replace(/\n/g,"\\n").replace(/\r/g,"\\r");var a="\n",u="";return t&&(u="event: "+t+a),u+="data: "+e+a,r&&r.toString()&&(u+="id: "+r+a),n&&n>0&&(u+="retry: "+n+a),u+=a,i.write(u),framework.stats.response.sse++,o},Controller.prototype.close=function(e){var t=this;return void 0===e&&(e=!0),t.isConnected?0===t.type?(t.isConnected=!1,t.res.success||(t.res.success=!0,e&&t.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",t.req,t.res)),t):(t.isConnected=!1,t.res.success=!0,e&&t.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",t.req,t.res),t.type=0,t):t},Controller.prototype.proxy=function(e,t,r,n){var o,i=this,s={"X-Proxy":"total.js"};return typeof r===NUMBER&&(o=n,n=r,r=o),typeof t===TYPE_FUNCTION&&(o=r,r=t,t=o),utils.request(e,REQUEST_PROXY_FLAGS,t,function(e,t,n,o){r&&(-1!==(o["content-type"]||"").indexOf("application/json")&&(t=JSON.parse(t)),r.call(i,e,t,n,o))},null,s,ENCODING,n||1e4)},Controller.prototype.database=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},Controller.prototype.view=function(e,t,r,n){var o=this;if(typeof e!==STRING?(n=r,r=t,t=e,e=o.viewname):void 0===n&&typeof r===BOOLEAN&&(n=r,r=null),!n&&o.res&&o.res.success)return o;var i=e[0],s="/"===i?1:"~"===i?2:"@"===i?3:0,a=e,u=o.isLayout;o.isLayout=!1,o.isLayout||0!==s||(a=o._currentView+e),(2===s||3===s)&&(a=e.substring(1)),3===s&&(a="."+framework.path["package"](a));var c=framework_internal.generateView(e,a,o.language);if(null===c){var l=new Error('View "'+a+'" not found.');return n?(framework.error(l,o.name,o.uri),o.outputPartial):u?(o.subscribe.success(),void framework.response500(o.req,o.res,l)):void o.view500(l)}var p="";o.$model=t,u&&(o._currentStyle=o._defaultStyle||"",o._currentScript=o._defaultScript||"",o._currentDownload=o._defaultDownload||"",o._currentVideo=o._defaultVideo||"",o._currentImage=o._defaultImage||"",o._currentView=o._defaultView||"");var f=framework.helpers;try{p=c.call(o,o,o.repository,t,o.session,o.query,o.body,o.url,framework.global,f,o.user,o.config,framework.functions,0,n?o.outputPartial:o.output,o.date,o.req.cookie,o.req.files,o.req.mobile)}catch(d){var l=new Error("View: "+e+" - "+d.toString());return n?(o.error(l),o.isPartial?o.outputPartial="":o.output="",u=!1,p):void o.view500(l)}if(u||!o.precache||200!==o.status||n||o.precache(p,CONTENTTYPE_TEXTHTML,r,!0),u||utils.isNullOrEmpty(o.layoutName)){if(o.outputPartial="",o.output="",u=!1,n)return p;if(o.subscribe.success(),!o.isConnected)return;return framework.responseContent(o.req,o.res,o.status,p,CONTENTTYPE_TEXTHTML,o.config["allow-gzip"],r),framework.stats.response.view++,o}return n?o.outputPartial=p:o.output=p,o.isLayout=!0,p=o.view(o.layoutName,o.$model,r,n),n?(o.outputPartial="",o.isLayout=!1,p):o},Controller.prototype.memorize=function(e,t,r,n,o){var i=this,s=i.cache.read(e);if(null===s)return r===!0?(n(),i):(i.precache=function(r,n,o,s){var a={content:r,type:n};if(o&&(a.headers=o),s){a.repository=[];for(var u in i.repository)if("$"===u[0]||"sitemap"===u){var r=i.repository[u];void 0!==r&&a.repository.push({key:u,value:r})}}i.cache.add(e,a,t),i.precache=null},typeof r===TYPE_FUNCTION&&(n=r),n(),i);if(typeof r===TYPE_FUNCTION){var a=n;n=r,o=a}if(o&&o(),s.type!==CONTENTTYPE_TEXTHTML)return i.subscribe.success(),void framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers);switch(s.type){case CONTENTTYPE_TEXTPLAIN:return framework.stats.response.plain++,i;case"application/json":return framework.stats.response.json++,i;case CONTENTTYPE_TEXTHTML:framework.stats.response.view++}for(var u=s.repository.length,c=0;u>c;c++)i.repository[s.repository[c].key]=s.repository[c].value;return i.layoutName?(i.output=s.content,i.isLayout=!0,i.view(i.layoutName,null),i):(i.subscribe.success(),i.isConnected?(framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers),i):i)};var NEWLINE="\r\n",SOCKET_RESPONSE="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nX-Powered-By: {0}\r\nSec-WebSocket-Accept: {1}\r\n\r\n",SOCKET_RESPONSE_ERROR="HTTP/1.1 403 Forbidden\r\nConnection: close\r\nX-WebSocket-Reject-Reason: 403 Forbidden\r\n\r\n",SOCKET_HASH="258EAFA5-E914-47DA-95CA-C5AB0DC85B11",SOCKET_ALLOW_VERSION=[13];WebSocket.prototype={get global(){return framework.global},get config(){return framework.config},get cache(){return framework.cache},get isDebug(){return framework.config.debug},get path(){return framework.path},get fs(){return framework.fs},get isSecure(){return this.req.isSecure},get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async}},WebSocket.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocket,enumberable:!1}}),WebSocket.prototype.date=function(e,t,r){void 0===r&&(r=t,t=new Date);var n=typeof t===STRING?t.parseDate():t,o=typeof r===STRING?r.parseDate():r,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},WebSocket.prototype.send=function(e,t,r){var n=this,o=n._keys,i=o.length;if(0===i)return n;var s=typeof r===TYPE_FUNCTION?r:null,a=r instanceof Array;if(void 0===t||null===t||!t.length){for(var u=0;i>u;u++){var c=o[u];if(!a||-1===r.indexOf(c)){var l=n.connections[c];(null===s||s.call(n,c,l))&&(l.send(e),framework.stats.response.websocket++)}}return n.emit("send",e,null,[]),n}s=typeof t===TYPE_FUNCTION?t:null,a=t instanceof Array;for(var u=0;i>u;u++){var c=o[u];if(!a||-1!==t.indexOf(c)){var l=n.connections[c];(null===s||-1!==!s.call(n,c,l))&&(l.send(e),framework.stats.response.websocket++)}}return n.emit("send",e,t,r),n},WebSocket.prototype.ping=function(){var e=this,t=e._keys,r=t.length;if(0===r)return e;e.$ping=!0,framework.stats.other.websocketPing++;for(var n=0;r>n;n++)e.connections[t[n]].ping();return e},WebSocket.prototype.close=function(e,t,r){var n=this,o=n._keys;if(typeof e===STRING&&(r=t,t=e,e=null),null===o)return n;var i=o.length;if(0===i)return n;if(void 0===e||null===e||!e.length){for(var s=0;i>s;s++){var a=o[s];n.connections[a].close(t,r),n._remove(a)}return n._refresh(),n}for(var u=e instanceof Array,c=typeof e===TYPE_FUNCTION?e:null,s=0;i>s;s++){var a=o[s];if(!u||-1!==e.indexOf(a)){var l=n.connections[a];(null===c||c.call(n,a,l))&&(l.close(t,r),n._remove(a))}}return n._refresh(),n},WebSocket.prototype.error=function(e){var t=this,r=framework.error(typeof e===STRING?new Error(e):e,t.name,t.path);return void 0===e?r:t},WebSocket.prototype.problem=function(e){var t=this;return framework.problem(e,t.name,t.uri),t},WebSocket.prototype.change=function(e){var t=this;return framework.change(e,t.name,t.uri,t.ip),t},WebSocket.prototype.all=function(e){for(var t=this,r=t._keys.length,n=0;r>n;n++){var o=t._keys[n];if(e(t.connections[o],n))break}return t},WebSocket.prototype.find=function(e){for(var t=this,r=t._keys.length,n=typeof e===TYPE_FUNCTION,o=0;r>o;o++){var i=t.connections[t._keys[o]];if(n){if(e(i,i.id))return i}else if(i.id===e)return i}return null},WebSocket.prototype.destroy=function(e){var t=this;return e&&t.problem(e),null===t.connections&&null===t._keys?t:(t.close(),t.connections=null,t._keys=null,delete framework.connections[t.id],t.removeAllListeners(),t.emit("destroy"),t)},WebSocket.prototype.proxy=function(e,t,r){var n=this,o={"X-Proxy":"total.js"};if(typeof t===TYPE_FUNCTION){var i=r;r=t,t=i}return utils.request(e,REQUEST_PROXY_FLAGS,t,function(e,t,o,i){r&&(-1!==(i["content-type"]||"").indexOf("application/json")&&(t=JSON.parse(t)),r.call(n,e,t,o,i))},o)},WebSocket.prototype._refresh=function(){var e=this;return e._keys=Object.keys(e.connections),e.online=e._keys.length,e},WebSocket.prototype._remove=function(e){var t=this;return delete t.connections[e],t},WebSocket.prototype._add=function(e){var t=this;return t.connections[e._id]=e,t},WebSocket.prototype.module=function(e){return framework.module(e)},WebSocket.prototype.model=function(e){return framework.model(e)},WebSocket.prototype.helper=function(e){var t=this,r=framework.helpers[e]||null;if(null===r)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return r.apply(t,o)},WebSocket.prototype.functions=function(e){return(framework.controllers[e]||{}).functions},WebSocket.prototype.database=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},WebSocket.prototype.resource=function(e,t){return framework.resource(e,t)},WebSocket.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},WebSocket.prototype.check=function(){var e=this;return e.$ping?(e.all(function(e){e.$ping||(e.close(),framework.stats.other.websocketCleaner++)}),e):e},WebSocket.prototype.logger=function(){var e=this;return framework.logger.apply(framework,arguments),e},WebSocket.prototype.validation=function(e,t,r,n){return this.validate(e,t,r,n)},WebSocket.prototype.validate=function(e,t,r,n){var o=this,i=function(e){return o.resource(n||"default",(r||"")+e)},s=new builders.ErrorBuilder(i);return utils.validate.call(o,e,t,framework.onValidation,s)},WebSocketClient.prototype={get protocol(){return(this.req.headers["sec-websocket-protocol"]||"").replace(/\s/g,"").split(",")},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e}},WebSocketClient.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocketClient,enumberable:!1}}),WebSocketClient.prototype.prepare=function(e,t,r,n,o){var i=this;e=e||[],t=t||[],r=r||[],i.length=n;var s=i.req.headers.origin||"";if(r.length){if(-1===r.indexOf("*"))for(var a=0;a<r.length;a++)if(-1===s.indexOf(r[a]))return!1}else if(-1===s.indexOf(i.req.headers.host))return!1;if(t.length)for(var a=0;a<t.length;a++)if(-1===i.protocol.indexOf(t[a]))return!1;return-1===SOCKET_ALLOW_VERSION.indexOf(utils.parseInt(i.req.headers["sec-websocket-version"]))?!1:(i.socket.write(new Buffer(SOCKET_RESPONSE.format("total.js v"+o,i._request_accept_key(i.req)),"binary")),i._id=(i.ip||"").replace(/\./g,"")+utils.GUID(20),i.id=i._id,!0)},WebSocketClient.prototype.upgrade=function(e){var t=this;return t.container=e,t.socket.on("data",t.handlers.ondata),t.socket.on("error",t.handlers.onerror),t.socket.on("close",t.handlers.onclose),t.socket.on("end",t.handlers.onclose),t.container._add(t),t.container._refresh(),framework.emit("websocket-begin",t.container,t),t.container.emit("open",t),t},WebSocketClient.prototype._ondata=function(e){var t=this;if(null!=e&&(t.buffer=Buffer.concat([t.buffer,e])),t.buffer.length>t.length)return t.errors++,void t.container.emit("error",new Error("Maximum request length exceeded."),t);switch(15&t.buffer[0]){case 1:1!==t.type&&t.parse();break;case 2:1===t.type&&t.parse();break;case 8:t.close();break;case 9:t.socket.write(utils.getWebSocketFrame(0,"",10)),t.buffer=new Buffer(0),t.$ping=!0;break;case 10:t.$ping=!0,t.buffer=new Buffer(0)}},WebSocketClient.prototype.parse=function(){var e=this,t=e.buffer[1];if((128&t)>>7!==1)return e;var r=utils.getMessageLength(e.buffer,framework.isLE),n=127&e.buffer[1];if(n=126==n?4:127==n?10:2,n+r+4>e.buffer.length)return e;var o=new Buffer(4);if(e.buffer.copy(o,0,n,n+4),1!==e.type){for(var i="",s=0;r>s;s++)i+=String.fromCharCode(e.buffer[n+4+s]^o[s%4]);if(3===e.type)try{e.container.emit("message",e,JSON.parse(e.container.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(i):i))}catch(a){e.errors++,e.container.emit("error",new Error("JSON parser: "+a.toString()),e)}else e.container.emit("message",e,e.container.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(i):i)}else{for(var u=new Buffer(r),s=0;r>s;s++)u.write(e.buffer[n+4+s]^o[s%4]);e.container.emit("message",e,u)}return e.buffer=e.buffer.slice(n+r+4,e.buffer.length),e.buffer.length>=2&&utils.getMessageLength(e.buffer,framework.isLE)&&e.parse(),e},WebSocketClient.prototype._onerror=function(e){var t=this;-1===e.stack.indexOf("ECONNRESET")&&-1===e.stack.indexOf("socket is closed")&&-1===e.stack.indexOf("EPIPE")&&t.container.emit("error",e,t)},WebSocketClient.prototype._onclose=function(){var e=this;e._isClosed||(e._isClosed=!0,e.container._remove(e._id),e.container._refresh(),e.container.emit("close",e),framework.emit("websocket-end",e.container,e))},WebSocketClient.prototype.send=function(e){var t=this;if(t.isClosed)return t;if(1!==t.type){var r=3===t.type?JSON.stringify(e):(e||"").toString();t.container.config["default-websocket-encodedecode"]===!0&&r&&(r=encodeURIComponent(r)),t.socket.write(utils.getWebSocketFrame(0,r,1))}else null!==e&&t.socket.write(utils.getWebSocketFrame(0,e,2));return t},WebSocketClient.prototype.ping=function(){var e=this;return e.isClosed?e:(e.socket.write(utils.getWebSocketFrame(0,"",9)),e.$ping=!1,e)},WebSocketClient.prototype.close=function(e,t){var r=this;return r.isClosed?r:(r.isClosed=!0,r.socket.end(utils.getWebSocketFrame(t||1e3,e||"",8)),r)},WebSocketClient.prototype._request_accept_key=function(e){var t=crypto.createHash("sha1");return t.update((e.headers["sec-websocket-key"]||"")+SOCKET_HASH),t.digest("base64")},Backup.prototype.restoreKey=function(e){var t=this,r=t.read;if(1===r.status)return void t.restoreValue(e);var n=-1,o=e;return 2===r.status?(o=r.key+o,n=o.indexOf(":")):n=o.indexOf(":"),-1===n?(r.key+=e,void(r.status=2)):(r.status=1,r.key=o.substring(0,n),void t.restoreValue(o.substring(n+1)))},Backup.prototype.restoreValue=function(e){var t=this,r=t.read;if(1!==r.status)return void t.restoreKey(e);var n=e.indexOf("\n");return-1===n?void(r.value+=e):(r.value+=e.substring(0,n),t.restoreFile(r.key.replace(/\s/g,""),r.value.replace(/\s/g,"")),r.status=0,r.value="",r.key="",void t.restoreKey(e.substring(n+1)))},Backup.prototype.restore=function(e,t,r,n){if(!fs.existsSync(e))return void(r&&r(new Error("Package not found."),t));var o=this;o.filter=n,o.cache={},o.createDirectory(t,!0);var i=fs.createReadStream(e);return o.path=t,i.on("data",function(e){o.restoreKey(e.toString("utf8"))}),r?(r.path=t,i.on("end",function(){o.callback(r),i=null}),void i.resume()):void i.resume()},Backup.prototype.callback=function(e){var t=this;return t.pending<=0?e(null,e.path):void setTimeout(function(){t.callback(e)},100)},Backup.prototype.restoreFile=function(e,t){var r=this;if("function"!=typeof r.filter||r.filter(e)){if("#"===t)return void r.createDirectory(e);var n=e,o=e.lastIndexOf("/");-1!==o&&(n=e.substring(0,o).trim(),n&&r.createDirectory(n));var i=new Buffer(t,"base64");r.pending++,zlib.gunzip(i,function(t,n){fs.writeFileSync(path.join(r.path,e),n),r.pending--,i=null})}},Backup.prototype.createDirectory=function(e,t){var r=this;if(!r.cache[e]){r.cache[e]=!0,"/"===e[0]&&(e=e.substring(1));var n=framework.isWindows;n?"\\"===e[e.length-1]&&(e=e.substring(0,e.length-1)):"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));var o=n?e.replace(/\//g,"\\").split("\\"):e.split("/"),i="";n&&-1!==o[0].indexOf(":")&&o.shift();for(var s=o.length,a=0;s>a;a++){var u=o[a];i+=n?(i?"\\":"")+u:(i?"/":"")+u;var c=path.join(r.path,i);t&&(c=(n?"\\":"/")+c),fs.existsSync(c)||fs.mkdirSync(c)}}},http.ServerResponse.prototype.cookie=function(e,t,r,n){var o=this;if(!o.headersSent&&!o.success){var i=[e+"="+encodeURIComponent(t)],s=typeof r;r&&!utils.isDate(r)&&s===OBJECT&&(n=r,r=n.expires||n.expire||null),s===STRING&&(r=r.parseDateExpiration()),n||(n={}),n.path=n.path||"/",r&&i.push("Expires="+r.toUTCString()),n.domain&&i.push("Domain="+n.domain),n.path&&i.push("Path="+n.path),n.secure&&i.push("Secure"),(n.httpOnly||n.httponly||n.HttpOnly)&&i.push("HttpOnly");var a=o.getHeader("set-cookie")||[];return a.push(i.join("; ")),o.setHeader("Set-Cookie",a),o}},http.ServerResponse.prototype.noCache=function(){var e=this;return e.removeHeader(RESPONSE_HEADER_CACHECONTROL),e.removeHeader("Etag"),e.removeHeader("Last-Modified"),e},http.ServerResponse.prototype.send=function(e,t,r){var n=this;if(n.headersSent)return n;n.controller&&n.controller.subscribe.success();var o=n,i=n.req,s=r,a="HEAD"===i.method;switch(void 0===t&&(t=e,e=200),typeof t){case STRING:s||(s="text/html");break;case NUMBER:s||(s="text/plain"),t=utils.httpStatus(t);break;case BOOLEAN:case OBJECT:s||(s="application/json"),a||(t instanceof builders.ErrorBuilder&&(t=obj.output()),t=JSON.stringify(t))}var u=i.headers["accept-encoding"]||"",c={};c[RESPONSE_HEADER_CACHECONTROL]="private",c.Vary="Accept-Encoding"+(i.$mobile?", User-Agent":""),"application/json"===s&&(c[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate"),/text|application/.test(s)&&(s+="; charset=utf-8"),c[RESPONSE_HEADER_CONTENTTYPE]=s,framework.responseCustom(i,o);var l=-1!==u.lastIndexOf("gzip");if(a)return l&&(c["Content-Encoding"]="gzip"),o.writeHead(200,c),o.end(),n;if(!l)return o.writeHead(e,c),o.end(t,ENCODING),n;var p=new Buffer(t);return zlib.gzip(p,function(r,n){return r?(o.writeHead(e,c),void o.end(t,ENCODING)):(c["Content-Encoding"]="gzip",o.writeHead(e,c),void o.end(n,ENCODING))}),n},http.ServerResponse.prototype.throw400=function(e){this.controller&&this.controller.subscribe.success(),framework.response400(this.req,this,e)},http.ServerResponse.prototype.throw401=function(e){this.controller&&this.controller.subscribe.success(),framework.response401(this.req,this,e)},http.ServerResponse.prototype.throw403=function(e){this.controller&&this.controller.subscribe.success(),framework.response403(this.req,this,e)},http.ServerResponse.prototype.throw404=function(e){this.controller&&this.controller.subscribe.success(),framework.response404(this.req,this,e)},http.ServerResponse.prototype.throw408=function(e){this.controller&&this.controller.subscribe.success(),framework.response408(this.req,this,e)},http.ServerResponse.prototype.throw431=function(e){this.controller&&this.controller.subscribe.success(),framework.response431(this.req,this,e)},http.ServerResponse.prototype.throw500=function(e){this.controller&&this.controller.subscribe.success(),framework.response500(this.req,this,e)},http.ServerResponse.prototype.throw501=function(e){this.controller&&this.controller.subscribe.success(),framework.response501(this.req,this,e)},http.ServerResponse.prototype["continue"]=function(e){var t=this;return t.headersSent?(e&&e(),t):(t.controller&&t.controller.subscribe.success(),framework.responseStatic(t.req,t,e),t)},http.ServerResponse.prototype.content=function(e,t,r,n,o){var i=this;return i.headersSent?i:(i.controller&&i.controller.subscribe.success(),framework.responseContent(i.req,i,e,t,r,n,o),i)},http.ServerResponse.prototype.redirect=function(e,t){var r=this;return r.headersSent?r:(r.controller&&r.controller.subscribe.success(),framework.responseRedirect(r.req,r,e,t),r)},http.ServerResponse.prototype.file=function(e,t,r,n){var o=this;return o.headersSent?(n&&n(),o):(o.controller&&o.controller.subscribe.success(),framework.responseFile(o.req,o,e,t,r,n),o)},http.ServerResponse.prototype.stream=function(e,t,r,n,o,i){var s=this;return s.headersSent?(o&&o(),s):(s.controller&&s.controller.subscribe.success(),framework.responseStream(s.req,s,e,t,r,n,o,i),s)},http.ServerResponse.prototype.image=function(e,t,r,n){var o=this;return o.headersSent?(n&&n(),o):(o.controller&&o.controller.subscribe.success(),framework.responseImage(o.req,o,e,t,r,n),o)},http.ServerResponse.prototype.json=function(e){var t=this;return t.send(200,e,"application/json")};var _tmp=http.IncomingMessage.prototype;http.IncomingMessage.prototype={get ip(){var e=this;if(e._ip)return e._ip;var t=e.headers["x-forwarded-for"];return e._ip=void 0!==t?t.split(",",1)[0]||e.connection.removiewddress:e.connection.remoteAddress,e._ip},get query(){var e=this;return e._dataGET?e._dataGET:(e._dataGET=qs.parse(e.uri.query),e._dataGET)},get subdomain(){var e=this;if(e._subdomain)return e._subdomain;var t=e.uri.host.toLowerCase().replace(/^www\./i,"").split(".");return e._subdomain=t.length>2?t.slice(0,t.length-2):null,e._subdomain},get host(){return this.headers.host},get isSecure(){return"https:"===this.uri.protocol||"wss:"===this.uri.protocol},get language(){return this.$language||(this.$language=(((this.headers["accept-language"]||"").split(";")[0]||"").split(",")[0]||"").toLowerCase()),this.$language},get mobile(){return void 0===this.$mobile&&(this.$mobile=REG_MOBILE.test(this.headers["user-agent"])),this.$mobile},set language(e){this.$language=e}},http.IncomingMessage.prototype.__proto__=_tmp,http.IncomingMessage.prototype.signature=function(e){var t=this;return framework.encrypt((t.headers["user-agent"]||"")+"#"+t.ip+"#"+t.url+"#"+(e||""),"request-signature",!1)},http.IncomingMessage.prototype.noCache=function(){var e=this;return delete e.headers["if-none-match"],delete e.headers["if-modified-since"],e},http.IncomingMessage.prototype.behaviour=function(e){if(!framework.behaviours)return!1;var t=this.url;this.isStaticFile||"/"===t[t.length-1]||(t+="/");var r=framework.behaviours["*"],n=!1;return void 0!==r&&(r=r[e],void 0!==r&&(n=r)),r=framework.behaviours[t],void 0===r?n:(r=r[e],void 0===r?n:r)},http.IncomingMessage.prototype.cookie=function(e){var t=this;if(void 0!==t.cookies)return $decodeURIComponent(t.cookies[e]||"");var r=t.headers.cookie;if(!r)return"";t.cookies={};for(var n=r.split(";"),o=n.length,i=0;o>i;i++){var s=n[i].trim().split("=");t.cookies[s.shift()]=s.join("=")}return $decodeURIComponent(t.cookies[e]||"")},http.IncomingMessage.prototype.authorization=function(){var e=this,t=e.headers.authorization||"",r={user:"",password:"",empty:!0};if(""===t)return r;var n=new Buffer(t.replace("Basic ","").trim(),"base64").toString(ENCODING).split(":");return r.user=n[0]||"",r.password=n[1]||"",r.empty=0===r.user.length||0===r.password.length,r},http.IncomingMessage.prototype.authorize=function(e){if(null===framework.onAuthorization)return e(null,null,!1),this;var t=this;return framework.onAuthorization(t,t.res,t.flags,function(r,n){typeof r!==BOOLEAN&&(n=r,r=!n),t.isAuthorized=r,e(null,n,r)}),this},http.IncomingMessage.prototype.clear=function(e){var t=this,r=t.files;if(!r)return t;if(e&&t._manual)return t;var n=r.length;if(0===n)return t;for(var o=[],i=0;n>i;i++)o.push(r[i].path);return framework.unlink(o),t.files=null,t},http.IncomingMessage.prototype.hostname=function(e){var t=this,r=t.uri;return e&&"/"!==e[0]&&(e="/"+e),r.protocol+"//"+r.hostname+(r.port&&80!==r.port?":"+r.port:"")+(e||"")};var framework=new Framework;global.framework=global.F=module.exports=framework,process.on("uncaughtException",function(e){return-1!==e.toString().indexOf("listen EADDRINUSE")?(typeof process.send===TYPE_FUNCTION&&process.send("eaddrinuse"),console.log("\nThe IP address and the PORT is already in use.\nYou must change the PORT's number or IP address.\n"),void process.exit("SIGTERM")):framework.isTest?void(framework.testContinue&&framework.testContinue(e)):void framework.error(e,"",null)}),process.on("SIGTERM",function(){framework.stop()}),process.on("SIGINT",function(){framework.stop()}),process.on("exit",function(){framework.stop()}),process.on("message",function(e,t){return typeof e!==STRING?void framework.emit("message",e,t):"debugging"===e?void Utils.wait(function(){return framework.isLoaded},function(){delete framework.isLoaded,framework.console(),framework.console=utils.noop},1e4,500):"reconnect"===e?void framework.reconnect():"reconfigure"===e?(framework._configure(),framework._configure_versions(),void framework.emit(e)):"reset"===e?void framework.cache.clear():"stop"===e||"exit"===e?void framework.stop():void framework.emit("message",e,t)});